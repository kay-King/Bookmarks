<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¹¦ç­¾ç®¡ç†å™¨</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #007bff;
            --secondary-color: #6c757d;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --background-color: #f4f6f8;
            --card-background: #ffffff;
            --text-color: #333;
            --border-radius: 10px;
            --box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            --transition: all 0.3s ease;
            --button-height: 30px;
            --card-height: 150px;
            --content-line-height: 20px;
            --card-padding: 8px;
            --content-margin: 4px;
            --card-width: 220px;
        }

        body {
            font-family: 'Roboto', sans-serif;
            margin: 0;
            padding: 20px;
            background: var(--background-color);
            color: var(--text-color);
            line-height: 1.5;
            letter-spacing: 0.5px;
            box-sizing: border-box;
            min-height: 100vh;
            padding-top: 70px;
        }

        #toolbar {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background: #fff;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            padding: 10px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 15px;
            z-index: 1000;
            box-sizing: border-box;
            height: 60px;
        }

        #title {
            font-size: 18px;
            font-weight: 700;
            color: #333;
            margin: 0;
            flex-shrink: 0;
        }

        #category-wrapper {
            position: fixed;
            top: 80px;
            left: 20px;
            width: 50px;
            z-index: 1000;
        }

        #category-btn {
            padding: 6px 10px;
            background: #fff;
            border: 1px solid var(--primary-color);
            border-radius: var(--border-radius);
            color: var(--primary-color);
            cursor: pointer;
            transition: var(--transition);
            width: 100%;
            text-align: center;
            font-size: 12px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            z-index: 1001;
        }

        #category-btn:hover {
            background: var(--primary-color);
            color: white;
        }

        #sidebar {
            position: absolute;
            top: 40px;
            left: 0;
            width: 120px;
            background: var(--card-background);
            padding: 10px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            display: none;
            overflow-y: auto;
            font-size: 12px;
            z-index: 999;
        }

        #sidebar::-webkit-scrollbar {
            width: 4px;
        }

        #sidebar::-webkit-scrollbar-thumb {
            background: #ccc;
            border-radius: 4px;
        }

        #sidebar::-webkit-scrollbar-track {
            background: var(--background-color);
        }

        #sidebar h2 {
            margin: 0 0 10px;
            font-size: 14px;
            color: var(--text-color);
        }

        .category-item {
            padding: 8px 12px;
            margin: 5px 0;
            background: #e9ecef;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .category-item:hover {
            background: #d1d5db;
        }

        .category-item.active {
            background: var(--primary-color);
            color: white;
        }

        #container {
            max-width: 1100px;
            margin: 0 auto;
            transition: margin-left 0.3s ease;
            margin-left: 90px;
            box-sizing: border-box;
        }

        #stats {
            max-width: 1100px;
            margin: 20px auto 20px;
            margin-left: 90px;
            padding: 15px;
            background: #fff;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            font-size: 14px;
            color: var(--text-color);
            text-align: center;
            transition: margin-left 0.3s ease;
        }

        #tips {
            max-width: 1100px;
            margin: 0 auto 20px;
            margin-left: 90px;
            padding: 15px 10px;
            border-left: 4px solid #ffca28;
            background: #fff8e1;
            border-radius: var(--border-radius);
            font-size: 14px;
            color: #856404;
            line-height: 1.6;
            display: block;
            transition: margin-left 0.3s ease;
        }

        #controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
            flex-grow: 1;
            justify-content: flex-end;
        }

        button {
            padding: 5px 10px;
            border: 1px solid var(--primary-color);
            border-radius: var(--border-radius);
            background: #fff;
            color: var(--primary-color);
            font-size: 12px;
            cursor: pointer;
            transition: var(--transition);
            height: var(--button-height);
            display: flex;
            align-items: center;
            gap: 5px;
            box-sizing: border-box;
        }

        button:hover {
            background: var(--primary-color);
            color: white;
        }

        button:active {
            transform: scale(0.98);
        }

        .delete-btn {
            border-color: var(--danger-color);
            color: var(--danger-color);
        }

        .delete-btn:hover {
            background: var(--danger-color);
            color: white;
        }

        .batch-delete-btn {
            border-color: var(--danger-color);
            color: var(--danger-color);
        }

        .batch-delete-btn:hover {
            background: var(--danger-color);
            color: white;
        }

        #undo-btn {
            border-color: var(--success-color);
            color: var(--success-color);
        }

        #undo-btn:hover {
            background: var(--success-color);
            color: white;
        }

        #search {
            width: 200px;
            padding: 8px;
            border: 1px solid #ced4da;
            border-radius: var(--border-radius);
            font-size: 12px;
            transition: var(--transition);
            box-sizing: border-box;
        }

        #search:focus {
            border-color: var(--primary-color);
            outline: none;
        }

        #add-form, #view-modal, #view-bookmark-modal, #help-modal, #export-modal, #message-form {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--card-background);
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 1000;
            width: 400px;
            box-sizing: border-box;
        }

        #message-form {
            width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            padding: 25px;
            background: linear-gradient(135deg, #ffffff, #f9f9f9);
        }

        #message-form h3 {
            margin: 0 0 20px;
            font-size: 20px;
            color: var(--primary-color);
            text-align: center;
            font-weight: 500;
        }

        #message-form .form-group {
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        #message-form label {
            font-weight: 500;
            color: var(--text-color);
            font-size: 16px;
        }

        #message-form textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            min-height: 150px;
            background: #fffde7;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
            transition: border-color 0.3s ease, background 0.3s ease;
        }

        #message-form textarea:not([readonly]) {
            background: #fff;
            border-color: var(--primary-color);
        }

        #message-form textarea:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 5px rgba(0,123,255,0.3);
            outline: none;
        }

        #message-form .form-buttons {
            display: flex;
            justify-content: space-between;
            gap: 15px;
        }

        #message-form button {
            flex: 1;
            padding: 10px;
            font-size: 14px;
            border-radius: 8px;
            height: 40px;
            transition: background-color 0.3s ease, transform 0.2s ease;
        }

        #message-form button:hover {
            transform: translateY(-2px);
        }

        #message-form #save-message-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            display: none;
        }

        #message-form #save-message-btn:hover {
            background: #0056b3;
        }

        #message-form #cancel-message-btn {
            background: #fff;
            color: var(--danger-color);
            border: 1px solid var(--danger-color);
            display: none;
        }

        #message-form #cancel-message-btn:hover {
            background: var(--danger-color);
            color: white;
        }

        #message-form #edit-message-btn {
            background: #fff;
            color: var(--primary-color);
            border: 1px solid var(--primary-color);
        }

        #message-form #edit-message-btn:hover {
            background: var(--primary-color);
            color: white;
        }

        #message-form #close-message-btn {
            background: #fff;
            color: var(--secondary-color);
            border: 1px solid var(--secondary-color);
        }

        #message-form #close-message-btn:hover {
            background: var(--secondary-color);
            color: white;
        }

        #help-modal {
            width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }

        #help-modal::-webkit-scrollbar {
            width: 4px;
        }

        #help-modal::-webkit-scrollbar-thumb {
            background: #ccc;
            border-radius: 4px;
        }

        #help-modal::-webkit-scrollbar-track {
            background: var(--background-color);
        }

        #help-modal h3 {
            margin: 0 0 15px;
            font-size: 18px;
            color: var(--text-color);
        }

        .form-group {
            margin-bottom: 15px;
            display: flex;
            flex-wrap: wrap;
            align-items: baseline;
            gap: 5px;
        }

        .form-group label {
            font-weight: 500;
            color: var(--text-color);
            margin-right: 5px;
            min-width: 50px;
        }

        .form-group p {
            margin: 0;
            flex: 1;
            word-break: break-word;
        }

        input, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: var(--border-radius);
            font-size: 14px;
            box-sizing: border-box;
            transition: var(--transition);
        }

        input:focus, textarea:focus {
            border-color: var(--primary-color);
            outline: none;
        }

        textarea {
            resize: vertical;
            min-height: 80px;
        }

        .form-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .bookmark-grid {
            display: grid;
            gap: 20px;
            justify-content: center;
            width: 100%;
            box-sizing: border-box;
        }

        .bookmark-card {
            background: var(--card-background);
            border: 1px solid #e5e7eb;
            padding: var(--card-padding);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            transition: transform 0.3s ease, opacity 0.3s ease, border 0.3s ease;
            cursor: move;
            height: var(--card-height);
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
        }

        .bookmark-card.edit-mode {
            cursor: default;
        }

        .bookmark-card:hover {
            transform: scale(1.02);
            box-shadow: 0 6px 12px rgba(0,0,0,0.1);
        }

        .bookmark-card h3 {
            margin: 0;
            margin-bottom: var(--content-margin);
            font-size: 16px;
            color: #000;
            height: var(--content-line-height);
            line-height: var(--content-line-height);
            position: relative;
            padding-right: 24px;
            display: flex;
            align-items: center;
        }

        .bookmark-card h3 span {
            display: block;
            max-width: calc(100% - 24px);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .bookmark-card h3 span.clickable {
            cursor: pointer;
        }

        .bookmark-card h3 span.clickable:hover {
            color: var(--primary-color);
            text-decoration: underline;
        }

        .bookmark-card p.url {
            margin: 0;
            margin-bottom: var(--content-margin);
            font-size: 14px;
            color: #000;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            height: var(--content-line-height);
            line-height: var(--content-line-height);
        }

        .bookmark-card .desc-container {
            height: calc(var(--content-line-height) * 2);
            margin-bottom: var(--content-margin);
        }

        .bookmark-card .desc {
            margin: 0;
            font-size: 14px;
            color: #000;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            height: calc(var(--content-line-height) * 2);
            line-height: var(--content-line-height);
        }

        .bookmark-card a {
            color: var(--primary-color);
            text-decoration: none;
            pointer-events: none;
        }

        .bookmark-card:hover a {
            pointer-events: auto;
        }

        .bookmark-card a:hover {
            text-decoration: underline;
        }

        .bookmark-card .category-container {
            height: var(--content-line-height);
            display: flex;
            align-items: center;
            margin-bottom: 0;
            margin-top: 6px;
        }

        .category-tag {
            padding: 4px 8px;
            background: #e9ecef;
            border-radius: 15px;
            font-size: 12px;
            color: var(--secondary-color);
            max-width: 60px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .bookmark-checkbox {
            width: 16px;
            height: 16px;
            position: absolute;
            top: 4px;
            right: 8px;
            display: none;
            z-index: 10;
            vertical-align: middle;
            padding: 10px;
            margin: -10px;
            cursor: pointer;
        }

        .bookmark-checkbox.visible {
            display: block;
        }

        .dragging {
            opacity: 0.6;
            border: 2px dashed var(--primary-color);
        }

        .drop-target {
            border: 2px dashed var(--primary-color);
            opacity: 0.8;
            background: #f0f8ff;
        }

        .action-buttons {
            display: flex;
            gap: 5px;
            justify-content: flex-end;
            align-items: center;
            height: var(--button-height);
            width: 100%;
            position: absolute;
            bottom: var(--card-padding);
            right: var(--card-padding);
        }

        .action-buttons button {
            padding: 6px 10px;
            min-width: 60px;
            font-size: 12px;
        }

        .bookmark-content {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
            padding-bottom: calc(var(--button-height) + var(--card-padding));
        }

        #view-modal button, #view-bookmark-modal button, #export-modal button, #help-modal button, #message-form button {
            margin: 10px 0;
            padding: 8px 12px;
            font-size: 12px;
            border-radius: var(--border-radius);
            background: #fff;
            color: var(--primary-color);
            border: 1px solid var(--primary-color);
        }

        #view-modal button {
            margin: 10px 0;
            padding: 8px 12px;
            font-size: 12px;
            border-radius: var(--border-radius);
            background: #fff;
            color: var(--primary-color);
            border: 1px solid var(--primary-color);
            transition: var(--transition);
        }

        #view-modal button:hover {
            background: var(--primary-color);
            color: white;
        }

        #view-modal button.view-selected {
            background-color: #0056b3;
            color: white;
            border: 1px solid #0056b3;
        }

        #view-modal button.view-selected:hover {
            background: #003d82;
            color: white;
        }

        #view-bookmark-modal button:hover, #export-modal button:hover, #help-modal button:hover {
            background: var(--primary-color);
            color: white;
        }

        #overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 999;
        }

        #pagination {
            max-width: 1100px;
            margin: 20px auto 0;
            margin-left: 90px;
            display: flex;
            justify-content: center;
            gap: 10px;
            padding: 10px;
            transition: margin-left 0.3s ease;
        }

        #pagination button {
            padding: 5px 12px;
            min-width: 30px;
            text-align: center;
        }

        #pagination button.active {
            background: var(--primary-color);
            color: white;
            border: 1px solid var(--primary-color);
        }

        #pagination button:disabled {
            border-color: #ced4da;
            color: #ced4da;
            cursor: not-allowed;
        }

        #pagination button:disabled:hover {
            background: #fff;
            color: #ced4da;
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
                padding-top: 100px;
            }
            #toolbar {
                flex-direction: column;
                align-items: flex-start;
                padding: 10px;
                height: auto;
            }
            #title {
                font-size: 16px;
                margin-bottom: 10px;
            }
            #controls {
                width: 100%;
                gap: 8px;
                justify-content: flex-start;
            }
            #category-wrapper {
                position: static;
                width: 100%;
                margin-bottom: 10px;
            }
            #category-btn {
                width: 100%;
                font-size: 14px;
                height: 40px;
            }
            #sidebar {
                position: static;
                width: 100%;
                max-height: 200px;
            }
            #container, #stats, #tips, #pagination {
                margin-left: 0;
                max-width: 100%;
                padding: 0;
            }
            #search {
                width: 100%;
                padding: 8px;
            }
            button {
                padding: 8px 12px;
                height: 40px;
                font-size: 12px;
            }
            .bookmark-grid {
                grid-template-columns: repeat(auto-fill, minmax(100%, 1fr));
                gap: 10px;
            }
            .bookmark-card {
                height: 180px;
                padding: 10px;
                width: 100%;
            }
            .bookmark-card h3 {
                font-size: 14px;
                height: 18px;
                line-height: 18px;
                padding-right: 20px;
            }
            .bookmark-checkbox {
                width: 14px;
                height: 14px;
                top: 4px;
                right: 6px;
                padding: 8px;
                margin: -8px;
            }
            .bookmark-card p.url {
                font-size: 12px;
                height: 18px;
                line-height: 18px;
            }
            .bookmark-card .desc-container {
                height: 36px;
            }
            .bookmark-card .desc {
                font-size: 12px;
                height: 36px;
                line-height: 18px;
            }
            .bookmark-card .category-container {
                height: 18px;
                margin-top: 4px;
            }
            .category-tag {
                font-size: 10px;
                padding: 3px 6px;
                max-width: 50px;
            }
            .action-buttons {
                height: 40px;
            }
            .action-buttons button {
                font-size: 12px;
                padding: 6px 10px;
                min-width: 50px;
            }
            .bookmark-content {
                padding-bottom: 48px;
            }
            #add-form, #view-modal, #view-bookmark-modal, #export-modal, #help-modal, #message-form {
                width: 90%;
                padding: 15px;
            }
            #message-form {
                width: 95%;
                padding: 20px;
            }
            #message-form h3 {
                font-size: 18px;
            }
            #message-form textarea {
                min-height: 120px;
            }
            #message-form button {
                height: 36px;
                font-size: 12px;
            }
            #help-modal {
                width: 90%;
            }
            #stats {
                font-size: 12px;
                padding: 10px;
                margin: 10px auto;
            }
            #tips {
                font-size: 12px;
                padding: 10px;
                margin-bottom: 10px;
            }
        }

        @media (max-width: 480px) {
            #toolbar {
                padding: 5px;
            }
            #title {
                font-size: 14px;
            }
            #controls {
                gap: 5px;
            }
            button {
                padding: 6px 8px;
                font-size: 10px;
            }
            #search {
                width: 100%;
                font-size: 10px;
            }
            .bookmark-card {
                height: 160px;
            }
        }
    </style>
</head>
<body>
    <div id="toolbar">
        <div id="title">ä¹¦ç­¾ç®¡ç†å™¨</div>
        <div id="controls">
            <button onclick="toggleAddForm(true)">â• æ·»åŠ ä¹¦ç­¾</button>
            <button id="edit-mode-btn" onclick="toggleEditMode()">âœï¸ ç¼–è¾‘ä¹¦ç­¾</button>
            <button id="done-btn" onclick="toggleEditMode()" style="display: none;">âœ… å®Œæˆ</button>
            <button onclick="showViewModal()">ğŸ” åˆ‡æ¢è§†å›¾</button>
            <button onclick="showExportModal()">ğŸ“¤ å¯¼å‡ºä¹¦ç­¾</button>
            <button onclick="document.getElementById('import-file').click()">ğŸ“¥ å¯¼å…¥ä¹¦ç­¾</button>
            <input type="file" id="import-file" style="display: none;" accept=".json,.txt,.html" onchange="importBookmarks(event)">
            <button onclick="showHelpModal()">â“ ä½¿ç”¨å¸®åŠ©</button>
            <button onclick="toggleMessageForm()">ğŸ“ ç•™è¨€æ¿</button>
            <button id="delete-page-btn" class="delete-btn" onclick="deletePageBookmarks()">ğŸ—‘ï¸ åˆ é™¤æœ¬é¡µä¹¦ç­¾</button>
            <button id="batch-delete-btn" class="batch-delete-btn" onclick="batchDeleteBookmarks()" style="display: none;">ğŸ—‘ï¸ æ‰¹é‡åˆ é™¤</button>
            <button id="undo-btn" onclick="undoDelete()" style="display: none;">â†©ï¸ æ’¤é”€</button>
            <input type="text" id="search" placeholder="æœç´¢ä¹¦ç­¾ï¼ˆåç§°ï¼‰" oninput="debounce(searchBookmarks, 300)()">
        </div>
    </div>
    <div id="category-wrapper">
        <div id="category-btn" onclick="toggleCategories()">ğŸ“‚ åˆ†ç±»</div>
        <div id="sidebar">
            <h2>é€‰æ‹©åˆ†ç±»</h2>
            <div id="categories"></div>
        </div>
    </div>
    <div id="tips">æ‚¨å¯ä»¥æ·»åŠ ã€ç¼–è¾‘ã€åˆ é™¤å’Œæ‹–åŠ¨æ’åºä¹¦ç­¾ã€‚ä½¿ç”¨â€œå¯¼å‡ºä¹¦ç­¾â€ä¿å­˜æ•°æ®åˆ° bookmarks.jsonã€txt æˆ– html æ–‡ä»¶ï¼Œhtml æ–‡ä»¶å¯ç›´æ¥å¯¼å…¥æµè§ˆå™¨ã€‚æ–‡ä»¶å°†ä¿å­˜åˆ°æ‚¨çš„ä¸‹è½½ç›®å½•ï¼Œè¯·æ‰‹åŠ¨ç§»åŠ¨åˆ°ç¨‹åºæ‰€åœ¨æ–‡ä»¶å¤¹ä¸ä»–äººåˆ†äº«ã€‚å¯¼å…¥æ—¶å°†æ–‡ä»¶æ”¾å…¥åŒä¸€ç›®å½•å¹¶ç‚¹å‡»â€œå¯¼å…¥ä¹¦ç­¾â€åŠ è½½ã€‚</div>
    <div id="container">
        <div id="bookmarks" class="bookmark-grid"></div>
    </div>
    <div id="stats"></div>
    <div id="pagination"></div>

    <div id="overlay" onclick="hideAllModals()"></div>
    <div id="view-modal">
        <h3>é€‰æ‹©æ¯è¡Œå¡ç‰‡æ•°</h3>
        <button onclick="setView(1)" data-view="1">æ¯è¡Œ 1 ä¸ª</button>
        <button onclick="setView(2)" data-view="2">æ¯è¡Œ 2 ä¸ª</button>
        <button onclick="setView(3)" data-view="3">æ¯è¡Œ 3 ä¸ª</button>
        <button onclick="setView(4)" data-view="4">æ¯è¡Œ 4 ä¸ª</button>
        <button onclick="setView(5)" data-view="5">æ¯è¡Œ 5 ä¸ª</button>
    </div>
    <div id="view-bookmark-modal">
        <h3>ä¹¦ç­¾è¯¦æƒ…</h3>
        <div id="bookmark-details"></div>
        <button onclick="hideBookmarkModal()">å…³é—­</button>
    </div>
    <div id="help-modal">
        <h3>ä½¿ç”¨å¸®åŠ©</h3>
        <div id="help-content">
            <p><strong>ç¨‹åºä»‹ç»ï¼š</strong> è¿™æ˜¯ä¸€ä¸ªç¦»çº¿ä¹¦ç­¾ç®¡ç†å™¨ï¼Œå¯å¸®åŠ©æ‚¨åœ¨æœ¬åœ°ç®¡ç†ä¹¦ç­¾å’Œç•™è¨€ï¼Œæ— éœ€è”ç½‘å³å¯ä½¿ç”¨ï¼Œæ”¯æŒåˆ†ç±»ç®¡ç†å’Œæœç´¢ã€‚</p>
            <p><strong>åŠŸèƒ½ï¼š</strong></p>
            <ul>
                <li>æ·»åŠ ä¹¦ç­¾ï¼šç‚¹å‡»â€œæ·»åŠ ä¹¦ç­¾â€æŒ‰é’®ï¼Œå¡«å†™åç§°ã€é“¾æ¥ã€ç®€ä»‹å’Œåˆ†ç±»ã€‚</li>
                <li>ç¼–è¾‘ä¹¦ç­¾ï¼šç‚¹å‡»â€œç¼–è¾‘ä¹¦ç­¾â€æŒ‰é’®ï¼Œé€‰æ‹©å¡ç‰‡ä¸Šçš„ç¼–è¾‘é€‰é¡¹è¿›è¡Œä¿®æ”¹ã€‚</li>
                <li>åˆ é™¤ä¹¦ç­¾ï¼šç‚¹å‡»â€œç¼–è¾‘ä¹¦ç­¾â€æŒ‰é’®ï¼Œé€‰æ‹©å¡ç‰‡ä¸Šçš„åˆ é™¤é€‰é¡¹æˆ–å‹¾é€‰åç‚¹å‡»â€œæ‰¹é‡åˆ é™¤â€ï¼Œå¯é€šè¿‡â€œæ’¤é”€â€æŒ‰é’®æ¢å¤æœ€è¿‘åˆ é™¤ã€‚</li>
                <li>æ‹–åŠ¨æ’åºï¼šæŒ‰ä½å¡ç‰‡æ‹–åŠ¨åˆ°ç›®æ ‡ä½ç½®è°ƒæ•´é¡ºåºã€‚</li>
                <li>ç•™è¨€æ¿ï¼šç‚¹å‡»â€œç•™è¨€æ¿â€æŒ‰é’®ç¼–è¾‘ç•™è¨€ï¼Œä¿å­˜åå¯åœ¨ä¸‹æ¬¡æ‰“å¼€æ—¶æŸ¥çœ‹ã€‚</li>
                <li>å¯¼å‡ºä¹¦ç­¾ï¼šç‚¹å‡»â€œå¯¼å‡ºä¹¦ç­¾â€é€‰æ‹©ä¿å­˜ä¸º JSONã€TXT æˆ– HTML æ–‡ä»¶ï¼ŒHTML æ–‡ä»¶å¯å¯¼å…¥æµè§ˆå™¨ã€‚</li>
                <li>å¯¼å…¥ä¹¦ç­¾ï¼šç‚¹å‡»â€œå¯¼å…¥ä¹¦ç­¾â€åŠ è½½ JSONã€TXT æˆ– HTML æ–‡ä»¶ï¼Œé‡å¤ä¹¦ç­¾å’Œç•™è¨€å°†è¢«è·³è¿‡ã€‚</li>
                <li>æœç´¢ä¹¦ç­¾ï¼šåœ¨æœç´¢æ¡†è¾“å…¥åç§°è¿›è¡Œç­›é€‰ï¼ˆæ”¯æŒé˜²æŠ–ï¼‰ã€‚</li>
                <li>åˆ‡æ¢è§†å›¾ï¼šç‚¹å‡»â€œåˆ‡æ¢è§†å›¾â€é€‰æ‹©æ¯è¡Œæ˜¾ç¤ºçš„å¡ç‰‡æ•°ï¼ˆ1-5ä¸ªï¼‰ã€‚</li>
            </ul>
            <p><strong>æ³¨æ„äº‹é¡¹ï¼š</strong></p>
            <ul>
                <li>ä¹¦ç­¾å’Œç•™è¨€æ•°æ®å­˜å‚¨åœ¨æœ¬åœ°ï¼Œæ¸…ç©ºæµè§ˆå™¨ç¼“å­˜å¯èƒ½ä¸¢å¤±æ•°æ®ï¼Œå»ºè®®å®šæœŸå¯¼å‡ºå¤‡ä»½ã€‚</li>
                <li>å¯¼å‡ºæ–‡ä»¶é»˜è®¤ä¿å­˜åˆ°ä¸‹è½½ç›®å½•ï¼Œéœ€æ‰‹åŠ¨ç§»åŠ¨åˆ°ç¨‹åºæ–‡ä»¶å¤¹ä»¥ä¾¿å¯¼å…¥ã€‚</li>
            </ul>
        </div>
        <button onclick="hideHelpModal()">å…³é—­</button>
    </div>
    <div id="export-modal">
        <h3>å¯¼å‡ºä¹¦ç­¾å’Œç•™è¨€</h3>
        <div class="form-group">
            <label>æ–‡ä»¶å:</label>
            <input type="text" id="export-filename" placeholder="bookmarks_YYYY.MM.DD">
        </div>
        <button onclick="exportBookmarks('json')">å¯¼å‡ºä¸º JSON</button>
        <button onclick="exportBookmarks('txt')">å¯¼å‡ºä¸º TXT</button>
        <button onclick="exportBookmarks('html')">å¯¼å‡ºä¸º HTML</button>
    </div>
    <div id="add-form">
        <h3>æ·»åŠ /ç¼–è¾‘ä¹¦ç­¾</h3>
        <div class="form-group">
            <label>åç§°:</label>
            <input type="text" id="name" placeholder="è¯·è¾“å…¥ä¹¦ç­¾åç§°">
        </div>
        <div class="form-group">
            <label>é“¾æ¥:</label>
            <input type="text" id="url" placeholder="è¯·è¾“å…¥é“¾æ¥ (å¦‚ https://example.com)">
        </div>
        <div class="form-group">
            <label>ç®€ä»‹:</label>
            <textarea id="desc" placeholder="è¯·è¾“å…¥ç®€ä»‹ï¼ˆå¯é€‰ï¼‰"></textarea>
        </div>
        <div class="form-group">
            <label>åˆ†ç±»:</label>
            <input type="text" id="category" list="category-list" placeholder="è¾“å…¥æˆ–é€‰æ‹©åˆ†ç±»">
            <datalist id="category-list"></datalist>
        </div>
        <div class="form-buttons">
            <button onclick="saveBookmark()">ğŸ’¾ ä¿å­˜</button>
            <button onclick="toggleAddForm(false)">âŒ å–æ¶ˆ</button>
        </div>
    </div>
    <div id="message-form">
        <h3>ç¼–è¾‘ç•™è¨€æ¿</h3>
        <div class="form-group">
            <label>ç•™è¨€å†…å®¹</label>
            <textarea id="message-input" placeholder="åœ¨æ­¤è¾“å…¥ç•™è¨€..." readonly></textarea>
        </div>
        <div class="form-buttons">
            <button id="save-message-btn" onclick="saveMessage()">ä¿å­˜</button>
            <button id="cancel-message-btn" onclick="cancelMessageEdit()">å–æ¶ˆ</button>
            <button id="edit-message-btn" onclick="enableMessageEdit()">âœï¸ ç¼–è¾‘</button>
            <button id="close-message-btn" onclick="hideAllModals()">âŒ å…³é—­</button>
        </div>
    </div>

    <script>
        // çŠ¶æ€ç®¡ç†
        const state = {
            bookmarks: [],
            message: '',
            lastDeletedBookmark: null,
            lastDeletedIndex: null,
            itemsPerRow: 5,
            filteredBookmarks: [],
            selectedCategory: 'å…¨éƒ¨',
            editingIndex: null,
            isEditMode: false,
            isSidebarVisible: false,
            selectedBookmarks: [],
            currentPage: 1
        };

        const MAX_BOOKMARKS = 1000;
        const MAX_STORAGE_SIZE = 4 * 1024 * 1024; // 4MB

        // å·¥å…·å‡½æ•°
        function debounce(func, wait) {
            let timeout;
            return function (...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        function getRandomLightColor() {
            const r = Math.floor(Math.random() * 56) + 200;
            const g = Math.floor(Math.random() * 56) + 200;
            const b = Math.floor(Math.random() * 56) + 200;
            return `rgb(${r}, ${g}, ${b})`;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function isValidUrl(string) {
            try {
                const url = new URL(string);
                return /^(http|https):/.test(url.protocol) && !!url.hostname;
            } catch {
                return false;
            }
        }

        // æ¨¡æ€æ¡†ç®¡ç†
        function showModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'block';
                document.getElementById('overlay').style.display = 'block';
            }
        }

        function hideModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'none';
                document.getElementById('overlay').style.display = 'none';
            }
        }

        function hideAllModals() {
            ['view-modal', 'view-bookmark-modal', 'help-modal', 'add-form', 'export-modal', 'message-form'].forEach(id => {
                hideModal(id);
            });
            state.editingIndex = null;
            const messageInput = document.getElementById('message-input');
            if (messageInput) {
                messageInput.setAttribute('readonly', 'readonly');
                messageInput.value = state.message;
                document.getElementById('save-message-btn').style.display = 'none';
                document.getElementById('cancel-message-btn').style.display = 'none';
                document.getElementById('edit-message-btn').style.display = 'block';
                document.getElementById('close-message-btn').style.display = 'block';
            }
        }

        // æ•°æ®ç®¡ç†
        function saveBookmarks() {
            try {
                if (state.bookmarks.length > MAX_BOOKMARKS) {
                    alert(`ä¹¦ç­¾æ•°é‡å·²è¶…è¿‡æœ€å¤§é™åˆ¶ (${MAX_BOOKMARKS} ä¸ª)ï¼Œè¯·åˆ é™¤ä¸€äº›ä¹¦ç­¾æˆ–å¯¼å‡ºå¤‡ä»½åæ¸…ç©ºï¼`);
                    return false;
                }
                const data = { bookmarks: state.bookmarks, message: state.message };
                const dataString = JSON.stringify(data);
                const dataSize = new Blob([dataString]).size;
                if (dataSize > MAX_STORAGE_SIZE * 0.8) {
                    alert(`å­˜å‚¨ç©ºé—´å³å°†è¾¾åˆ°ä¸Šé™ï¼ˆå½“å‰ä½¿ç”¨ ${Math.round(dataSize / 1024)}KB / ${Math.round(MAX_STORAGE_SIZE / 1024)}KBï¼‰ï¼Œå»ºè®®å¯¼å‡ºå¤‡ä»½åæ¸…ç©ºæ•°æ®ã€‚`);
                }
                if (dataSize > MAX_STORAGE_SIZE) {
                    alert(`æ•°æ®è¿‡å¤§ï¼ˆè¶…è¿‡ ${MAX_STORAGE_SIZE / 1024 / 1024}MBï¼‰ï¼Œè¯·åˆ é™¤ä¸€äº›ä¹¦ç­¾æˆ–ç•™è¨€åé‡è¯•ï¼`);
                    return false;
                }
                localStorage.setItem('bookmarkData', dataString);
                renderCategories();
                filterBookmarks();
                renderBookmarks();
                updateStats();
                document.getElementById('undo-btn').style.display = state.lastDeletedBookmark ? 'inline-flex' : 'none';
                return true;
            } catch (e) {
                console.error('ä¿å­˜æ•°æ®å¤±è´¥ï¼š', e);
                alert(`ä¿å­˜æ•°æ®å¤±è´¥ï¼š${e.message}`);
                return false;
            }
        }

        function loadBookmarks() {
            try {
                const storedData = localStorage.getItem('bookmarkData');
                if (!storedData) {
                    state.bookmarks = [];
                    state.message = '';
                } else {
                    const data = JSON.parse(storedData);
                    state.bookmarks = Array.isArray(data.bookmarks) ? data.bookmarks.map(b => ({
                        name: b.name || 'æœªå‘½å',
                        url: b.url || '',
                        desc: b.desc || '',
                        category: b.category || 'é»˜è®¤åˆ†ç»„',
                        color: b.color || getRandomLightColor()
                    })) : [];
                    state.message = typeof data.message === 'string' ? data.message : '';
                }
            } catch (e) {
                console.error('åŠ è½½æ•°æ®å¤±è´¥ï¼š', e);
                alert(`åŠ è½½æ•°æ®å¤±è´¥ï¼š${e.message}ï¼Œå·²åˆå§‹åŒ–ä¸ºç©º`);
                state.bookmarks = [];
                state.message = '';
            }
            filterBookmarks();
            renderCategories();
            renderBookmarks();
            updateStats();
        }

        // æ¸²æŸ“ä¸è¿‡æ»¤
        function filterBookmarks() {
            const query = document.getElementById('search')?.value.toLowerCase() || '';
            state.filteredBookmarks = state.selectedCategory === 'å…¨éƒ¨'
                ? state.bookmarks.filter(b => b.name.toLowerCase().includes(query))
                : state.bookmarks.filter(b => (b.category || 'é»˜è®¤åˆ†ç»„') === state.selectedCategory && b.name.toLowerCase().includes(query));
            state.currentPage = 1;
        }

        function renderCategories() {
            const container = document.getElementById('categories');
            if (!container) return;
            const categories = ['å…¨éƒ¨', 'é»˜è®¤åˆ†ç»„', ...new Set(state.bookmarks.map(b => b.category).filter(cat => cat && cat !== 'é»˜è®¤åˆ†ç»„'))];
            container.innerHTML = '';
            categories.forEach(cat => {
                const div = document.createElement('div');
                div.className = `category-item${cat === state.selectedCategory ? ' active' : ''}`;
                div.textContent = cat;
                div.title = cat;
                div.onclick = () => selectCategory(cat);
                container.appendChild(div);
            });
            updateCategoryList(categories);
        }

        function updateCategoryList(categories) {
            const datalist = document.getElementById('category-list');
            if (!datalist) return;
            datalist.innerHTML = '';
            categories.filter(cat => cat !== 'å…¨éƒ¨').forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                datalist.appendChild(option);
            });
        }

        function getItemsPerPage() {
            return state.itemsPerRow === 5 ? 25 : 24;
        }

        function renderBookmarks() {
            const container = document.getElementById('bookmarks');
            if (!container) return;
            container.innerHTML = '';
            container.className = 'bookmark-grid';

            const baseWidth = 1100 - 40;
            const gap = 20;
            let columns = state.itemsPerRow;
            if (window.innerWidth <= 768) columns = Math.min(2, state.itemsPerRow);
            if (window.innerWidth <= 480) columns = 1;
            const cardWidth = window.innerWidth <= 768 ? (window.innerWidth - 40) / columns : Math.floor((baseWidth - gap * (columns - 1)) / columns);

            container.style.gridTemplateColumns = window.innerWidth <= 768
                ? `repeat(${columns}, minmax(${cardWidth}px, 1fr))`
                : `repeat(${columns}, ${cardWidth}px)`;

            const itemsPerPage = getItemsPerPage();
            const startIndex = (state.currentPage - 1) * itemsPerPage;
            const endIndex = Math.min(startIndex + itemsPerPage, state.filteredBookmarks.length);
            const paginatedBookmarks = state.filteredBookmarks.slice(startIndex, endIndex);

            paginatedBookmarks.forEach((bookmark, index) => {
                const div = document.createElement('div');
                div.className = `bookmark-card${state.isEditMode ? ' edit-mode' : ''}`;
                div.draggable = !state.isEditMode;
                div.dataset.index = startIndex + index;
                div.style.width = window.innerWidth > 768 ? `${cardWidth}px` : '100%';
                div.style.backgroundColor = bookmark.color;

                const displayName = bookmark.name.length > 7 ? bookmark.name.substring(0, 7) + '...' : bookmark.name;
                const displayCategory = bookmark.category.length > 5 ? bookmark.category.substring(0, 5) + '...' : bookmark.category;
                const showCategory = !(state.itemsPerRow === 5 && state.isEditMode);
                const globalIndex = state.bookmarks.indexOf(bookmark);

                const nameSpan = state.isEditMode
                    ? `<span>${escapeHtml(displayName)}</span>`
                    : `<span class="clickable" onclick="showBookmarkDetails(${startIndex + index})">${escapeHtml(displayName)}</span>`;

                div.innerHTML = `
                    <div class="bookmark-content">
                        <h3>${nameSpan}
                            <input type="checkbox" class="bookmark-checkbox${state.isEditMode ? ' visible' : ''}" data-global-index="${globalIndex}">
                        </h3>
                        <p class="url"><a href="${escapeHtml(bookmark.url)}" target="_blank">${escapeHtml(bookmark.url)}</a></p>
                        <div class="desc-container">
                            <p class="desc">${escapeHtml(bookmark.desc)}</p>
                        </div>
                        ${showCategory ? `<div class="category-container"><span class="category-tag">${escapeHtml(displayCategory)}</span></div>` : ''}
                    </div>
                    <div class="action-buttons" style="${state.isEditMode ? 'display: flex;' : 'display: none;'}">
                        <button onclick="editBookmark(${startIndex + index}); event.stopPropagation();">âœï¸ ç¼–è¾‘</button>
                        <button class="delete-btn" onclick="deleteBookmark(${startIndex + index}); event.stopPropagation();">ğŸ—‘ï¸ åˆ é™¤</button>
                    </div>
                `;

                if (state.isEditMode) {
                    div.addEventListener('click', (e) => {
                        const target = e.target;
                        if (target.tagName !== 'BUTTON' && !target.classList.contains('bookmark-checkbox')) {
                            const checkbox = div.querySelector('.bookmark-checkbox');
                            checkbox.checked = !checkbox.checked;
                            toggleBookmarkSelection(globalIndex, checkbox.checked);
                        }
                    });
                    const checkbox = div.querySelector('.bookmark-checkbox');
                    checkbox.onchange = (e) => toggleBookmarkSelection(globalIndex, e.target.checked);
                }

                container.appendChild(div);
            });

            updateControlButtons();
            renderPagination();
            updateStats();

            const items = container.querySelectorAll('.bookmark-card');
            items.forEach(item => {
                if (!state.isEditMode) {
                    item.addEventListener('dragstart', handleDragStart);
                    item.addEventListener('dragover', handleDragOver);
                    item.addEventListener('dragenter', handleDragEnter);
                    item.addEventListener('dragleave', handleDragLeave);
                    item.addEventListener('drop', handleDrop);
                    item.addEventListener('dragend', handleDragEnd);
                    item.addEventListener('touchstart', handleTouchStart);
                    item.addEventListener('touchmove', handleTouchMove);
                    item.addEventListener('touchend', handleTouchEnd);
                }
            });
        }

        function renderPagination() {
            const container = document.getElementById('pagination');
            if (!container) return;
            container.innerHTML = '';
            const itemsPerPage = getItemsPerPage();
            const totalPages = Math.max(1, Math.ceil(state.filteredBookmarks.length / itemsPerPage));

            if (state.filteredBookmarks.length === 0) {
                container.style.display = 'none';
                return;
            }
            container.style.display = 'flex';

            const prevBtn = document.createElement('button');
            prevBtn.textContent = 'Â«';
            prevBtn.disabled = state.currentPage === 1;
            prevBtn.onclick = () => {
                if (state.currentPage > 1) {
                    state.currentPage--;
                    renderBookmarks();
                }
            };
            container.appendChild(prevBtn);

            const maxVisiblePages = 5;
            let startPage = Math.max(1, state.currentPage - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
            if (endPage - startPage + 1 < maxVisiblePages) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }

            for (let i = startPage; i <= endPage; i++) {
                const pageBtn = document.createElement('button');
                pageBtn.textContent = i;
                pageBtn.classList.toggle('active', i === state.currentPage);
                pageBtn.onclick = () => {
                    state.currentPage = i;
                    renderBookmarks();
                };
                container.appendChild(pageBtn);
            }

            const nextBtn = document.createElement('button');
            nextBtn.textContent = 'Â»';
            nextBtn.disabled = state.currentPage === totalPages;
            nextBtn.onclick = () => {
                if (state.currentPage < totalPages) {
                    state.currentPage++;
                    renderBookmarks();
                }
            };
            container.appendChild(nextBtn);
        }

        function updateStats() {
            const statsDiv = document.getElementById('stats');
            if (!statsDiv) return;
            const totalBookmarks = state.bookmarks.length;
            const totalCategories = new Set(state.bookmarks.map(b => b.category).filter(cat => cat)).size;
            const itemsPerPage = getItemsPerPage();
            const visibleCards = Math.min(state.filteredBookmarks.length - (state.currentPage - 1) * itemsPerPage, itemsPerPage);
            const totalVisibleCards = state.filteredBookmarks.length;
            statsDiv.textContent = `æ€»ä¹¦ç­¾æ•°ï¼š${totalBookmarks} | æ€»åˆ†ç»„æ•°ï¼š${totalCategories} | å½“å‰é¡µæ˜¾ç¤ºä¹¦ç­¾å¡ç‰‡æ•°ï¼š${visibleCards} | æ€»ç­›é€‰ä¹¦ç­¾æ•°ï¼š${totalVisibleCards}`;
            statsDiv.style.display = state.filteredBookmarks.length > 0 ? 'block' : 'none';
        }

        // åˆ†ç±»ä¸è§†å›¾
        function toggleCategories() {
            const sidebar = document.getElementById('sidebar');
            if (!sidebar) return;
            const container = document.getElementById('container');
            const stats = document.getElementById('stats');
            const tips = document.getElementById('tips');
            const pagination = document.getElementById('pagination');
            state.isSidebarVisible = !state.isSidebarVisible;
            sidebar.style.display = state.isSidebarVisible ? 'block' : 'none';
            const marginLeft = window.innerWidth > 768 ? (state.isSidebarVisible ? '150px' : '90px') : '0';
            if (container) container.style.marginLeft = marginLeft;
            if (stats) stats.style.marginLeft = marginLeft;
            if (tips) tips.style.marginLeft = marginLeft;
            if (pagination) pagination.style.marginLeft = marginLeft;
            if (state.isSidebarVisible) {
                renderCategories();
                const categoryBtn = document.getElementById('category-btn');
                const btnRect = categoryBtn.getBoundingClientRect();
                const availableHeight = window.innerHeight - btnRect.bottom - 20;
                sidebar.style.maxHeight = `${availableHeight}px`;
            }
        }

        function selectCategory(category) {
            state.selectedCategory = category;
            filterBookmarks();
            renderBookmarks();
            updateStats();
            toggleCategories();
        }

        function showViewModal() {
            const modal = document.getElementById('view-modal');
            if (!modal) return;
            const buttons = modal.querySelectorAll('button');
            buttons.forEach(btn => {
                const viewNum = parseInt(btn.dataset.view);
                btn.classList.toggle('view-selected', viewNum === state.itemsPerRow);
            });
            showModal('view-modal');
        }

        function setView(perRow) {
            state.itemsPerRow = Math.max(1, Math.min(5, perRow));
            state.currentPage = 1;
            renderBookmarks();
            updateStats();
            hideAllModals();
        }

        // ä¹¦ç­¾æ“ä½œ
        function toggleAddForm(show) {
            const form = document.getElementById('add-form');
            if (!form) return;
            if (show) {
                showModal('add-form');
            } else {
                hideModal('add-form');
                state.editingIndex = null;
                document.getElementById('name').value = '';
                document.getElementById('url').value = '';
                document.getElementById('desc').value = '';
                document.getElementById('category').value = '';
            }
        }

        function saveBookmark() {
            const nameInput = document.getElementById('name');
            const urlInput = document.getElementById('url');
            const descInput = document.getElementById('desc');
            const categoryInput = document.getElementById('category');
            if (!nameInput || !urlInput) return;

            const name = nameInput.value.trim();
            let url = urlInput.value.trim();
            const desc = descInput.value.trim();
            const category = categoryInput.value.trim();

            if (!name || !url) {
                alert('è¯·å¡«å†™åç§°å’Œé“¾æ¥');
                return;
            }
            if (!url.match(/^https?:\/\//)) url = 'https://' + url;
            if (!isValidUrl(url)) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„URLï¼ˆä¾‹å¦‚ï¼šhttps://example.comï¼Œä»…æ”¯æŒ http æˆ– https åè®®ï¼‰');
                return;
            }

            const bookmark = {
                name,
                url,
                desc,
                category: category || (state.bookmarks.length > 0 ? state.bookmarks[state.bookmarks.length - 1].category : 'é»˜è®¤åˆ†ç»„'),
                color: state.editingIndex !== null && state.editingIndex < state.filteredBookmarks.length
                    ? state.bookmarks[state.bookmarks.indexOf(state.filteredBookmarks[state.editingIndex])].color
                    : getRandomLightColor()
            };

            if (state.editingIndex !== null && state.editingIndex < state.filteredBookmarks.length) {
                const globalIndex = state.bookmarks.indexOf(state.filteredBookmarks[state.editingIndex]);
                if (globalIndex !== -1) state.bookmarks[globalIndex] = bookmark;
            } else {
                state.bookmarks.push(bookmark);
            }
            if (saveBookmarks()) toggleAddForm(false);
        }

        function editBookmark(index) {
            const bookmark = state.filteredBookmarks[index];
            if (!bookmark) return;
            const nameInput = document.getElementById('name');
            const urlInput = document.getElementById('url');
            const descInput = document.getElementById('desc');
            const categoryInput = document.getElementById('category');
            if (!nameInput || !urlInput || !descInput || !categoryInput) return;

            nameInput.value = bookmark.name;
            urlInput.value = bookmark.url;
            descInput.value = bookmark.desc;
            categoryInput.value = bookmark.category;
            state.editingIndex = index;
            toggleAddForm(true);
        }

        function deleteBookmark(index) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªä¹¦ç­¾å—ï¼Ÿ')) return;
            const globalIndex = state.bookmarks.indexOf(state.filteredBookmarks[index]);
            if (globalIndex === -1) return;
            state.lastDeletedBookmark = { ...state.bookmarks[globalIndex] };
            state.lastDeletedIndex = globalIndex;
            state.bookmarks.splice(globalIndex, 1);
            saveBookmarks();
        }

        function deletePageBookmarks() {
            const itemsPerPage = getItemsPerPage();
            const startIndex = (state.currentPage - 1) * itemsPerPage;
            const endIndex = Math.min(startIndex + itemsPerPage, state.filteredBookmarks.length);
            
            if (endIndex <= startIndex) return;
            
            if (!confirm(`ç¡®å®šè¦åˆ é™¤æœ¬é¡µ ${endIndex - startIndex} ä¸ªä¹¦ç­¾å—ï¼Ÿ`)) return;
            
            const deletedBookmarks = [];
            const globalIndices = [];
            
            for (let i = startIndex; i < endIndex; i++) {
                const globalIndex = state.bookmarks.indexOf(state.filteredBookmarks[i]);
                if (globalIndex !== -1) {
                    deletedBookmarks.push({ bookmark: { ...state.bookmarks[globalIndex] }, index: globalIndex });
                    globalIndices.push(globalIndex);
                }
            }
            
            globalIndices.sort((a, b) => b - a).forEach(index => {
                state.bookmarks.splice(index, 1);
            });
            
            state.lastDeletedBookmark = deletedBookmarks;
            state.lastDeletedIndex = null;
            state.selectedBookmarks = [];
            
            filterBookmarks();
            saveBookmarks();
        }

        function toggleBookmarkSelection(globalIndex, isChecked) {
            if (isChecked) {
                if (!state.selectedBookmarks.includes(globalIndex)) state.selectedBookmarks.push(globalIndex);
            } else {
                state.selectedBookmarks = state.selectedBookmarks.filter(idx => idx !== globalIndex);
            }
            updateControlButtons();
        }

        function updateControlButtons() {
            const batchDeleteBtn = document.getElementById('batch-delete-btn');
            const deletePageBtn = document.getElementById('delete-page-btn');
            if (batchDeleteBtn && deletePageBtn) {
                if (state.isEditMode && state.selectedBookmarks.length > 0) {
                    batchDeleteBtn.style.display = 'inline-flex';
                    deletePageBtn.style.display = 'none';
                } else {
                    batchDeleteBtn.style.display = 'none';
                    deletePageBtn.style.display = 'inline-flex';
                }
            }
        }

        function batchDeleteBookmarks() {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤ ${state.selectedBookmarks.length} ä¸ªé€‰ä¸­çš„ä¹¦ç­¾å—ï¼Ÿ`)) return;
            const deletedBookmarks = [];
            state.selectedBookmarks.sort((a, b) => b - a);
            state.selectedBookmarks.forEach(index => {
                deletedBookmarks.push({ bookmark: { ...state.bookmarks[index] }, index });
                state.bookmarks.splice(index, 1);
            });
            state.lastDeletedBookmark = deletedBookmarks;
            state.lastDeletedIndex = null;
            state.selectedBookmarks = [];
            saveBookmarks();
            // æ‰¹é‡åˆ é™¤åè‡ªåŠ¨é€€å‡ºç¼–è¾‘æ¨¡å¼
            toggleEditMode();
        }

        function undoDelete() {
            if (!state.lastDeletedBookmark) return;
            if (Array.isArray(state.lastDeletedBookmark)) {
                state.lastDeletedBookmark.sort((a, b) => a.index - b.index);
                state.lastDeletedBookmark.forEach(({ bookmark, index }) => {
                    state.bookmarks.splice(index, 0, bookmark);
                });
            } else if (state.lastDeletedIndex !== null) {
                state.bookmarks.splice(state.lastDeletedIndex, 0, state.lastDeletedBookmark);
            }
            state.lastDeletedBookmark = null;
            state.lastDeletedIndex = null;
            filterBookmarks();
            saveBookmarks();
        }

        function toggleEditMode() {
            state.isEditMode = !state.isEditMode;
            const editModeBtn = document.getElementById('edit-mode-btn');
            const doneBtn = document.getElementById('done-btn');
            if (editModeBtn) editModeBtn.style.display = state.isEditMode ? 'none' : 'inline-flex';
            if (doneBtn) doneBtn.style.display = state.isEditMode ? 'inline-flex' : 'none';
            state.selectedBookmarks = [];
            renderBookmarks();
            document.querySelectorAll('.bookmark-checkbox').forEach(checkbox => checkbox.checked = false);
        }

        // å…¶ä»–æ¨¡æ€æ¡†ç®¡ç†
        function showBookmarkDetails(index) {
            const bookmark = state.filteredBookmarks[index];
            if (!bookmark) return;
            const details = document.getElementById('bookmark-details');
            if (!details) return;
            details.innerHTML = `
                <div class="form-group"><label>åç§°:</label><p>${escapeHtml(bookmark.name)}</p></div>
                <div class="form-group"><label>é“¾æ¥:</label><p><a href="${escapeHtml(bookmark.url)}" target="_blank">${escapeHtml(bookmark.url)}</a></p></div>
                <div class="form-group"><label>ç®€ä»‹:</label><p>${escapeHtml(bookmark.desc) || 'æ— '}</p></div>
                <div class="form-group"><label>åˆ†ç±»:</label><p>${escapeHtml(bookmark.category)}</p></div>
            `;
            showModal('view-bookmark-modal');
        }

        function hideBookmarkModal() {
            hideModal('view-bookmark-modal');
        }

        function showHelpModal() {
            showModal('help-modal');
        }

        function hideHelpModal() {
            hideModal('help-modal');
        }

        function showExportModal() {
            const filenameInput = document.getElementById('export-filename');
            if (filenameInput) {
                filenameInput.value = `bookmarks_${new Date().toISOString().slice(0,10).replace(/-/g, '.')}`;
            }
            showModal('export-modal');
        }

        // ç•™è¨€æ¿
        function toggleMessageForm() {
            const form = document.getElementById('message-form');
            if (!form) return;
            if (form.style.display === 'block') {
                hideAllModals();
            } else {
                const messageInput = document.getElementById('message-input');
                if (messageInput) messageInput.value = state.message;
                showModal('message-form');
                document.getElementById('save-message-btn').style.display = 'none';
                document.getElementById('cancel-message-btn').style.display = 'none';
                document.getElementById('edit-message-btn').style.display = 'block';
                document.getElementById('close-message-btn').style.display = 'block';
                if (messageInput) messageInput.setAttribute('readonly', 'readonly');
            }
        }

        function enableMessageEdit() {
            const messageInput = document.getElementById('message-input');
            if (!messageInput) return;
            messageInput.removeAttribute('readonly');
            document.getElementById('save-message-btn').style.display = 'block';
            document.getElementById('cancel-message-btn').style.display = 'block';
            document.getElementById('edit-message-btn').style.display = 'none';
            document.getElementById('close-message-btn').style.display = 'none';
            messageInput.focus();
        }

        function saveMessage() {
            const messageInput = document.getElementById('message-input');
            if (!messageInput) return;
            state.message = messageInput.value.trim();
            if (saveBookmarks()) hideAllModals();
        }

        function cancelMessageEdit() {
            const messageInput = document.getElementById('message-input');
            if (!messageInput) return;
            messageInput.value = state.message;
            hideAllModals();
        }

        // æœç´¢ä¸å¯¼å…¥å¯¼å‡º
        function searchBookmarks() {
            filterBookmarks();
            renderBookmarks();
            updateStats();
        }

        function exportBookmarks(format) {
            const filenameInput = document.getElementById('export-filename');
            if (!filenameInput) return;
            const filename = `${filenameInput.value.trim() || 'bookmarks'}.${format}`;
            let content, type;

            try {
                if (format === 'json') {
                    content = JSON.stringify({ bookmarks: state.bookmarks, message: state.message }, null, 2);
                    type = 'application/json';
                } else if (format === 'txt') {
                    content = `ç•™è¨€æ¿:\n${state.message || 'æ— '}\n------------------------\n` +
                        state.bookmarks.map((b, i) => `${i + 1}.\nåç§°: ${b.name}\né“¾æ¥: ${b.url}\nç®€ä»‹: ${b.desc || 'æ— '}\nåˆ†ç±»: ${b.category}\né¢œè‰²: ${b.color}\n------------------------`).join('\n');
                    type = 'text/plain';
                } else if (format === 'html') {
                    const categories = {};
                    state.bookmarks.forEach(b => {
                        const cat = b.category || 'é»˜è®¤åˆ†ç»„';
                        if (!categories[cat]) categories[cat] = [];
                        categories[cat].push(b);
                    });

                    const now = Math.floor(Date.now() / 1000);
                    content = `<!DOCTYPE NETSCAPE-Bookmark-file-1>
<!-- This is an automatically generated file.
     It will be read and overwritten.
     DO NOT EDIT! -->
<META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=UTF-8">
<TITLE>Bookmarks</TITLE>
<H1>Bookmarks</H1>
<DL><p>`;
                    for (const [cat, items] of Object.entries(categories)) {
                        content += `\n    <DT><H3 ADD_DATE="${now}" LAST_MODIFIED="${now}">${escapeHtml(cat)}</H3>\n    <DL><p>`;
                        items.forEach(b => {
                            content += `\n        <DT><A HREF="${escapeHtml(b.url)}" ADD_DATE="${now}" LAST_MODIFIED="${now}">${escapeHtml(b.name)}</A>`;
                            if (b.desc) content += `\n        <DD>${escapeHtml(b.desc)}</DD>`;
                        });
                        content += `\n    </DL><p>`;
                    }
                    content += `\n</DL><p>`;
                    type = 'text/html';
                } else {
                    alert('ä¸æ”¯æŒçš„å¯¼å‡ºæ ¼å¼');
                    return;
                }

                const blob = new Blob([content], { type });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = filename;
                link.click();
                URL.revokeObjectURL(url);
                hideAllModals();
            } catch (e) {
                console.error('å¯¼å‡ºå¤±è´¥ï¼š', e);
                alert(`å¯¼å‡ºå¤±è´¥ï¼š${e.message}`);
            }
        }

        function importBookmarks(event) {
            const file = event.target.files[0];
            if (!file) return;

            const lastImportedFile = localStorage.getItem('lastImportedFile');
            if (lastImportedFile === file.name && !confirm(`æ‚¨å·²å†æ¬¡å¯¼å…¥ç›¸åŒçš„æ–‡ä»¶â€œ${file.name}â€ï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ`)) {
                document.getElementById('import-file').value = '';
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    let importedBookmarks = [];
                    let importedMessage = '';
                    if (file.name.endsWith('.json')) {
                        const imported = JSON.parse(e.target.result);
                        if (!Array.isArray(imported.bookmarks) || typeof imported.message !== 'string') {
                            throw new Error('JSON æ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®ï¼Œå¿…é¡»åŒ…å« bookmarks æ•°ç»„å’Œ message å­—ç¬¦ä¸²');
                        }
                        importedBookmarks = imported.bookmarks;
                        importedMessage = imported.message;
                    } else if (file.name.endsWith('.txt')) {
                        const text = e.target.result;
                        const sections = text.split('------------------------').filter(entry => entry.trim());
                        for (const entry of sections) {
                            const lines = entry.split('\n').filter(line => line.trim());
                            if (lines[0].includes('ç•™è¨€æ¿')) {
                                importedMessage = lines.slice(1).join('\n').trim() === 'æ— ' ? '' : lines.slice(1).join('\n').trim();
                                continue;
                            }
                            if (lines.length < 5) continue;
                            const bookmark = {};
                            for (const line of lines) {
                                if (line.match(/^\d+\./)) continue;
                                const [key, ...valueParts] = line.split(': ');
                                const value = valueParts.join(': ').trim();
                                if (key.includes('åç§°')) bookmark.name = value || 'æœªå‘½å';
                                if (key.includes('é“¾æ¥')) bookmark.url = value === 'æ— ' ? '' : value;
                                if (key.includes('ç®€ä»‹')) bookmark.desc = value === 'æ— ' ? '' : value;
                                if (key.includes('åˆ†ç±»')) bookmark.category = value || 'é»˜è®¤åˆ†ç»„';
                                if (key.includes('é¢œè‰²')) bookmark.color = value === 'æ— ' ? getRandomLightColor() : value;
                            }
                            if (bookmark.name && bookmark.url) importedBookmarks.push(bookmark);
                        }
                        if (!importedBookmarks.length && !importedMessage) {
                            throw new Error('æ— æ•ˆçš„TXTæ–‡ä»¶ï¼šæœªæ‰¾åˆ°æœ‰æ•ˆä¹¦ç­¾æˆ–ç•™è¨€');
                        }
                    } else if (file.name.endsWith('.html')) {
                        const parser = new DOMParser();
                        const doc = parser.parseFromString(e.target.result, 'text/html');
                        const dlElements = doc.getElementsByTagName('DL');
                        if (!dlElements.length) throw new Error('æ— æ•ˆçš„HTMLä¹¦ç­¾æ–‡ä»¶ï¼šæœªæ‰¾åˆ°ä¹¦ç­¾æ•°æ®');

                        const h1Element = doc.querySelector('H1');
                        const rootCategory = h1Element ? h1Element.textContent.trim() || 'Bookmarks' : 'Bookmarks';

                        function parseBookmarks(node, categoryStack = []) {
                            Array.from(node.children).forEach(child => {
                                if (child.tagName === 'H3') {
                                    const folderName = child.textContent.trim() || 'æœªå‘½åæ–‡ä»¶å¤¹';
                                    categoryStack.push(folderName);
                                    const nextDL = child.nextElementSibling;
                                    if (nextDL && nextDL.tagName === 'DL') {
                                        parseBookmarks(nextDL, categoryStack);
                                    }
                                    categoryStack.pop();
                                } else if (child.tagName === 'DT') {
                                    const aTag = child.querySelector('A');
                                    if (aTag) {
                                        const url = aTag.getAttribute('HREF') || '';
                                        const name = aTag.textContent.trim() || 'æœªå‘½å';
                                        const nextSibling = child.nextElementSibling;
                                        const desc = (nextSibling && nextSibling.tagName === 'DD') ? nextSibling.textContent.trim() : '';
                                        if (url) {
                                            const currentCategory = categoryStack.length > 0 ? categoryStack[categoryStack.length - 1] : 'é»˜è®¤åˆ†ç»„'; // é¿å…ä½¿ç”¨ rootCategory
                                            importedBookmarks.push({
                                                name,
                                                url,
                                                desc,
                                                category: currentCategory,
                                                color: getRandomLightColor()
                                            });
                                        }
                                    }
                                } else if (child.tagName === 'DL') {
                                    parseBookmarks(child, categoryStack);
                                }
                            });
                        }

                        // ä»æ‰€æœ‰ DL å…ƒç´ ä¸­è§£æï¼Œç¡®ä¿ä¸é—æ¼ä»»ä½•ä¹¦ç­¾
                        Array.from(dlElements).forEach(dl => parseBookmarks(dl, []));
                        if (!importedBookmarks.length) throw new Error('æ— æ•ˆçš„HTMLä¹¦ç­¾æ–‡ä»¶ï¼šæœªæ‰¾åˆ°æœ‰æ•ˆä¹¦ç­¾');
                    } else {
                        throw new Error('ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼ï¼Œä»…æ”¯æŒ .jsonã€.txt å’Œ .html');
                    }

                    let addedBookmarkCount = 0;
                    importedBookmarks.forEach(newBookmark => {
                        if (!newBookmark.name || !newBookmark.url) return;
                        newBookmark.color = newBookmark.color || getRandomLightColor();
                        newBookmark.category = newBookmark.category || 'é»˜è®¤åˆ†ç»„';
                        const isDuplicate = state.bookmarks.some(b => b.url === newBookmark.url);
                        if (!isDuplicate) {
                            state.bookmarks.push(newBookmark);
                            addedBookmarkCount++;
                        }
                    });

                    let messageAdded = false;
                    if (importedMessage && importedMessage !== state.message) {
                        const currentMessageTrimmed = state.message.trim();
                        const importedMessageTrimmed = importedMessage.trim();
                        if (importedMessageTrimmed.startsWith(currentMessageTrimmed)) {
                            const newContent = importedMessageTrimmed.substring(currentMessageTrimmed.length).trim();
                            if (newContent) {
                                state.message = currentMessageTrimmed ? `${currentMessageTrimmed}\n${newContent}` : newContent;
                                messageAdded = true;
                            }
                        } else if (!currentMessageTrimmed.startsWith(importedMessageTrimmed)) {
                            state.message = currentMessageTrimmed ? `${currentMessageTrimmed}\n${importedMessageTrimmed}` : importedMessageTrimmed;
                            messageAdded = true;
                        }
                    }

                    if (saveBookmarks()) {
                        localStorage.setItem('lastImportedFile', file.name);
                        alert(`å¯¼å…¥æˆåŠŸï¼æ–°å¢ ${addedBookmarkCount} ä¸ªä¹¦ç­¾ï¼Œ${messageAdded ? 'ç•™è¨€å·²è¿½åŠ ' : 'ç•™è¨€æœªå˜åŒ–ï¼ˆé‡å¤æˆ–æ— æ–°å†…å®¹ï¼‰'}ã€‚`);
                    }
                    document.getElementById('import-file').value = '';
                } catch (error) {
                    console.error('å¯¼å…¥å¤±è´¥ï¼š', error);
                    alert(`å¯¼å…¥å¤±è´¥ï¼š${error.message}`);
                    document.getElementById('import-file').value = '';
                }
            };
            reader.onerror = () => {
                alert('è¯»å–æ–‡ä»¶å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ˜¯å¦æŸåã€‚');
                document.getElementById('import-file').value = '';
            };
            reader.readAsText(file);
        }

        // æ‹–æ‹½äº‹ä»¶å¤„ç†å™¨
        let dragSrcIndex = null;
        let dropTarget = null;

        function handleDragStart(e) {
            const card = e.target.closest('.bookmark-card');
            if (!card || state.isEditMode) return;
            dragSrcIndex = parseInt(card.dataset.index);
            card.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        }

        function handleDragOver(e) {
            if (state.isEditMode) return;
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
        }

        function handleDragEnter(e) {
            if (state.isEditMode) return;
            e.preventDefault();
            const target = e.target.closest('.bookmark-card');
            if (!target || target === document.querySelector('.dragging')) return;
            if (dropTarget && dropTarget !== target) dropTarget.classList.remove('drop-target');
            dropTarget = target;
            dropTarget.classList.add('drop-target');
        }

        function handleDragLeave(e) {
            if (state.isEditMode) return;
            const target = e.target.closest('.bookmark-card');
            if (!target || target !== dropTarget) return;
            const rect = target.getBoundingClientRect();
            const { clientX: x, clientY: y } = e;
            if (x < rect.left || x > rect.right || y < rect.top || y > rect.bottom) {
                target.classList.remove('drop-target');
                dropTarget = null;
            }
        }

        function handleDrop(e) {
            if (state.isEditMode) return;
            e.preventDefault();
            if (dragSrcIndex === null || !dropTarget) return;
            const dragTargetIndex = parseInt(dropTarget.dataset.index);
            if (dragSrcIndex === dragTargetIndex) return;

            const draggedItem = state.filteredBookmarks[dragSrcIndex];
            const globalSrcIndex = state.bookmarks.indexOf(draggedItem);
            const globalTargetIndex = state.bookmarks.indexOf(state.filteredBookmarks[dragTargetIndex]);
            if (globalSrcIndex === -1 || globalTargetIndex === -1) return;

            state.bookmarks.splice(globalSrcIndex, 1);
            state.bookmarks.splice(globalTargetIndex, 0, draggedItem);
            saveBookmarks();

            dropTarget.classList.remove('drop-target');
            dropTarget = null;
            dragSrcIndex = null;
        }

        function handleDragEnd(e) {
            if (state.isEditMode) return;
            const dragging = document.querySelector('.dragging');
            if (dragging) dragging.classList.remove('dragging');
            if (dropTarget) dropTarget.classList.remove('drop-target');
            dragSrcIndex = null;
            dropTarget = null;
        }

        let touchSrcIndex = null;

        function handleTouchStart(e) {
            if (state.isEditMode) return;
            const card = e.target.closest('.bookmark-card');
            if (!card) return;
            touchSrcIndex = parseInt(card.dataset.index);
            card.classList.add('dragging');
        }

        function handleTouchMove(e) {
            if (state.isEditMode) return;
            e.preventDefault();
            const touch = e.touches[0];
            const target = document.elementFromPoint(touch.clientX, touch.clientY)?.closest('.bookmark-card');
            if (!target || target === document.querySelector('.dragging')) return;
            if (dropTarget && dropTarget !== target) dropTarget.classList.remove('drop-target');
            dropTarget = target;
            dropTarget.classList.add('drop-target');
        }

        function handleTouchEnd() {
            if (state.isEditMode) return;
            if (touchSrcIndex === null || !dropTarget) return;
            const dragTargetIndex = parseInt(dropTarget.dataset.index);
            if (touchSrcIndex === dragTargetIndex) return;

            const draggedItem = state.filteredBookmarks[touchSrcIndex];
            const globalSrcIndex = state.bookmarks.indexOf(draggedItem);
            const globalTargetIndex = state.bookmarks.indexOf(state.filteredBookmarks[dragTargetIndex]);
            if (globalSrcIndex === -1 || globalTargetIndex === -1) return;

            state.bookmarks.splice(globalSrcIndex, 1);
            state.bookmarks.splice(globalTargetIndex, 0, draggedItem);
            saveBookmarks();

            document.querySelectorAll('.bookmark-card').forEach(card => card.classList.remove('dragging', 'drop-target'));
            touchSrcIndex = null;
            dropTarget = null;
        }

        // åˆå§‹åŒ–ä¸åŠ¨æ€è°ƒæ•´
        function handleResize() {
            renderBookmarks();
            if (state.isSidebarVisible) {
                const sidebar = document.getElementById('sidebar');
                const categoryBtn = document.getElementById('category-btn');
                if (sidebar && categoryBtn) {
                    const btnRect = categoryBtn.getBoundingClientRect();
                    const availableHeight = window.innerHeight - btnRect.bottom - 20;
                    sidebar.style.maxHeight = `${availableHeight}px`;
                }
            }
        }

        window.onload = () => {
            loadBookmarks();
            window.addEventListener('resize', debounce(handleResize, 100));
        };
    </script>
</body>
</html>