<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¹¦ç­¾ç®¡ç†å™¨</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #007bff;
            --secondary-color: #6c757d;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --background-color: #f4f6f8;
            --card-background: #ffffff;
            --text-color: #333;
            --border-radius: 10px;
            --box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            --transition: all 0.3s ease;
            --button-height: 28px;
            --card-height: 160px;
            --card-width: 230px;
            --card-padding: 10px;
            --title-font-size: 16px;
            --url-font-size: 12px;
            --desc-font-size: 14px;
            --content-spacing: 6px;
            --sidebar-width-narrow: 60px;
            --sidebar-width-wide: 150px;
            --toolbar-height: 60px;
        }

        body {
            font-family: 'Roboto', sans-serif;
            margin: 0;
            padding: 0;
            background: var(--background-color);
            color: var(--text-color);
            line-height: 1.5;
            letter-spacing: 0.5px;
            box-sizing: border-box;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        #toolbar {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background: #fff;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            padding: 10px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 15px;
            z-index: 1000;
            box-sizing: border-box;
            height: var(--toolbar-height);
        }

        #title {
            font-size: 18px;
            font-weight: 700;
            color: #333;
            margin: 0;
            flex-shrink: 0;
        }

        #toggle-sidebar-btn {
            margin-left: 10px;
            padding: 5px;
            width: 30px;
            height: var(--button-height);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.3s ease;
        }

        #controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
            flex-grow: 1;
            justify-content: flex-end;
        }

        button {
            padding: 5px 10px;
            border: 1px solid var(--primary-color);
            border-radius: var(--border-radius);
            background: #fff;
            color: var(--primary-color);
            font-size: 12px;
            cursor: pointer;
            transition: var(--transition);
            height: var(--button-height);
            display: flex;
            align-items: center;
            gap: 5px;
            box-sizing: border-box;
        }

        button:hover {
            background: var(--primary-color);
            color: white;
        }

        button:active {
            transform: scale(0.98);
        }

        .delete-btn {
            border-color: var(--danger-color);
            color: var(--danger-color);
        }

        .delete-btn:hover {
            background: var(--danger-color);
            color: white;
        }

        .batch-delete-btn {
            border-color: var(--danger-color);
            color: var(--danger-color);
        }

        .batch-delete-btn:hover {
            background: var(--danger-color);
            color: white;
        }

        #undo-btn {
            border-color: var(--success-color);
            color: var(--success-color);
        }

        #undo-btn:hover {
            background: var(--success-color);
            color: white;
        }

        #search {
            width: 150px;
            padding: 8px;
            border: 1px solid #ced4da;
            border-radius: var(--border-radius);
            font-size: 12px;
            transition: var(--transition);
            box-sizing: border-box;
        }

        #search:focus {
            border-color: var(--primary-color);
            outline: none;
        }

        #content-wrapper {
            display: flex;
            margin-top: var(--toolbar-height);
            height: calc(100vh - var(--toolbar-height));
        }

        #sidebar {
            width: var(--sidebar-width-narrow);
            background: var(--card-background);
            padding: 20px 10px;
            box-shadow: var(--box-shadow);
            overflow-y: auto;
            font-size: 14px;
            flex-shrink: 0;
            border-right: 1px solid #d1d5db;
            transition: width 0.3s ease;
            scrollbar-width: thin;
            scrollbar-color: #b0b0b0 #d3d3d3;
        }

        #sidebar.wide {
            width: var(--sidebar-width-wide);
            padding: 20px;
        }

        #sidebar::-webkit-scrollbar {
            width: 8px;
        }

        #sidebar::-webkit-scrollbar-thumb {
            background: #b0b0b0;
            border-radius: 4px;
            border: 2px solid #e9ecef;
        }

        #sidebar::-webkit-scrollbar-track {
            background: #d3d3d3;
            border-radius: 4px;
        }

        #sidebar h2 {
            margin: 0 0 15px;
            font-size: 16px;
            color: var(--text-color);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .category-item {
            padding: 8px 12px;
            margin: 5px 0;
            background: #ffffff;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
            text-align: left;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .category-item:hover {
            background: #d1d5db;
        }

        .category-item.active {
            background: var(--primary-color);
            color: white;
        }

        #main-content {
            flex-grow: 1;
            padding: 20px;
            box-sizing: border-box;
            overflow-y: auto;
            height: calc(100vh - var(--toolbar-height));
        }

        #main-content::-webkit-scrollbar {
            width: 4px;
        }

        #main-content::-webkit-scrollbar-thumb {
            background: #ccc;
            border-radius: 4px;
        }

        #tips {
            display: none;
            max-width: 1100px;
            margin: 0 auto 20px;
            padding: 15px 10px;
            border-left: 4px solid #ffca28;
            background: #fff8e1;
            border-radius: var(--border-radius);
            font-size: 14px;
            color: #856404;
            line-height: 1.6;
            position: relative;
            z-index: 1;
        }

        #container {
            max-width: 1100px;
            margin: 0 auto;
            box-sizing: border-box;
        }

        #stats {
            max-width: 1100px;
            margin: 20px auto;
            padding: 15px;
            background: #fff;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            font-size: 14px;
            color: var(--text-color);
            text-align: center;
        }

        #add-form, #view-bookmark-modal, #help-modal, #export-modal, #message-form, #welcome-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--card-background);
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 1000;
            width: 400px;
            box-sizing: border-box;
        }

        #welcome-modal {
            width: 500px;
        }

        #welcome-modal h3 {
            margin: 0 0 15px;
            font-size: 20px;
            color: var(--primary-color);
            text-align: center;
        }

        #welcome-content {
            font-size: 14px;
            color: var(--text-color);
            line-height: 1.6;
        }

        .step {
            margin: 10px 0;
        }

        .step strong {
            color: var(--primary-color);
        }

        #message-form {
            width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            padding: 25px;
            background: linear-gradient(135deg, #ffffff, #f9f9f9);
        }

        #message-form h3 {
            margin: 0 0 20px;
            font-size: 20px;
            color: var(--primary-color);
            text-align: center;
            font-weight: 500;
        }

        #message-form .form-group {
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        #message-form label {
            font-weight: 500;
            color: var(--text-color);
            font-size: 16px;
        }

        #message-form textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            min-height: 150px;
            background: #e9ecef;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
            transition: border-color 0.3s ease, background 0.3s ease;
        }

        #message-form textarea[readonly] {
            cursor: pointer;
        }

        #message-form textarea:not([readonly]) {
            background: #fff;
            border-color: var(--primary-color);
        }

        #message-form textarea:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 5px rgba(0,123,255,0.3);
            outline: none;
        }

        #message-form .form-buttons {
            display: flex;
            justify-content: space-between;
            gap: 15px;
        }

        #message-form button {
            flex: 1;
            padding: 10px;
            font-size: 14px;
            border-radius: 8px;
            height: 40px;
            transition: background-color 0.3s ease, transform 0.2s ease;
        }

        #message-form button:hover {
            transform: translateY(-2px);
        }

        #message-form #save-message-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            display: none;
        }

        #message-form #save-message-btn:hover {
            background: #0056b3;
        }

        #message-form #cancel-message-btn {
            background: #fff;
            color: var(--danger-color);
            border: 1px solid var(--danger-color);
            display: none;
        }

        #message-form #cancel-message-btn:hover {
            background: var(--danger-color);
            color: white;
        }

        #message-form #close-message-btn {
            background: #fff;
            color: var(--secondary-color);
            border: 1px solid var(--secondary-color);
        }

        #message-form #close-message-btn:hover {
            background: var(--secondary-color);
            color: white;
        }

        #help-modal {
            width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            padding: 25px;
            background: #fff;
        }

        #help-modal::-webkit-scrollbar {
            width: 4px;
        }

        #help-modal::-webkit-scrollbar-thumb {
            background: #ccc;
            border-radius: 4px;
        }

        #help-modal h3 {
            margin: 0 0 20px;
            font-size: 20px;
            color: var(--primary-color);
            text-align: center;
        }

        #help-modal h4 {
            margin: 20px 0 10px;
            font-size: 16px;
            color: var(--text-color);
            border-bottom: 1px solid #e9ecef;
            padding-bottom: 5px;
        }

        #help-modal p {
            margin: 0 0 10px;
            font-size: 14px;
            color: var(--text-color);
            line-height: 1.6;
        }

        #help-modal ul {
            margin: 0 0 10px 20px;
            padding: 0;
            list-style-type: disc;
        }

        #help-modal li {
            margin: 5px 0;
            font-size: 14px;
            color: var(--text-color);
        }

        #view-bookmark-modal #bookmark-details {
            max-height: 300px;
            overflow-y: auto;
        }

        #view-bookmark-modal #bookmark-details::-webkit-scrollbar {
            width: 6px;
        }

        #view-bookmark-modal #bookmark-details::-webkit-scrollbar-thumb {
            background: #ccc;
            border-radius: 3px;
        }

        #view-bookmark-modal #bookmark-details::-webkit-scrollbar-track {
            background: #f5f5f5;
        }

        .form-group {
            margin-bottom: 15px;
            display: flex;
            flex-wrap: wrap;
            align-items: baseline;
            gap: 5px;
        }

        .form-group label {
            font-weight: 500;
            color: var(--text-color);
            margin-right: 5px;
            min-width: 50px;
        }

        .form-group p {
            margin: 0;
            flex: 1;
            word-break: break-word;
        }

        input, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: var(--border-radius);
            font-size: 14px;
            box-sizing: border-box;
            transition: var(--transition);
        }

        input:focus, textarea:focus {
            border-color: var(--primary-color);
            outline: none;
        }

        textarea {
            resize: vertical;
            min-height: 80px;
        }

        .form-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .bookmark-grid {
            display: grid;
            gap: 16px;
            justify-content: center;
            width: 100%;
            box-sizing: border-box;
            grid-template-columns: repeat(auto-fill, minmax(var(--card-width), 1fr));
        }

        .bookmark-card {
            position: relative;
            height: var(--card-height);
            width: var(--card-width);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            cursor: default;
            overflow: hidden;
            padding: var(--card-padding);
            user-select: none;
            perspective: 1000px; /* æ·»åŠ  perspective åˆ°å¡ç‰‡å±‚ */ 
        }

        .bookmark-card.placeholder {
            visibility: hidden;
        }

        .bookmark-card.edit-mode {
            cursor: default;
        }

        .bookmark-card.dragging {
            opacity: 0.6;
            cursor: grabbing;
            border: 2px dashed #87CEFA;
            transition: transform 1s ease-out, opacity 1s ease, scale 1s ease;
        }

        .bookmark-card.drop-target {
            border: 2px dashed var(--primary-color);
            opacity: 0.9;
            box-shadow: 0 0 8px rgba(0, 123, 255, 0.5);
            transition: transform 1s ease-out, opacity 1s ease, scale 1s ease;
        }

        .bookmark-card.swapping {
            position: absolute;
            transition: transform 1s ease-out, opacity 1s ease, scale 1s ease;
            z-index: 10;
        }

        .main-card-container {
            position: relative;
            width: 100%;
            height: 100%;
            perspective: 1000px;
        }

        .main-card {
            width: 100%;
            height: 100%;
            position: absolute; /* ä½¿ç”¨ absolute ç¡®ä¿ç¿»è½¬ä¸å½±å“å¸ƒå±€ */
            top: 0;
            left: 0;
            transform-style: preserve-3d;
            transition: transform 0.6s ease;
        }

        .main-card.flipped {
            transform: rotateY(180deg);
        }

        .main-card-front, .main-card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            background: #fff;
            border: 1px solid #e5e7eb;
            border-radius: var(--border-radius);
            padding: var(--card-padding);
            box-sizing: border-box;
            backface-visibility: hidden;
            display: flex;
            flex-direction: column;
        }

        .main-card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            background: #fff;
            border: 1px solid #e5e7eb;
            border-radius: var(--border-radius);
            padding: var(--card-padding);
            box-sizing: border-box;
            backface-visibility: hidden;
            transform: rotateY(180deg);
            z-index: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .main-card-back .desc {
            font-size: 13px;
            color: #444;
            line-height: 1.5;
            margin: 0;
            white-space: pre-wrap;
            word-break: break-word;
            overflow-y: auto;
            flex-grow: 1;
            min-height: 0;
            scrollbar-width: thin;
            scrollbar-color: #ccc #f5f5f5;
        }

        .main-card-back .desc::-webkit-scrollbar {
            width: 6px;
        }

        .main-card-back .desc::-webkit-scrollbar-thumb {
            background: #ccc;
            border-radius: 3px;
        }

        .main-card-back .desc::-webkit-scrollbar-track {
            background: #f5f5f5;
        }

        .main-card-back .desc-title {
            color: #1e90ff; /* è“è‰² */
            font-weight: bold;
            font-size: 14px;
            margin-bottom: 5px;
        }

        .main-card-back .desc {
            font-size: 13px;
            color: #444;
            line-height: 1.5;
            margin: 0;
            white-space: pre-wrap;
            word-break: break-word;
        }

        .main-card-back .no-desc {
            color: #1e90ff; /* è“è‰² */
            font-size: 14px;
        }

        .bookmark-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            gap: 8px; /* ç»Ÿä¸€é—´è·ä¸º 8px */
        }

        .main-card-front h3 {
            margin: 0; /* ç§»é™¤é»˜è®¤å¤–è¾¹è·ï¼Œé—´è·ç”± gap æ§åˆ¶ */
            font-size: var(--title-font-size);
            font-weight: 600;
            line-height: 1.2;
            flex-shrink: 0;
            cursor: default;
        }

        .main-card-front p.url {
            margin: 0 0 4px 0; /* æ·»åŠ åº•éƒ¨é—´è· 4pxï¼Œæ€»é—´è·ä¸º 12px */
            font-size: 15px;
            color: #5a6470;
            line-height: 1.2;
            flex-shrink: 0;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
        }

        .main-card-front .desc-container {
            margin: 0; /* ç§»é™¤é»˜è®¤å¤–è¾¹è·ï¼Œé—´è·ç”± gap æ§åˆ¶ */
            flex-grow: 1;
            overflow: hidden;
        }

        .main-card-front h3 .title-text {
            transition: color 0.2s ease;
        }

        .main-card-front:not(.edit-mode) h3 .title-text:hover {
            color: var(--primary-color);
            cursor: pointer;
            text-decoration: underline;
        }


        .main-card-front .desc {
            font-size: var(--desc-font-size);
            color: #666;
            line-height: 1.3;
            margin: 0;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
        }

        .main-card-front .desc:empty::before {
            content: "æš‚æ— ç®€ä»‹";
            color: #b0b0b0;
        }

        .main-card-front a {
            color: var(--primary-color);
            text-decoration: none;
            pointer-events: none;
        }

        .main-card-front:hover a {
            pointer-events: auto;
        }

        .main-card-front a:hover {
            text-decoration: underline;
        }

        .main-card-front .action-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: var(--button-height);
            margin-top: auto;
        }

        .category-tag {
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 11px;
            color: #000;
            background-color: var(--secondary-color);
            max-width: 80px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            font-weight: 500;
        }

        .bookmark-checkbox {
            width: 14px;
            height: 14px;
            position: absolute;
            top: 6px;
            right: 6px;
            display: none;
            z-index: 10;
        }

        .bookmark-checkbox.visible {
            display: block;
        }

        .action-bar {
            position: relative;
            z-index: 50; /* ç¡®ä¿æ“ä½œæ åœ¨å¡ç‰‡å†…å®¹ä¹‹ä¸Š */
            pointer-events: auto; /* å…è®¸äº¤äº’ */
            dispiay: flex;
            align-items: center;
            justify-content: space-between; 
        }

        .action-buttons {
            display: flex;
            gap: 6px;
            align-items: center;
            position: relative; /* ç¡®ä¿æŒ‰é’®åœ¨é¡¶å±‚ */
            z-index: 51; /* æé«˜å±‚çº§ï¼Œé˜²æ­¢è¢«è¦†ç›– */ 
            pointer-events: auto;
        }

        .action-buttons button {
            padding: 3px 6px;
            font-size: 10px;
            min-width: 40px;
            border-radius: 5px;
            background: #fff;
            border: 1px solid var(--primary-color);
            color: var(--primary-color);
            cursor: pointer; /* æ˜ç¡®é¼ æ ‡æ ·å¼ */
            pointer-events: auto; /* å¼ºåˆ¶å…è®¸ç‚¹å‡» */
            position: relative;
            z-index: 52; /* ç¡®ä¿æŒ‰é’®å¯äº¤äº’ */
            transition: background 0.3s ease, color 0.3s ease;
        }

        .edit-mode .hover-area {
            pointer-events: none; /* ç¼–è¾‘æ¨¡å¼ä¸‹ç¦ç”¨ç¿»è½¬åŒºåŸŸ */
        }

        .main-card {
            position: relative;
            z-index: 10; /* ä½äºæŒ‰é’® */
            pointer-events: auto; /* ç¡®ä¿å¡ç‰‡æ•´ä½“å¯äº¤äº’ */
        }

        .main-card-front {
            pointer-events: auto; /* ç¡®ä¿æ­£é¢å¯äº¤äº’ */
            z-index: 2; 
        }

        .action-buttons button:hover {
            background: var(--primary-color);
            color: white;
        }

        .action-buttons .delete-btn {
            border-color: var(--danger-color);
            color: var(--danger-color);
        }

        .action-buttons .delete-btn:hover {
            background: var(--danger-color);
            color: white;
        }

        #view-bookmark-modal button, #export-modal button, #help-modal button, #message-form button, #welcome-modal button {
            margin: 10px 0;
            padding: 8px 12px;
            font-size: 12px;
            border-radius: var(--border-radius);
            background: #fff;
            color: var(--primary-color);
            border: 1px solid var(--primary-color);
        }

        #view-bookmark-modal button:hover, #export-modal button:hover, #help-modal button:hover, #welcome-modal button:hover {
            background: var(--primary-color);
            color: white;
        }

        #overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 999;
        }

        #pagination {
            max-width: 1100px;
            margin: 20px auto 0;
            display: flex;
            justify-content: center;
            gap: 10px;
            padding: 10px;
        }

        #pagination button {
            padding: 5px 12px;
            min-width: 30px;
            text-align: center;
        }

        #pagination button.active {
            background: var(--primary-color);
            color: white;
            border: 1px solid var(--primary-color);
        }

        #pagination button:disabled {
            border-color: #ced4da;
            color: #ced4da;
            cursor: not-allowed;
        }

        #pagination button:disabled:hover {
            background: #fff;
            color: #ced4da;
        }
        #sort-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--card-background);
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 1000;
            width: 300px;
            box-sizing: border-box;
        }

        #sort-modal h3 {
            margin: 0 0 15px;
            font-size: 18px;
            color: var(--primary-color);
            text-align: center;
        }

        #sort-modal button {
            display: flex; /* æ”¹ä¸º flex ä»¥æ§åˆ¶æ–‡å­—å¯¹é½ */
            justify-content: flex-start; /* æ¨ªå‘é å·¦ */
            align-items: center; /* çºµå‘å±…ä¸­ */
            width: 100%;
            margin: 10px 0;
            padding: 8px 12px;
            font-size: 12px;
            border-radius: var(--border-radius);
            background: #fff;
            color: #000; /* æ–‡å­—é¢œè‰²æ”¹ä¸ºé»‘è‰² */
            border: 1px solid var(--primary-color);
            transition: var(--transition);
            text-align: left; /* ç¡®ä¿æ–‡å­—å·¦å¯¹é½ */
        }

        #sort-modal button:hover {
            background: var(--primary-color);
            color: white; /* æ‚¬åœæ—¶æ–‡å­—ä»ä¸ºç™½è‰² */
        }

        .message-instructions, .export-tips {
            font-size: 12px;
            color: var(--secondary-color);
            margin-bottom: 15px;
            padding: 10px;
            background-color: #e9ecef;
            border-radius: var(--border-radius);
        }

        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: calc(100vh - var(--toolbar-height));
            text-align: center;
            color: var(--secondary-color);
            padding: 20px;
            position: relative;
            overflow: hidden;
        }

        .empty-state .cartoon-book {
            width: 150px;
            height: 150px;
            position: relative;
            margin-bottom: 30px;
        }

        .empty-state .cartoon-book .book-cover {
            position: absolute;
            width: 100px;
            height: 130px;
            background: #4dabf7;
            border-radius: 5px 15px 15px 5px;
            top: 10px;
            left: 25px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 2;
        }

        .empty-state .cartoon-book .book-spine {
            position: absolute;
            width: 15px;
            height: 130px;
            background: #339af0;
            top: 10px;
            left: 15px;
            z-index: 1;
        }

        .empty-state .cartoon-book .book-page {
            position: absolute;
            width: 90px;
            height: 120px;
            background: #fff;
            border-radius: 5px 10px 10px 5px;
            top: 15px;
            left: 30px;
            z-index: 3;
            animation: flip-page 2.5s infinite ease-in-out;
        }

        .empty-state .cartoon-book .bookmark {
            position: absolute;
            width: 15px;
            height: 40px;
            background: #f783ac;
            top: -5px;
            left: 60px;
            border-radius: 0 0 5px 5px;
            z-index: 4;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .empty-state .ribbons {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
        }

        .empty-state .ribbon {
            position: absolute;
            width: 20px;
            height: 100px;
            background: rgba(247, 131, 172, 0.7);
            border-radius: 5px;
            animation: float 6s infinite ease-in-out;
            transform-origin: center;
        }

        .empty-state .ribbon:nth-child(1) {
            left: 20%;
            top: 10%;
            animation-delay: 0s;
        }

        .empty-state .ribbon:nth-child(2) {
            left: 40%;
            top: 30%;
            animation-delay: 2s;
            background: rgba(77, 171, 247, 0.7);
        }

        .empty-state .ribbon:nth-child(3) {
            left: 60%;
            top: 20%;
            animation-delay: 4s;
            background: rgba(40, 167, 69, 0.7);
        }

        @keyframes flip-page {
            0%, 100% { transform: rotateY(0deg); }
            50% { transform: rotateY(-15deg); }
        }

        @keyframes float {
            0%, 100% {
                transform: translateY(0) rotate(5deg);
                opacity: 0.7;
            }
            50% {
                transform: translateY(-20px) rotate(-5deg);
                opacity: 1;
            }
        }

        .empty-state h2 {
            font-size: 24px;
            margin: 0 0 10px;
            color: var(--text-color);
            z-index: 1;
        }

        .empty-state p {
            font-size: 16px;
            margin: 0 0 20px;
            max-width: 500px;
            line-height: 1.6;
            z-index: 1;
        }

        .empty-state .button-group {
            display: flex;
            gap: 15px;
            z-index: 1;
        }

        .empty-state .action-btn {
            padding: 10px 20px;
            font-size: 14px;
            border-radius: var(--border-radius);
            background: var(--primary-color);
            color: white;
            border: none;
            cursor: pointer;
            transition: var(--transition);
        }

        .empty-state .action-btn:hover {
            background: #0056b3;
            transform: scale(1.05);
        }

        .empty-state .secondary-btn {
            background: #fff;
            color: var(--primary-color);
            border: 1px solid var(--primary-color);
        }

        .empty-state .secondary-btn:hover {
            background: var(--primary-color);
            color: white;
        }

        .hover-area {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 33%;
            z-index: 10;
            pointer-events: auto;
        }
    </style>
</head>
<body>
    <div id="toolbar">
        <div id="title">ä¹¦ç­¾ç®¡ç†å™¨</div>
        <button id="toggle-sidebar-btn" onclick="toggleSidebar()">â¤</button>
        <div id="controls">
            <button onclick="toggleAddForm(true)">â• æ·»åŠ ä¹¦ç­¾</button>
            <button id="edit-mode-btn" onclick="toggleEditMode()">âœï¸ ç¼–è¾‘ä¹¦ç­¾</button>
            <button id="done-btn" onclick="toggleEditMode()" style="display: none;">âœ… å®Œæˆ</button>
            <button onclick="showExportModal()">ğŸ“¤ å¯¼å‡ºä¹¦ç­¾</button>
            <button onclick="document.getElementById('import-file').click()">ğŸ“¥ å¯¼å…¥ä¹¦ç­¾</button>
            <input type="file" id="import-file" style="display: none;" accept=".json,.txt,.html" onchange="importBookmarks(event)">
            <button onclick="showHelpModal()">â“ ä½¿ç”¨å¸®åŠ©</button>
            <button onclick="toggleMessageForm()">ğŸ“ ç•™è¨€æ¿</button>
            <button id="delete-page-btn" class="delete-btn" onclick="deletePageBookmarks()">ğŸ—‘ï¸ åˆ é™¤æœ¬é¡µä¹¦ç­¾</button>
            <button id="batch-delete-btn" class="batch-delete-btn" onclick="batchDeleteBookmarks()" style="display: none;">ğŸ—‘ï¸ æ‰¹é‡åˆ é™¤</button>
            <button id="sort-btn" onclick="showSortModal()">ğŸ“ ä¹¦ç­¾æ’åº</button>
            <button id="undo-btn" onclick="undoDelete()" style="display: none;">â†©ï¸ æ’¤é”€</button>
            <input type="text" id="search" placeholder="æœç´¢ä¹¦ç­¾ï¼ˆåç§°ï¼‰" oninput="debounce(searchBookmarks, 300)()">
        </div>
    </div>
    <div id="loading-indicator" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(255, 255, 255, 0.9); padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); z-index: 2000;">
        <p>æ­£åœ¨åŠ è½½ä¹¦ç­¾ï¼Œè¯·ç¨å€™...</p>
    </div>
    <div id="content-wrapper">
        <div id="sidebar">
            <h2>åˆ†ç±»</h2>
            <div id="categories"></div>
        </div>
        <div id="main-content">
            <div id="tips">æ‚¨å¯ä»¥æ·»åŠ ã€ç¼–è¾‘ã€åˆ é™¤å’Œæ‹–åŠ¨æ’åºä¹¦ç­¾ã€‚ä½¿ç”¨â€œå¯¼å‡ºä¹¦ç­¾â€ä¿å­˜æ•°æ®åˆ° bookmarks.jsonã€txt æˆ– html æ–‡ä»¶ï¼Œhtml æ–‡ä»¶å¯ç›´æ¥å¯¼å…¥æµè§ˆå™¨ã€‚æ–‡ä»¶å°†ä¿å­˜åˆ°æ‚¨çš„ä¸‹è½½ç›®å½•ï¼Œè¯·æ‰‹åŠ¨ç§»åŠ¨åˆ°ç¨‹åºæ‰€åœ¨æ–‡ä»¶å¤¹ä¸ä»–äººåˆ†äº«ã€‚å¯¼å…¥æ—¶å°†æ–‡ä»¶æ”¾å…¥åŒä¸€ç›®å½•å¹¶ç‚¹å‡»â€œå¯¼å…¥ä¹¦ç­¾â€åŠ è½½ã€‚</div>
            <div id="container">
                <div id="bookmarks" class="bookmark-grid"></div>
            </div>
            <div id="stats"></div>
            <div id="pagination"></div>
        </div>
    </div>

    <div id="overlay" onclick="hideAllModals()"></div>
    <div id="view-bookmark-modal">
        <h3>ä¹¦ç­¾è¯¦æƒ…</h3>
        <div id="bookmark-details"></div>
        <button onclick="hideBookmarkModal()">å…³é—­</button>
    </div>
    <div id="help-modal">
        <h3>ä½¿ç”¨å¸®åŠ©</h3>
        <div id="help-content">
            <h4>ä»€ä¹ˆæ˜¯ä¹¦ç­¾ç®¡ç†å™¨ï¼Ÿ</h4>
            <p>è¿™æ˜¯ä¸€ä¸ªå¼ºå¤§çš„ç¦»çº¿ä¹¦ç­¾ç®¡ç†å·¥å…·ï¼Œå¸®åŠ©æ‚¨åœ¨æœ¬åœ°æ•´ç†ä¹¦ç­¾å’Œç•™è¨€ï¼Œæ— éœ€è”ç½‘å³å¯ä½¿ç”¨ã€‚æ”¯æŒåˆ†ç±»ç®¡ç†ã€æœç´¢ã€æ‹–åŠ¨æ’åºç­‰å¤šç§åŠŸèƒ½ï¼Œé€‚åˆä¸ªäººä½¿ç”¨æˆ–å›¢é˜Ÿå…±äº«ã€‚</p>

            <h4>ä¸»è¦åŠŸèƒ½</h4>
            <ul>
                <li><strong>æ·»åŠ ä¹¦ç­¾</strong>ï¼šç‚¹å‡»â€œæ·»åŠ ä¹¦ç­¾â€ï¼Œå¡«å†™åç§°ã€é“¾æ¥ï¼ˆå¯é€‰ï¼‰ã€ç®€ä»‹å’Œåˆ†ç±»ï¼ŒæŒ‰å›è½¦é”®æˆ–ç‚¹å‡»â€œä¿å­˜â€å¿«é€Ÿæ·»åŠ ã€‚</li>
                <li><strong>ç¼–è¾‘ä¸åˆ é™¤</strong>ï¼šè¿›å…¥â€œç¼–è¾‘ä¹¦ç­¾â€æ¨¡å¼ï¼Œå¯ä¿®æ”¹æˆ–åˆ é™¤ä¹¦ç­¾ï¼Œæ”¯æŒæ‰¹é‡åˆ é™¤æœ¬é¡µæˆ–é€‰ä¸­ä¹¦ç­¾ï¼Œå¹¶å¯æ’¤é”€æ“ä½œã€‚</li>
                <li><strong>æ‹–åŠ¨æ’åº</strong>ï¼šåœ¨éç¼–è¾‘æ¨¡å¼ä¸‹ï¼ŒæŒ‰ä½ä¹¦ç­¾å¡ç‰‡æ‹–åŠ¨åˆ°ç›®æ ‡ä½ç½®æ¾æ‰‹ï¼Œè°ƒæ•´é¡ºåºã€‚</li>
                <li><strong>åˆ†ç±»ç®¡ç†</strong>ï¼šå·¦ä¾§åˆ†ç±»æ å¯ç­›é€‰ä¹¦ç­¾ï¼Œç‚¹å‡»åˆ†ç±»åˆ‡æ¢æ˜¾ç¤ºå†…å®¹ã€‚</li>
                <li><strong>æœç´¢</strong>ï¼šåœ¨æœç´¢æ¡†è¾“å…¥ä¹¦ç­¾åç§°ï¼Œå®æ—¶ç­›é€‰åŒ¹é…ç»“æœã€‚</li>
                <li><strong>ç•™è¨€æ¿</strong>ï¼šåŒå‡»ç•™è¨€åŒºåŸŸç¼–è¾‘å†…å®¹ï¼Œå¯ç”¨äºè®°å½•ç¬”è®°ã€å¾…åŠäº‹é¡¹æˆ–å›¢é˜Ÿæ¶ˆæ¯ã€‚</li>
                <li><strong>å¯¼å‡ºä¸å¯¼å…¥</strong>ï¼š
                    <ul>
                        <li><strong>JSON</strong>ï¼šå®Œæ•´å¤‡ä»½ä¹¦ç­¾å’Œç•™è¨€ï¼Œæ¨èç”¨äºæ•°æ®è¿ç§»ã€‚</li>
                        <li><strong>TXT</strong>ï¼šçº¯æ–‡æœ¬æ ¼å¼ï¼Œä¾¿äºé˜…è¯»å’Œåˆ†äº«ã€‚</li>
                        <li><strong>HTML</strong>ï¼šæµè§ˆå™¨å…¼å®¹æ ¼å¼ï¼Œå¯ç›´æ¥å¯¼å…¥Chromeã€Edgeç­‰æµè§ˆå™¨ã€‚</li>
                    </ul>
                </li>
            </ul>

            <h4>æ“ä½œæç¤º</h4>
            <p>æ‰€æœ‰æ•°æ®å­˜å‚¨åœ¨æœ¬åœ°æµè§ˆå™¨ä¸­ï¼ˆlocalStorageï¼‰ï¼Œå®¹é‡æœ‰é™ï¼ˆçº¦4MBï¼‰ã€‚å»ºè®®å®šæœŸå¯¼å‡ºå¤‡ä»½ï¼Œé¿å…å› æ¸…ç©ºç¼“å­˜æˆ–æµè§ˆå™¨é™åˆ¶å¯¼è‡´æ•°æ®ä¸¢å¤±ã€‚</p>
            <p>å¿«æ·é”®æ”¯æŒï¼š
                <ul>
                    <li><strong>Ctrl + S</strong>ï¼šæ‰“å¼€æ·»åŠ ä¹¦ç­¾çª—å£ã€‚</li>
                    <li><strong>Enter</strong>ï¼šåœ¨æ·»åŠ /ç¼–è¾‘ä¹¦ç­¾çª—å£ä¸­å¿«é€Ÿä¿å­˜ã€‚</li>
                    <li><strong>Esc</strong>ï¼šå…³é—­æ‰€æœ‰å¼¹çª—å¹¶é€€å‡ºç¼–è¾‘æ¨¡å¼ã€‚</li>
                </ul>
            </p>

            <h4>ä½¿ç”¨ç¤ºä¾‹</h4>
            <p><strong>åœºæ™¯1ï¼šä¸ªäººæ”¶è—</strong><br>å°†å¸¸ç”¨ç½‘ç«™ï¼ˆå¦‚â€œGitHubâ€ï¼‰æ·»åŠ ä¹¦ç­¾ï¼Œåˆ†ç±»ä¸ºâ€œå¼€å‘å·¥å…·â€ï¼Œæ·»åŠ ç®€ä»‹â€œä»£ç æ‰˜ç®¡å¹³å°â€ã€‚é€šè¿‡æœç´¢â€œGitâ€å¿«é€Ÿæ‰¾åˆ°ã€‚</p>
            <p><strong>åœºæ™¯2ï¼šå›¢é˜Ÿå…±äº«</strong><br>å¯¼å‡ºä¹¦ç­¾ä¸ºJSONæ–‡ä»¶ï¼Œæ”¾å…¥å…±äº«æ–‡ä»¶å¤¹ï¼Œå›¢é˜Ÿæˆå‘˜å¯¼å…¥åå³å¯ä½¿ç”¨ç›¸åŒä¹¦ç­¾é›†ã€‚ç•™è¨€æ¿å¯è®°å½•æ›´æ–°æ—¥å¿—ã€‚</p>

            <h4>å¸¸è§é—®é¢˜</h4>
            <ul>
                <li><strong>å¦‚ä½•åˆ†äº«ä¹¦ç­¾ï¼Ÿ</strong> å¯¼å‡ºåå°†æ–‡ä»¶æ‰‹åŠ¨ç§»åŠ¨åˆ°ç¨‹åºæ–‡ä»¶å¤¹æˆ–äº‘ç›˜ï¼Œä¸ä»–äººå…±äº«ã€‚</li>
                <li><strong>å¯¼å…¥å¤±è´¥æ€ä¹ˆåŠï¼Ÿ</strong> æ£€æŸ¥æ–‡ä»¶æ ¼å¼ï¼ˆä»…æ”¯æŒ .jsonã€.txtã€.htmlï¼‰æ˜¯å¦æ­£ç¡®ï¼Œç¡®ä¿æ–‡ä»¶æœªæŸåã€‚</li>
                <li><strong>ä¹¦ç­¾æ— æ³•æ‹–åŠ¨ï¼Ÿ</strong> ç¡®ä¿ä¸åœ¨ç¼–è¾‘æ¨¡å¼ï¼ˆç‚¹å‡»â€œå®Œæˆâ€é€€å‡ºï¼‰ï¼Œç„¶åæŒ‰ä½å¡ç‰‡æ‹–åŠ¨ã€‚</li>
                <li><strong>æ•°æ®ä¸¢å¤±æ€ä¹ˆåŠï¼Ÿ</strong> æ£€æŸ¥æ˜¯å¦æ¸…ç©ºäº†æµè§ˆå™¨ç¼“å­˜ï¼Œå»ºè®®æ¢å¤å‰å¯¼å‡ºçš„å¤‡ä»½æ–‡ä»¶ã€‚</li>
            </ul>

            <h4>é«˜çº§æŠ€å·§</h4>
            <p>
                - <strong>æ‰¹é‡æ•´ç†</strong>ï¼šè¿›å…¥ç¼–è¾‘æ¨¡å¼ï¼Œå‹¾é€‰å¤šå¼ å¡ç‰‡åæ‰¹é‡åˆ é™¤ï¼ŒèŠ‚çœæ—¶é—´ã€‚<br>
                - <strong>è‡ªå®šä¹‰åˆ†ç±»</strong>ï¼šæ·»åŠ ä¹¦ç­¾æ—¶è¾“å…¥æ–°åˆ†ç±»åï¼Œè‡ªåŠ¨åˆ›å»ºæ–°åˆ†ç»„ã€‚<br>
                - <strong>å¿«é€Ÿæµè§ˆ</strong>ï¼šé¼ æ ‡æ‚¬åœå¡ç‰‡åº•éƒ¨ä¸‰åˆ†ä¹‹ä¸€åŒºåŸŸï¼Œç¿»è½¬æŸ¥çœ‹å®Œæ•´ç®€ä»‹ã€‚
            </p>
        </div>
        <button onclick="hideHelpModal()">å…³é—­</button>
    </div>
    <div id="export-modal">
        <h3>å¯¼å‡ºä¹¦ç­¾å’Œç•™è¨€</h3>
        <div class="form-group">
            <label>æ–‡ä»¶å:</label>
            <input type="text" id="export-filename" placeholder="bookmarks_YYYY.MM.DD">
        </div>
        <button onclick="exportBookmarks('json')">å¯¼å‡ºä¸º JSON (æ¨èï¼Œå®Œæ•´å¤‡ä»½å«ä¹¦ç­¾å’Œç•™è¨€)</button>
        <button onclick="exportBookmarks('txt')">å¯¼å‡ºä¸º TXT (ä»…ä¹¦ç­¾å’Œç•™è¨€ï¼Œé€‚åˆé˜…è¯»)</button>
        <button onclick="exportBookmarks('html')">å¯¼å‡ºä¸º HTML (ä»…ä¹¦ç­¾ï¼Œå¯å¯¼å…¥æµè§ˆå™¨)</button>
        <p class="export-tips">æç¤ºï¼šæ–‡ä»¶å°†ä¿å­˜åˆ°æ‚¨çš„ä¸‹è½½ç›®å½•ã€‚å»ºè®®ä½¿ç”¨ JSON æ ¼å¼è¿›è¡Œå®Œæ•´å¤‡ä»½ï¼ŒHTML é€‚åˆä¸æµè§ˆå™¨å…±äº«ï¼ŒTXT ä¾¿äºæŸ¥çœ‹ä½†ä¸æ”¯æŒå¯¼å…¥ã€‚</p>
    </div>
    <div id="sort-modal">
        <h3>ä¹¦ç­¾æ’åº</h3>
        <button onclick="applySort('added-desc')">æŒ‰æ·»åŠ æ—¥æœŸï¼ˆæ–°åˆ°æ—§ï¼‰</button>
        <button onclick="applySort('added-asc')">æŒ‰æ·»åŠ æ—¥æœŸï¼ˆæ—§åˆ°æ–°ï¼‰</button>
        <button onclick="applySort('title-asc')">æŒ‰æ ‡é¢˜ï¼ˆA-Zï¼‰</button>
        <button onclick="applySort('title-desc')">æŒ‰æ ‡é¢˜ï¼ˆZ-Aï¼‰</button>
        <button onclick="hideSortModal()">âŒ å…³é—­</button>
    </div>
    <div id="add-form">
        <h3>æ·»åŠ /ç¼–è¾‘ä¹¦ç­¾</h3>
        <div class="form-group">
            <label>åç§°:</label>
            <input type="text" id="name" placeholder="è¯·è¾“å…¥ä¹¦ç­¾åç§°">
        </div>
        <div class="form-group">
            <label>é“¾æ¥:</label>
            <input type="text" id="url" placeholder="è¯·è¾“å…¥é“¾æ¥ (å¯é€‰ï¼Œå¦‚ https://example.com)">
        </div>
        <div class="form-group">
            <label>ç®€ä»‹:</label>
            <textarea id="desc" placeholder="è¯·è¾“å…¥ç®€ä»‹ï¼ˆå¯é€‰ï¼‰"></textarea>
        </div>
        <div class="form-group">
            <label>åˆ†ç±»:</label>
            <input type="text" id="category" list="category-list" placeholder="è¾“å…¥æˆ–é€‰æ‹©åˆ†ç±»">
            <datalist id="category-list"></datalist>
        </div>
        <div class="form-buttons">
            <button onclick="saveBookmark()">ğŸ’¾ ä¿å­˜</button>
            <button onclick="toggleAddForm(false)">âŒ å–æ¶ˆ</button>
        </div>
    </div>
    <div id="message-form">
        <h3>ç¼–è¾‘ç•™è¨€æ¿</h3>
        <p class="message-instructions">æç¤ºï¼šåŒå‡»ä¸‹æ–¹æ–‡æœ¬åŒºåŸŸå³å¯ç¼–è¾‘ç•™è¨€ï¼Œä¿å­˜åå¯åœ¨ä¸‹æ¬¡æ‰“å¼€æ—¶æŸ¥çœ‹ã€‚æ‰€æœ‰ç•™è¨€å­˜å‚¨åœ¨æœ¬åœ°ï¼Œå®šæœŸå¯¼å‡ºå¤‡ä»½ä»¥é˜²ä¸¢å¤±ã€‚</p>
        <div class="form-group">
            <label>ç•™è¨€å†…å®¹</label>
            <textarea id="message-input" placeholder="åŒå‡»æ­¤å¤„ç¼–è¾‘ç•™è¨€..." readonly></textarea>
        </div>
        <div class="form-buttons">
            <button id="save-message-btn" onclick="saveMessage()">ä¿å­˜</button>
            <button id="cancel-message-btn" onclick="cancelMessageEdit()">å–æ¶ˆ</button>
            <button id="close-message-btn" onclick="hideAllModals()">âŒ å…³é—­</button>
        </div>
    </div>
    <div id="welcome-modal">
        <h3>æ¬¢è¿ä½¿ç”¨ä¹¦ç­¾ç®¡ç†å™¨</h3>
        <div id="welcome-content">
            <p>è¿™æ˜¯ä¸€ä¸ªç¦»çº¿ä¹¦ç­¾ç®¡ç†å·¥å…·ï¼Œå¸®åŠ©æ‚¨æ•´ç†ä¹¦ç­¾å’Œç•™è¨€ï¼Œéšæ—¶éšåœ°ä½¿ç”¨ï¼Œæ— éœ€è”ç½‘ã€‚</p>
            <div class="step">
                <strong>å¼€å§‹ä½¿ç”¨ï¼š</strong> ç‚¹å‡»é¡¶éƒ¨å·¥å…·æ çš„â€œâ• æ·»åŠ ä¹¦ç­¾â€åˆ›å»ºæ‚¨çš„ç¬¬ä¸€ä¸ªä¹¦ç­¾ï¼Œæˆ–é€šè¿‡â€œğŸ“¥ å¯¼å…¥ä¹¦ç­¾â€åŠ è½½å·²æœ‰æ•°æ®ã€‚
            </div>
            <div class="step">
                <strong>åŠŸèƒ½æ¦‚è§ˆï¼š</strong> æ”¯æŒç¼–è¾‘ã€åˆ é™¤ã€æ‹–åŠ¨æ’åºã€åˆ†ç±»ç®¡ç†ã€æœç´¢ä»¥åŠç•™è¨€æ¿åŠŸèƒ½ï¼Œæ•°æ®å¯å¯¼å‡ºä¸º JSONã€TXT æˆ– HTML æ ¼å¼ã€‚
            </div>
            <div class="step">
                <strong>æ¸©é¦¨æç¤ºï¼š</strong> æ•°æ®å­˜å‚¨åœ¨æœ¬åœ°æµè§ˆå™¨ä¸­ï¼Œå»ºè®®å®šæœŸé€šè¿‡â€œğŸ“¤ å¯¼å‡ºä¹¦ç­¾â€å¤‡ä»½ï¼Œé˜²æ­¢å› æ¸…ç©ºç¼“å­˜ä¸¢å¤±ã€‚
            </div>
            <div class="step">
                <strong>äº†è§£æ›´å¤šï¼š</strong> ç‚¹å‡»â€œâ“ ä½¿ç”¨å¸®åŠ©â€æŸ¥çœ‹è¯¦ç»†è¯´æ˜ã€‚
            </div>
        </div>
        <div class="form-buttons">
            <button onclick="hideWelcomeModal()">æˆ‘çŸ¥é“å•¦</button>
        </div>
    </div>

    <script>
        const state = {
            bookmarks: [],
            message: '',
            lastDeletedBookmark: null,
            lastDeletedIndex: null,
            filteredBookmarks: [],
            selectedCategory: 'å…¨éƒ¨',
            editingIndex: null,
            isEditMode: false,
            selectedBookmarks: [],
            currentPage: 1,
            isFirstRun: !localStorage.getItem('hasRunBefore'),
            categories: new Set(),
            isRendering: false,
            isImporting: false
        };

        const MAX_BOOKMARKS = 1000;
        const MAX_STORAGE_SIZE = 4 * 1024 * 1024;

        // åˆå§‹åŒ–ä¹¦ç­¾èƒŒæ™¯
        function initializeBookmarkBackgrounds() {
            let updated = false;
            state.bookmarks.forEach(bookmark => {
                if (!bookmark.background) {
                    bookmark.background = getRandomGradient();
                    updated = true;
                }
            });
            if (updated) {
                saveBookmarks();
            }
        }

        // ä¿å­˜æ•°æ®åˆ° localStorage
        function saveToLocalStorage() {
                try {
                        const data = {
                                bookmarks: state.bookmarks,
                                message: state.message
                        };
                        const serializedData = JSON.stringify(data);
                        if (serializedData.length > MAX_STORAGE_SIZE) {
                                alert('æ•°æ®é‡è¿‡å¤§ï¼Œæ— æ³•ä¿å­˜ã€‚è¯·åˆ é™¤éƒ¨åˆ†ä¹¦ç­¾æˆ–ç•™è¨€åå†è¯•ã€‚');
                                return false;
                        }
                        localStorage.setItem('bookmarkData', serializedData);
                        return true;
                } catch (e) {
                        console.error('ä¿å­˜æ•°æ®å¤±è´¥ï¼š', e);
                        alert('ä¿å­˜æ•°æ®å¤±è´¥ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨å­˜å‚¨ç©ºé—´æˆ–æƒé™ã€‚');
                        return false;
                }
        }

        // åŠ è½½ä¹¦ç­¾åè°ƒç”¨
        loadBookmarks();
        initializeBookmarkBackgrounds();

        function debounce(func, wait) {
            let timeout;
            return function (...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        function getRandomGradient() {
                const colors = [
                        '#FFD1DC', // æµ…ç²‰è‰²
                        '#B9E4C9', // æµ…ç»¿è‰²
                        '#C9E4FF', // æµ…è“è‰²
                        '#FFF3B0', // æµ…é»„è‰²
                        '#E6D7FF'  // æµ…ç´«è‰²
                ];
                const angle = Math.floor(Math.random() * 360);
                const color1 = colors[Math.floor(Math.random() * colors.length)];
                let color2 = colors[Math.floor(Math.random() * colors.length)];
                while (color2 === color1) {
                        color2 = colors[Math.floor(Math.random() * colors.length)];
                }
                return `linear-gradient(${angle}deg, ${color1}, ${color2})`;
        }

        function generateRandomCircle() {
                const canvas = document.createElement('canvas');
                canvas.width = 16;
                canvas.height = 16;
                const ctx = canvas.getContext('2d');

                // ä½¿ç”¨æµ…è‰²æ•°ç»„ï¼ˆä¸ getRandomGradient ä¸€è‡´ï¼‰
                const colors = [
                        '#FFD1DC', // æµ…ç²‰è‰²
                        '#B9E4C9', // æµ…ç»¿è‰²
                        '#C9E4FF', // æµ…è“è‰²
                        '#FFF3B0', // æµ…é»„è‰²
                        '#E6D7FF'  // æµ…ç´«è‰²
                ];
                const randomColor = colors[Math.floor(Math.random() * colors.length)];

                // ç»˜åˆ¶åœ†å½¢
                ctx.beginPath();
                ctx.arc(8, 8, 8, 0, Math.PI * 2); // åœ†å¿ƒ (8, 8)ï¼ŒåŠå¾„ 8
                ctx.fillStyle = randomColor;
                ctx.fill();

                // è¿”å› Base64 æ ¼å¼çš„å›¾ç‰‡ URL
                return canvas.toDataURL('image/png');
        }

        async function fetchFavicon(url) {
                try {
                        const urlObj = new URL(url);
                        const hostname = urlObj.hostname;

                        // å°è¯• 1ï¼šç›´æ¥è·å–ç½‘ç«™çš„ favicon.ico
                        const defaultFavicon = `https://${hostname}/favicon.ico`;
                        let response = await fetch(defaultFavicon, { method: 'HEAD' });
                        if (response.ok) {
                                return defaultFavicon;
                        }

                        // å°è¯• 2ï¼šé€šè¿‡é¡µé¢ HTML è·å– Favicon
                        const proxyUrl = `https://corsproxy.io/?${encodeURIComponent(url)}`;
                        response = await fetch(proxyUrl);
                        const html = await response.text();
                        const parser = new DOMParser();
                        const doc = parser.parseFromString(html, 'text/html');
                        const faviconLink = doc.querySelector('link[rel="icon"], link[rel="shortcut icon"]');
                        if (faviconLink && faviconLink.href) {
                                let favicon = faviconLink.href;
                                if (!favicon.startsWith('http')) {
                                        favicon = new URL(favicon, url).href;
                                }
                                return favicon;
                        }

                        // å°è¯• 3ï¼šä½¿ç”¨ Google Favicon æœåŠ¡ï¼ˆå¤‡ç”¨æ–¹æ¡ˆï¼‰
                        const googleFavicon = `https://www.google.com/s2/favicons?domain=${hostname}`;
                        response = await fetch(googleFavicon, { method: 'HEAD' });
                        if (response.ok) {
                                return googleFavicon;
                        }

                        return null;
                } catch (err) {
                        console.warn(`Failed to fetch favicon for ${url}:`, err);
                        return null;
                }
        }

        function getCategoryColor(category) {
            const colors = [
                '#FFB6C1', '#87CEFA', '#98FB98', '#FFDAB9', '#E6E6FA',
                '#F0E68C', '#DDA0DD', '#B0E0E6', '#F08080', '#C0C0C0'
            ];
            const index = category.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0) % colors.length;
            return colors[index];
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'block';
                document.getElementById('overlay').style.display = 'block';
            }
        }

        function hideModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'none';
                document.getElementById('overlay').style.display = 'none';
            }
        }

        function hideAllModals() {
            ['view-bookmark-modal', 'help-modal', 'add-form', 'export-modal', 'message-form', 'welcome-modal', 'sort-modal'].forEach(id => {
                hideModal(id);
            });
            state.editingIndex = null;
            const messageInput = document.getElementById('message-input');
            if (messageInput) {
                messageInput.setAttribute('readonly', 'readonly');
                messageInput.value = state.message;
                document.getElementById('save-message-btn').style.display = 'none';
                document.getElementById('cancel-message-btn').style.display = 'none';
                document.getElementById('close-message-btn').style.display = 'block';
            }
        }

        function saveBookmark() {
                const nameInput = document.getElementById('name');
                const urlInput = document.getElementById('url');
                const descInput = document.getElementById('desc');
                const categoryInput = document.getElementById('category');

                const name = nameInput.value.trim();
                const url = urlInput.value.trim();
                const desc = descInput.value.trim();
                const category = categoryInput.value.trim() || 'é»˜è®¤åˆ†ç»„';

                if (!name || !url) {
                        alert('ä¹¦ç­¾åç§°å’Œ URL ä¸èƒ½ä¸ºç©ºï¼');
                        return;
                }

                // ç¡®ä¿ URL åŒ…å«åè®®
                const formattedUrl = url.startsWith('http://') || url.startsWith('https://') ? url : `https://${url}`;

                try {
                        new URL(formattedUrl); // éªŒè¯ URL æ ¼å¼
                } catch (e) {
                        console.error('Invalid URL:', e);
                        alert('è¯·è¾“å…¥æœ‰æ•ˆçš„ URLï¼');
                        return;
                }

                const bookmark = {
                        name,
                        url: formattedUrl,
                        desc,
                        category,
                        background: getRandomGradient(),
                        added: Date.now(),
                        favicon: null // åˆå§‹è®¾ä¸º nullï¼Œåç»­å¼‚æ­¥è·å–
                };

                if (state.editingIndex !== null && state.editingIndex < state.filteredBookmarks.length) {
                        const globalIndex = state.bookmarks.indexOf(state.filteredBookmarks[state.editingIndex]);
                        if (globalIndex !== -1) {
                                state.bookmarks[globalIndex] = bookmark;
                        }
                } else {
                        state.bookmarks.push(bookmark);
                }

                if (saveToLocalStorage()) {
                        filterBookmarks();
                        renderBookmarks();
                        toggleAddForm(false);
                        nameInput.value = '';
                        urlInput.value = '';
                        descInput.value = '';
                        categoryInput.value = '';
                }
        }

        // åŠ è½½ä¹¦ç­¾
        function loadBookmarks() {
                const loadingIndicator = document.getElementById('loading-indicator');
                if (loadingIndicator) loadingIndicator.style.display = 'block';

                try {
                        const storedData = localStorage.getItem('bookmarkData');
                        if (!storedData) {
                                state.bookmarks = [];
                                state.message = '';
                        } else {
                                const data = JSON.parse(storedData);
                                if (!data || typeof data !== 'object') {
                                        throw new Error('å­˜å‚¨æ•°æ®æ ¼å¼ä¸æ­£ç¡®');
                                }
                                state.bookmarks = Array.isArray(data.bookmarks) ? data.bookmarks.map(b => ({
                                        name: b.name || 'æœªå‘½å',
                                        url: b.url || '',
                                        desc: b.desc || '',
                                        category: b.category || 'é»˜è®¤åˆ†ç»„',
                                        background: b.background || getRandomGradient(),
                                        added: b.added || Date.now(),
                                        favicon: b.favicon || null // ç¡®ä¿ favicon å±æ€§å­˜åœ¨
                                })) : [];
                                state.message = typeof data.message === 'string' ? data.message : '';
                        }
                        filterBookmarks();
                        renderCategories();
                        renderBookmarks();
                } catch (e) {
                        console.error('åŠ è½½æ•°æ®å¤±è´¥ï¼š', e);
                        state.bookmarks = [];
                        state.message = '';
                        filterBookmarks();
                        renderCategories();
                        renderBookmarks();
                } finally {
                        if (loadingIndicator) loadingIndicator.style.display = 'none';
                }
        }

        function filterBookmarks() {
            const query = document.getElementById('search')?.value.toLowerCase() || '';
            state.filteredBookmarks = state.selectedCategory === 'å…¨éƒ¨'
                ? state.bookmarks.filter(b => b.name.toLowerCase().includes(query))
                : state.bookmarks.filter(b => b.category === state.selectedCategory && b.name.toLowerCase().includes(query));
            state.currentPage = 1;
            renderBookmarks();
        }

        function renderCategories() {
            const container = document.getElementById('categories');
            if (!container) return;
            const categories = ['å…¨éƒ¨', ...new Set(state.bookmarks.map(b => b.category).filter(cat => cat))];
            container.innerHTML = '';
            categories.forEach(cat => {
                const div = document.createElement('div');
                div.className = `category-item${cat === state.selectedCategory ? ' active' : ''}`;
                div.textContent = cat;
                div.title = cat;
                div.onclick = () => selectCategory(cat);
                container.appendChild(div);
            });
            updateCategoryList(categories);
        }

        function updateCategoryFilter() {
            renderCategories();
        }

        function updateCategoryList(categories) {
            const datalist = document.getElementById('category-list');
            if (!datalist) return;
            datalist.innerHTML = '';
            categories.filter(cat => cat !== 'å…¨éƒ¨').forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                datalist.appendChild(option);
            });
        }

        function updateCategoryFilter() {
            renderCategories();
        }

        function getItemsPerPage() {
            return 24;
        }

        // æ¸²æŸ“ä¹¦ç­¾
        function renderBookmarks() {
                if (state.isRendering || state.isImporting) return;
                state.isRendering = true;

                const loadingIndicator = document.getElementById('loading-indicator');
                if (loadingIndicator) loadingIndicator.style.display = 'block';

                try {
                        requestAnimationFrame(() => {
                                const container = document.getElementById('bookmarks');
                                const tips = document.getElementById('tips');
                                if (!container || !tips) {
                                        console.error('Container or tips element not found');
                                        return;
                                }

                                container.innerHTML = '';
                                container.className = 'bookmark-grid';

                                const itemsPerPage = getItemsPerPage();
                                const startIndex = (state.currentPage - 1) * itemsPerPage;
                                const endIndex = Math.min(startIndex + itemsPerPage, state.filteredBookmarks.length);
                                const visibleBookmarks = state.filteredBookmarks.slice(startIndex, endIndex);

                                if (state.filteredBookmarks.length === 0) {
                                        container.className = 'empty-state';
                                        container.innerHTML = `
                                            <div class="ribbons">
                                                <div class="ribbon"></div>
                                                <div class="ribbon"></div>
                                                <div class="ribbon"></div>
                                            </div>
                                            <div class="cartoon-book">
                                                <div class="book-spine"></div>
                                                <div class="book-cover"></div>
                                                <div class="book-page"></div>
                                                <div class="bookmark"></div>
                                            </div>
                                            <h2>æ¬¢è¿ä½¿ç”¨ä¹¦ç­¾ç®¡ç†å™¨</h2>
                                            <p>ç›®å‰è¿˜æ²¡æœ‰ä¹¦ç­¾ï¼Œå¿«æ¥æ·»åŠ ä½ çš„ç¬¬ä¸€ä¸ªä¹¦ç­¾å§ï¼æˆ–è€…å¯¼å…¥å·²æœ‰ä¹¦ç­¾ï¼Œå¿«é€Ÿå¼€å§‹ç®¡ç†ã€‚</p>
                                            <div class="button-group">
                                                <button class="action-btn" onclick="toggleAddForm(true)">â• æ·»åŠ ä¹¦ç­¾</button>
                                                <button class="action-btn secondary-btn" onclick="document.getElementById('import-file').click()">ğŸ“¥ å¯¼å…¥ä¹¦ç­¾</button>
                                            </div>
                                        `;
                                        tips.style.display = 'none';
                                        document.getElementById('pagination').style.display = 'none';
                                        document.getElementById('stats').style.display = 'none';
                                } else {
                                        tips.style.display = 'block';
                                        visibleBookmarks.forEach((bookmark, index) => {
                                                const div = document.createElement('div');
                                                div.className = `bookmark-card${state.isEditMode ? ' edit-mode' : ''}`;
                                                div.dataset.index = startIndex + index;
                                                div.style.background = bookmark.background || getRandomGradient();

                                                const displayName = bookmark.name.length > 10 ? bookmark.name.substring(0, 10) + '...' : bookmark.name;
                                                const displayCategory = bookmark.category.length > 10 ? bookmark.category.substring(0, 10) + '...' : bookmark.category;
                                                const globalIndex = state.bookmarks.indexOf(bookmark);

                                                // åˆå§‹æ˜¾ç¤ºéšæœºåœ†å½¢å›¾æ ‡
                                                const placeholderFavicon = generateRandomCircle();

                                                const backContent = bookmark.desc
                                                        ? `<span class="desc-title">ä¹¦ç­¾ç®€ä»‹</span><p class="desc">${escapeHtml(bookmark.desc)}</p>`
                                                        : `<span class="no-desc">æ­¤ä¹¦ç­¾æš‚æ— ç®€ä»‹</span>`;

                                                div.innerHTML = `
                                                    <div class="main-card-container">
                                                        <div class="main-card">
                                                            <div class="main-card-front">
                                                                <div class="bookmark-content">
                                                                    <h3>
                                                                        <img src="${bookmark.favicon || placeholderFavicon}" class="favicon" alt="favicon" data-url="${escapeHtml(bookmark.url)}">
                                                                        <span class="title-text" data-index="${startIndex + index}">${escapeHtml(displayName)}</span>
                                                                        <input type="checkbox" class="bookmark-checkbox${state.isEditMode ? ' visible' : ''}" data-global-index="${globalIndex}">
                                                                    </h3>
                                                                    <p class="url"><a href="${escapeHtml(bookmark.url)}" target="_blank">${escapeHtml(bookmark.url)}</a></p>
                                                                    <div class="desc-container">
                                                                        <p class="desc">${escapeHtml(bookmark.desc)}</p>
                                                                    </div>
                                                                </div>
                                                                <div class="action-bar">
                                                                    <span class="category-tag">${escapeHtml(displayCategory)}</span>
                                                                    <div class="action-buttons" style="${state.isEditMode ? 'display: flex;' : 'display: none;'}">
                                                                        <button class="edit-btn" data-index="${startIndex + index}">âœï¸ ç¼–è¾‘</button>
                                                                        <button class="delete-btn" data-index="${startIndex + index}">ğŸ—‘ï¸ åˆ é™¤</button>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            <div class="main-card-back">
                                                                ${backContent}
                                                            </div>
                                                        </div>
                                                        <div class="hover-area"></div>
                                                    </div>
                                                `;

                                                const categoryTag = div.querySelector('.category-tag');
                                                categoryTag.style.backgroundColor = getCategoryColor(bookmark.category);
                                                container.appendChild(div);

                                                // å¼‚æ­¥åŠ è½½ Faviconï¼ˆå¦‚æœå°šæœªåŠ è½½ï¼‰
                                                if (!bookmark.favicon) {
                                                        (async () => {
                                                                const favicon = await fetchFavicon(bookmark.url);
                                                                bookmark.favicon = favicon || generateRandomCircle();
                                                                const img = div.querySelector('.favicon');
                                                                if (img) {
                                                                        img.src = bookmark.favicon;
                                                                }
                                                                saveToLocalStorage();
                                                        })();
                                                }
                                        });

                                        // ç§»é™¤æ—§çš„äº‹ä»¶ç›‘å¬å™¨
                                        container.removeEventListener('click', container.clickHandler);
                                        container.removeEventListener('mouseenter', container.mouseEnterHandler);
                                        container.removeEventListener('mouseleave', container.mouseLeaveHandler);

                                        // å®šä¹‰äº‹ä»¶å¤„ç†å™¨
                                        container.clickHandler = (e) => {
                                                const target = e.target;
                                                if (target.classList.contains('title-text')) {
                                                        showBookmarkDetails(parseInt(target.dataset.index));
                                                } else if (target.classList.contains('edit-btn')) {
                                                        editBookmark(parseInt(target.dataset.index));
                                                } else if (target.classList.contains('delete-btn')) {
                                                        deleteBookmark(parseInt(target.dataset.index));
                                                } else if (state.isEditMode && target.closest('.bookmark-card')) {
                                                        const checkbox = target.closest('.bookmark-card').querySelector('.bookmark-checkbox');
                                                        if (checkbox && !target.closest('.action-buttons')) {
                                                                checkbox.checked = !checkbox.checked;
                                                                toggleBookmarkSelection(parseInt(checkbox.dataset.globalIndex), checkbox.checked);
                                                        }
                                                }
                                        };
                                        container.mouseEnterHandler = (e) => {
                                                if (!state.isEditMode && e.target.classList.contains('hover-area')) {
                                                        const mainCard = e.target.previousElementSibling;
                                                        if (mainCard) mainCard.classList.add('flipped');
                                                }
                                        };
                                        container.mouseLeaveHandler = (e) => {
                                                if (!state.isEditMode && e.target.closest('.bookmark-card')) {
                                                        const card = e.target.closest('.bookmark-card');
                                                        const mainCard = card.querySelector('.main-card');
                                                        if (mainCard && !card.contains(e.relatedTarget)) {
                                                                mainCard.classList.remove('flipped');
                                                        }
                                                }
                                        };

                                        container.addEventListener('click', container.clickHandler);
                                        container.addEventListener('mouseenter', container.mouseEnterHandler, true);
                                        container.addEventListener('mouseleave', container.mouseLeaveHandler, true);

                                        renderPagination();
                                        updateStats();
                                }
                        });
                } finally {
                        state.isRendering = false;
                        if (loadingIndicator) loadingIndicator.style.display = 'none';
                }
        }
       
        function addBookmark(name, url, category, desc) {
            const newBookmark = {
                name: name.trim(),
                url: url.trim(),
                category: category.trim() || 'é»˜è®¤åˆ†ç»„',
                desc: desc.trim(),
                background: getRandomGradient(),
                added: Date.now() // æ·»åŠ æ—¶é—´æˆ³
            };
            state.bookmarks.push(newBookmark);
            state.categories.add(newBookmark.category);
            saveBookmarks();
            filterBookmarks();
            renderBookmarks();
            updateCategoryFilter();
        }

        function renderPagination() {
                const container = document.getElementById('pagination');
                if (!container) return;
                container.innerHTML = '';
                const itemsPerPage = getItemsPerPage();
                const totalPages = Math.max(1, Math.ceil(state.filteredBookmarks.length / itemsPerPage));

                if (state.bookmarks.length <= 12 || state.filteredBookmarks.length === 0) {
                        container.style.display = 'none';
                        return;
                }
                container.style.display = 'flex';

                const prevBtn = document.createElement('button');
                prevBtn.textContent = 'Â«';
                prevBtn.disabled = state.currentPage === 1;
                prevBtn.onclick = () => {
                        if (state.currentPage > 1) {
                                state.currentPage--;
                                renderBookmarks();
                        }
                };
                container.appendChild(prevBtn);

                const maxVisiblePages = 5;
                let startPage = Math.max(1, state.currentPage - Math.floor(maxVisiblePages / 2));
                let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
                if (endPage - startPage + 1 < maxVisiblePages) {
                        startPage = Math.max(1, endPage - maxVisiblePages + 1);
                }

                for (let i = startPage; i <= endPage; i++) {
                        const pageBtn = document.createElement('button');
                        pageBtn.textContent = i;
                        pageBtn.classList.toggle('active', i === state.currentPage);
                        pageBtn.onclick = () => {
                                state.currentPage = i;
                                renderBookmarks();
                        };
                        container.appendChild(pageBtn);
                }

                const nextBtn = document.createElement('button');
                nextBtn.textContent = 'Â»';
                nextBtn.disabled = state.currentPage === totalPages;
                nextBtn.onclick = () => {
                        if (state.currentPage < totalPages) {
                                state.currentPage++;
                                renderBookmarks();
                        }
                };
                container.appendChild(nextBtn);
        }

        function updateStats() {
                const statsDiv = document.getElementById('stats');
                if (!statsDiv) return;
                const totalBookmarks = state.bookmarks.length;
                const totalCategories = new Set(state.bookmarks.map(b => b.category).filter(cat => cat)).size;
                const itemsPerPage = getItemsPerPage();
                const visibleCards = Math.min(state.filteredBookmarks.length - (state.currentPage - 1) * itemsPerPage, itemsPerPage);
                const totalVisibleCards = state.filteredBookmarks.length;
                statsDiv.textContent = `æ€»ä¹¦ç­¾æ•°ï¼š${totalBookmarks} | æ€»åˆ†ç»„æ•°ï¼š${totalCategories} | å½“å‰é¡µæ˜¾ç¤ºä¹¦ç­¾å¡ç‰‡æ•°ï¼š${visibleCards} | æ€»ç­›é€‰ä¹¦ç­¾æ•°ï¼š${totalVisibleCards}`;
                statsDiv.style.display = totalBookmarks > 12 && state.filteredBookmarks.length > 0 ? 'block' : 'none';
        }

        function selectCategory(category) {
            state.selectedCategory = category;
            filterBookmarks();
            renderBookmarks();
            updateStats();
            renderCategories();
        }

        function toggleAddForm(show) {
            const form = document.getElementById('add-form');
            if (!form) return;
            if (show) {
                showModal('add-form');
            } else {
                hideModal('add-form');
                state.editingIndex = null;
                document.getElementById('name').value = '';
                document.getElementById('url').value = '';
                document.getElementById('desc').value = '';
                document.getElementById('category').value = '';
            }
        }

        function saveBookmark() {
            const nameInput = document.getElementById('name');
            const urlInput = document.getElementById('url');
            const descInput = document.getElementById('desc');
            const categoryInput = document.getElementById('category');
            if (!nameInput || !urlInput) return;

            const name = nameInput.value.trim();
            const url = urlInput.value.trim();
            const desc = descInput.value.trim();
            const category = categoryInput.value.trim();

            if (!name) {
                alert('è¯·å¡«å†™ä¹¦ç­¾åç§°');
                return;
            }

            if (state.editingIndex !== null && state.editingIndex < state.filteredBookmarks.length) {
                const globalIndex = state.bookmarks.indexOf(state.filteredBookmarks[state.editingIndex]);
                if (globalIndex !== -1) {
                    state.bookmarks[globalIndex] = {
                        name,
                        url,
                        desc,
                        category: category || 'é»˜è®¤åˆ†ç»„',
                        background: state.bookmarks[globalIndex].background
                    };
                    saveBookmarks();
                }
            } else {
                addBookmark(name, url, category, desc);
            }
            toggleAddForm(false);
        }

        function editBookmark(index) {
            const bookmark = state.filteredBookmarks[index];
            if (!bookmark) return;
            const nameInput = document.getElementById('name');
            const urlInput = document.getElementById('url');
            const descInput = document.getElementById('desc');
            const categoryInput = document.getElementById('category');
            if (!nameInput || !urlInput || !descInput || !categoryInput) return;

            nameInput.value = bookmark.name;
            urlInput.value = bookmark.url;
            descInput.value = bookmark.desc;
            categoryInput.value = bookmark.category;
            state.editingIndex = index;
            toggleAddForm(true);
        }

        function deleteBookmark(index) {
                const bookmarkToDelete = state.filteredBookmarks[index];
                const globalIndex = state.bookmarks.indexOf(bookmarkToDelete);
                if (globalIndex === -1) {
                        console.error(`Bookmark at index ${index} not found in state.bookmarks`);
                        return;
                }

                if (window.confirm('ç¡®å®šè¦åˆ é™¤æ­¤ä¹¦ç­¾å—ï¼Ÿ')) {
                        console.log(`Deleting bookmark at global index ${globalIndex}`);
                        state.bookmarks.splice(globalIndex, 1);
                        if (saveToLocalStorage()) {
                                filterBookmarks();
                                renderBookmarks();
                        }
                }
        }

        function deletePageBookmarks() {
            const itemsPerPage = getItemsPerPage();
            const startIndex = (state.currentPage - 1) * itemsPerPage;
            const endIndex = Math.min(startIndex + itemsPerPage, state.filteredBookmarks.length);
            
            if (endIndex <= startIndex) return;
            
            if (!confirm(`ç¡®å®šè¦åˆ é™¤æœ¬é¡µ ${endIndex - startIndex} ä¸ªä¹¦ç­¾å—ï¼Ÿ`)) return;
            
            const deletedBookmarks = [];
            const globalIndices = [];
            
            for (let i = startIndex; i < endIndex; i++) {
                const globalIndex = state.bookmarks.indexOf(state.filteredBookmarks[i]);
                if (globalIndex !== -1) {
                    deletedBookmarks.push({ bookmark: { ...state.bookmarks[globalIndex] }, index: globalIndex });
                    globalIndices.push(globalIndex);
                }
            }
            
            globalIndices.sort((a, b) => b - a).forEach(index => {
                state.bookmarks.splice(index, 1);
            });
            
            state.lastDeletedBookmark = deletedBookmarks;
            state.lastDeletedIndex = null;
            state.selectedBookmarks = [];
            
            filterBookmarks();
            saveBookmarks();
        }

        function toggleBookmarkSelection(globalIndex, isChecked) {
            if (isChecked) {
                if (!state.selectedBookmarks.includes(globalIndex)) state.selectedBookmarks.push(globalIndex);
            } else {
                state.selectedBookmarks = state.selectedBookmarks.filter(idx => idx !== globalIndex);
            }
            updateControlButtons();
        }

        function updateControlButtons() {
            const batchDeleteBtn = document.getElementById('batch-delete-btn');
            const deletePageBtn = document.getElementById('delete-page-btn');
            if (batchDeleteBtn && deletePageBtn) {
                if (state.isEditMode && state.selectedBookmarks.length > 0) {
                    batchDeleteBtn.style.display = 'inline-flex';
                    deletePageBtn.style.display = 'none';
                } else {
                    batchDeleteBtn.style.display = 'none';
                    deletePageBtn.style.display = 'inline-flex';
                }
            }
        }

        function batchDeleteBookmarks() {
                if (!confirm(`ç¡®å®šè¦åˆ é™¤ ${state.selectedBookmarks.length} ä¸ªé€‰ä¸­çš„ä¹¦ç­¾å—ï¼Ÿ`)) return;
                const deletedBookmarks = [];
                state.selectedBookmarks.sort((a, b) => b - a);
                state.selectedBookmarks.forEach(index => {
                        deletedBookmarks.push({ bookmark: { ...state.bookmarks[index] }, index });
                        state.bookmarks.splice(index, 1);
                });
                state.lastDeletedBookmark = deletedBookmarks;
                state.lastDeletedIndex = null;
                state.selectedBookmarks = [];
                if (saveToLocalStorage()) {
                        toggleEditMode();
                }
        }

        function undoDelete() {
            if (!state.lastDeletedBookmark) return;
            if (Array.isArray(state.lastDeletedBookmark)) {
                state.lastDeletedBookmark.sort((a, b) => a.index - b.index);
                state.lastDeletedBookmark.forEach(({ bookmark, index }) => {
                    state.bookmarks.splice(index, 0, bookmark);
                });
            } else if (state.lastDeletedIndex !== null) {
                state.bookmarks.splice(state.lastDeletedIndex, 0, state.lastDeletedBookmark);
            }
            state.lastDeletedBookmark = null;
            state.lastDeletedIndex = null;
            filterBookmarks();
            saveBookmarks();
        }

        function toggleEditMode() {
                state.isEditMode = !state.isEditMode;
                state.selectedBookmarks = []; // é‡ç½®é€‰ä¸­çŠ¶æ€
                const editModeBtn = document.getElementById('edit-mode-btn');
                const doneBtn = document.getElementById('done-btn');
                const batchDeleteBtn = document.getElementById('batch-delete-btn');
                const deletePageBtn = document.getElementById('delete-page-btn');
                if (editModeBtn) editModeBtn.style.display = state.isEditMode ? 'none' : 'inline-flex';
                if (doneBtn) doneBtn.style.display = state.isEditMode ? 'inline-flex' : 'none';
                if (batchDeleteBtn) batchDeleteBtn.style.display = 'none';
                if (deletePageBtn) deletePageBtn.style.display = state.isEditMode ? 'none' : 'inline-flex';
                renderBookmarks();
                updateControlButtons();
        }

        function showBookmarkDetails(index) {
            const bookmark = state.filteredBookmarks[index];
            if (!bookmark) return;
            const details = document.getElementById('bookmark-details');
            if (!details) return;
            details.innerHTML = `
                <div class="form-group"><label>åç§°:</label><p>${escapeHtml(bookmark.name)}</p></div>
                <div class="form-group"><label>é“¾æ¥:</label><p><a href="${escapeHtml(bookmark.url)}" target="_blank">${escapeHtml(bookmark.url)}</a></p></div>
                <div class="form-group"><label>ç®€ä»‹:</label><p>${escapeHtml(bookmark.desc) || 'æ— '}</p></div>
                <div class="form-group"><label>åˆ†ç±»:</label><p>${escapeHtml(bookmark.category) || 'æ— '}</p></div>
            `;
            showModal('view-bookmark-modal');
        }

        function hideBookmarkModal() {
            hideModal('view-bookmark-modal');
        }

        function showHelpModal() {
            showModal('help-modal');
        }

        function hideHelpModal() {
            hideModal('help-modal');
        }

        function showExportModal() {
            const filenameInput = document.getElementById('export-filename');
            if (filenameInput) {
                filenameInput.value = `bookmarks_${new Date().toISOString().slice(0,10).replace(/-/g, '.')}`;
            }
            showModal('export-modal');
        }

        function toggleMessageForm() {
            const form = document.getElementById('message-form');
            if (!form) return;
            if (form.style.display === 'block') {
                hideAllModals();
            } else {
                const messageInput = document.getElementById('message-input');
                if (messageInput) {
                    messageInput.value = state.message;
                    messageInput.setAttribute('readonly', 'readonly');
                }
                document.getElementById('save-message-btn').style.display = 'none';
                document.getElementById('cancel-message-btn').style.display = 'none';
                document.getElementById('close-message-btn').style.display = 'block';
                showModal('message-form');
            }
        }

        document.getElementById('message-input')?.addEventListener('dblclick', function() {
            if (this.hasAttribute('readonly')) {
                this.removeAttribute('readonly');
                this.focus();
                document.getElementById('save-message-btn').style.display = 'block';
                document.getElementById('cancel-message-btn').style.display = 'block';
                document.getElementById('close-message-btn').style.display = 'none';
            }
        });

        function saveMessage() {
                const messageInput = document.getElementById('message-input');
                if (!messageInput) return;
                state.message = messageInput.value.trim();
                if (saveToLocalStorage()) hideAllModals();
        }

        function cancelMessageEdit() {
            hideAllModals();
        }

        function showWelcomeModal() {
            showModal('welcome-modal');
        }

        function hideWelcomeModal() {
            hideModal('welcome-modal');
            localStorage.setItem('hasRunBefore', 'true');
            state.isFirstRun = false;
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const toggleBtn = document.getElementById('toggle-sidebar-btn');
            if (!sidebar || !toggleBtn) return;

            sidebar.classList.toggle('wide');
            toggleBtn.textContent = sidebar.classList.contains('wide') ? 'â¤' : 'â—„';
            toggleBtn.style.transform = sidebar.classList.contains('wide') ? 'rotate(180deg)' : 'rotate(0deg)';
        }

        function searchBookmarks() {
            filterBookmarks();
            renderBookmarks();
            updateStats();
        }

        function exportBookmarks(format) {
            const filenameInput = document.getElementById('export-filename');
            if (!filenameInput) return;
            const filename = `${filenameInput.value.trim() || 'bookmarks'}.${format}`;
            let content, type;

            try {
                if (format === 'json') {
                    content = JSON.stringify({ bookmarks: state.bookmarks, message: state.message }, null, 2);
                    type = 'application/json';
                } else if (format === 'txt') {
                    content = `ç•™è¨€æ¿:\n${state.message || 'æ— '}\n------------------------\n` +
                        state.bookmarks.map((b, i) => `${i + 1}.\nåç§°: ${b.name}\né“¾æ¥: ${b.url}\nç®€ä»‹: ${b.desc || 'æ— '}\nåˆ†ç±»: ${b.category || 'æ— '}\n------------------------`).join('\n');
                    type = 'text/plain';
                } else if (format === 'html') {
                    const categories = {};
                    state.bookmarks.forEach(b => {
                        const cat = b.category || '';
                        if (!categories[cat]) categories[cat] = [];
                        categories[cat].push(b);
                    });

                    const now = Math.floor(Date.now() / 1000);
                    content = `<!DOCTYPE NETSCAPE-Bookmark-file-1>
<!-- This is an automatically generated file.
     It will be read and overwritten.
     DO NOT EDIT! -->
<META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=UTF-8">
<TITLE>Bookmarks</TITLE>
<H1>Bookmarks</H1>
<DL><p>`;
                    for (const [cat, items] of Object.entries(categories)) {
                        content += `\n    <DT><H3 ADD_DATE="${now}" LAST_MODIFIED="${now}">${escapeHtml(cat || 'é»˜è®¤åˆ†ç»„')}</H3>\n    <DL><p>`;
                        items.forEach(b => {
                            content += `\n        <DT><A HREF="${escapeHtml(b.url)}" ADD_DATE="${now}" LAST_MODIFIED="${now}">${escapeHtml(b.name)}</A>`;
                            if (b.desc) content += `\n        <DD>${escapeHtml(b.desc)}</DD>`;
                        });
                        content += `\n    </DL><p>`;
                    }
                    content += `\n</DL><p>`;
                    type = 'text/html';
                } else {
                    alert('ä¸æ”¯æŒçš„å¯¼å‡ºæ ¼å¼');
                    return;
                }

                const blob = new Blob([content], { type });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = filename;
                link.click();
                URL.revokeObjectURL(url);
                hideAllModals();
            } catch (e) {
                console.error('å¯¼å‡ºå¤±è´¥ï¼š', e);
                alert(`å¯¼å‡ºå¤±è´¥ï¼š${e.message}`);
            }
        }

        // å¯¼å…¥ä¹¦ç­¾
        function importBookmarks(event) {
                const file = event.target.files[0];
                if (!file) return;

                const loadingIndicator = document.getElementById('loading-indicator');
                if (loadingIndicator) {
                        loadingIndicator.style.display = 'block';
                        loadingIndicator.textContent = 'æ­£åœ¨å¯¼å…¥ä¹¦ç­¾ (0%)';
                }

                const lastImportedFile = localStorage.getItem('lastImportedFile');
                if (lastImportedFile === file.name && !confirm(`æ‚¨å·²å†æ¬¡å¯¼å…¥ç›¸åŒçš„æ–‡ä»¶â€œ${file.name}â€ï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ`)) {
                        document.getElementById('import-file').value = '';
                        if (loadingIndicator) loadingIndicator.style.display = 'none';
                        return;
                }

                const reader = new FileReader();
                reader.onload = async function(e) {
                        try {
                                let importedBookmarks = [];
                                let importedMessage = '';

                                if (file.name.endsWith('.html')) {
                                        const parser = new DOMParser();
                                        const doc = parser.parseFromString(e.target.result, 'text/html');
                                        const dlElements = doc.getElementsByTagName('DL');
                                        if (!dlElements.length) throw new Error('æ— æ•ˆçš„HTMLä¹¦ç­¾æ–‡ä»¶');

                                        function parseBookmarks(node, categoryStack = []) {
                                                Array.from(node.children).forEach(child => {
                                                        if (child.tagName === 'H3') {
                                                                const folderName = child.textContent.trim() || '';
                                                                categoryStack.push(folderName);
                                                                const nextDL = child.nextElementSibling;
                                                                if (nextDL && nextDL.tagName === 'DL') {
                                                                        parseBookmarks(nextDL, categoryStack);
                                                                }
                                                                categoryStack.pop();
                                                        } else if (child.tagName === 'DT') {
                                                                const aTag = child.querySelector('A');
                                                                if (aTag) {
                                                                        const url = aTag.getAttribute('HREF') || '';
                                                                        const name = aTag.textContent.trim() || 'æœªå‘½å';
                                                                        const nextSibling = child.nextElementSibling;
                                                                        const desc = (nextSibling && nextSibling.tagName === 'DD') ? nextSibling.textContent.trim() : '';
                                                                        const currentCategory = categoryStack.length > 0 ? categoryStack[categoryStack.length - 1] : '';
                                                                        importedBookmarks.push({
                                                                                name,
                                                                                url,
                                                                                desc,
                                                                                category: currentCategory || 'é»˜è®¤åˆ†ç»„',
                                                                                background: getRandomGradient(),
                                                                                added: Date.now(),
                                                                                favicon: null
                                                                        });
                                                                }
                                                        } else if (child.tagName === 'DL') {
                                                                parseBookmarks(child, categoryStack);
                                                        }
                                                });
                                        }
                                        Array.from(dlElements).forEach(dl => parseBookmarks(dl, []));
                                } else {
                                        throw new Error('ä»…æ”¯æŒ HTML æ ¼å¼å¯¼å…¥');
                                }

                                const chunkSize = 50;
                                let addedCount = 0;
                                let currentIndex = 0;
                                state.isImporting = true;

                                const tempBookmarks = [...state.bookmarks];

                                // å¼‚æ­¥è·å– Favicon
                                for (let bookmark of importedBookmarks) {
                                        if (bookmark.url) {
                                                bookmark.favicon = await fetchFavicon(bookmark.url);
                                        }
                                }

                                function processChunk() {
                                        if (currentIndex >= importedBookmarks.length) {
                                                if (importedMessage && importedMessage !== state.message) {
                                                        state.message = state.message ? `${state.message}\n${importedMessage}` : importedMessage;
                                                }

                                                state.bookmarks = tempBookmarks;
                                                if (saveToLocalStorage()) {
                                                        localStorage.setItem('lastImportedFile', file.name);
                                                        state.isImporting = false;
                                                        filterBookmarks();
                                                        renderBookmarks();
                                                        alert(`æˆåŠŸå¯¼å…¥ ${addedCount} ä¸ªæ–°ä¹¦ç­¾`);
                                                }

                                                document.getElementById('import-file').value = '';
                                                if (loadingIndicator) {
                                                        loadingIndicator.textContent = 'æ­£åœ¨å¯¼å…¥ä¹¦ç­¾ (100%)';
                                                        setTimeout(() => loadingIndicator.style.display = 'none', 500);
                                                }
                                                return;
                                        }

                                        const end = Math.min(currentIndex + chunkSize, importedBookmarks.length);
                                        const chunk = importedBookmarks.slice(currentIndex, end);
                                        chunk.forEach(newBookmark => {
                                                if (!newBookmark.name) return;
                                                if (!tempBookmarks.some(b => b.url === newBookmark.url && b.name === newBookmark.name)) {
                                                        tempBookmarks.push(newBookmark);
                                                        addedCount++;
                                                }
                                        });

                                        const progress = Math.min(99, Math.round((currentIndex / importedBookmarks.length) * 100));
                                        if (loadingIndicator) {
                                                loadingIndicator.textContent = `æ­£åœ¨å¯¼å…¥ä¹¦ç­¾ (${progress}%)`;
                                        }

                                        currentIndex += chunkSize;
                                        setTimeout(processChunk, 10);
                                }

                                processChunk();
                        } catch (error) {
                                console.error('å¯¼å…¥å¤±è´¥ï¼š', error);
                                alert(`å¯¼å…¥å¤±è´¥ï¼š${error.message}`);
                                document.getElementById('import-file').value = '';
                                state.isImporting = false;
                                if (loadingIndicator) loadingIndicator.style.display = 'none';
                        }
                };
                reader.onerror = function(e) {
                        console.error('æ–‡ä»¶è¯»å–å¤±è´¥ï¼š', e);
                        alert('æ–‡ä»¶è¯»å–å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ˜¯å¦æœ‰æ•ˆ');
                        document.getElementById('import-file').value = '';
                        state.isImporting = false;
                        if (loadingIndicator) loadingIndicator.style.display = 'none';
                };
                reader.readAsText(file);
        }

        let dragSrcIndex = null;
        let dropTarget = null;

        function handleDragStart(e) {
            const card = e.target.closest('.bookmark-card');
            if (!card || state.isEditMode) {
                console.log('Drag start aborted: Edit mode is active or invalid card');
                return;
            }
            dragSrcIndex = parseInt(card.dataset.index);
            card.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            console.log(`Drag start on card ${dragSrcIndex}`);
        }

        function handleDragOver(e) {
            if (state.isEditMode || dragSrcIndex === null) {
                console.log('Drag over aborted: Edit mode active or no dragged index');
                return;
            }
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';

            const target = e.target.closest('.bookmark-card');
            if (!target || target.classList.contains('dragging')) return;

            if (dropTarget && dropTarget !== target) {
                dropTarget.classList.remove('drop-target');
            }
            dropTarget = target;
            dropTarget.classList.add('drop-target');
            console.log(`Drag over card ${dropTarget.dataset.index}`);
        }

        function handleDragEnter(e) {
            if (state.isEditMode) return;
            e.preventDefault();
        }

        function handleDragLeave(e) {
            if (state.isEditMode) return;
            const target = e.target.closest('.bookmark-card');
            if (!target || target !== dropTarget) return;
            const rect = target.getBoundingClientRect();
            const { clientX: x, clientY: y } = e;
            if (x < rect.left || x > rect.right || y < rect.top || y > rect.bottom) {
                target.classList.remove('drop-target');
                dropTarget = null;
            }
        }

        function handleDrop(e) {
            if (state.isEditMode || dragSrcIndex === null || !dropTarget) {
                console.log('Drop aborted: Edit mode active, no dragged index, or no target');
                return;
            }
            e.preventDefault();

            const dragTargetIndex = parseInt(dropTarget.dataset.index);
            if (dragSrcIndex === dragTargetIndex) {
                console.log('Drop aborted: Same index');
                return;
            }

            console.log(`Dropping card ${dragSrcIndex} onto card ${dragTargetIndex}`);

            const draggedCard = document.querySelector(`.bookmark-card[data-index="${dragSrcIndex}"]`);
            const targetCard = dropTarget;

            // åŠ¨ç”»æ•ˆæœ
            const draggedRect = draggedCard.getBoundingClientRect();
            const targetRect = targetCard.getBoundingClientRect();
            const dx = targetRect.left - draggedRect.left;
            const dy = targetRect.top - draggedRect.top;

            draggedCard.style.position = 'absolute';
            draggedCard.style.left = `${draggedRect.left}px`;
            draggedCard.style.top = `${draggedRect.top}px`;
            draggedCard.style.width = `${draggedRect.width}px`;
            draggedCard.style.zIndex = '100';
            targetCard.style.position = 'absolute';
            targetCard.style.left = `${targetRect.left}px`;
            targetCard.style.top = `${targetRect.top}px`;
            targetCard.style.width = `${targetRect.width}px`;
            targetCard.style.zIndex = '100';

            draggedCard.classList.add('swapping');
            targetCard.classList.add('swapping');
            requestAnimationFrame(() => {
                draggedCard.style.transform = `translate(${dx}px, ${dy}px) scale(1.05) rotate(3deg)`;
                targetCard.style.transform = `translate(${-dx}px, ${-dy}px) scale(1.05) rotate(-3deg)`;
                draggedCard.style.opacity = '0.8';
                targetCard.style.opacity = '0.8';
            });

            // æ›´æ–°ä¹¦ç­¾æ•°ç»„
            const draggedItem = state.filteredBookmarks[dragSrcIndex];
            const globalSrcIndex = state.bookmarks.indexOf(draggedItem);
            const globalTargetIndex = state.bookmarks.indexOf(state.filteredBookmarks[dragTargetIndex]);
            if (globalSrcIndex !== -1 && globalTargetIndex !== -1) {
                state.bookmarks.splice(globalSrcIndex, 1);
                state.bookmarks.splice(globalTargetIndex, 0, draggedItem);
            }

            setTimeout(() => {
                requestAnimationFrame(() => {
                    draggedCard.style.transform = 'translate(0, 0) scale(1) rotate(0deg)';
                    targetCard.style.transform = 'translate(0, 0) scale(1) rotate(0deg)';
                    draggedCard.style.opacity = '1';
                    targetCard.style.opacity = '1';

                    draggedCard.classList.remove('swapping', 'dragging');
                    targetCard.classList.remove('swapping', 'drop-target');
                    draggedCard.style.position = '';
                    draggedCard.style.left = '';
                    draggedCard.style.top = '';
                    draggedCard.style.width = '';
                    draggedCard.style.zIndex = '';
                    draggedCard.style.transform = '';
                    targetCard.style.position = '';
                    targetCard.style.left = '';
                    targetCard.style.top = '';
                    targetCard.style.width = '';
                    targetCard.style.zIndex = '';
                    targetCard.style.transform = '';

                    saveBookmarks();
                });
            }, 1000);
        }

        function handleDragEnd(e) {
            console.log('Drag end');
            document.querySelectorAll('.bookmark-card').forEach(card => {
                card.classList.remove('dragging', 'drop-target', 'swapping');
                card.style.transform = '';
                card.style.position = '';
                card.style.left = '';
                card.style.top = '';
                card.style.width = '';
                card.style.zIndex = '';
            });
            dragSrcIndex = null;
            dropTarget = null;
        }

        // æ˜¾ç¤ºæ’åºå¼¹çª—
        function showSortModal() {
            showModal('sort-modal');
        }

        // éšè—æ’åºå¼¹çª—
        function hideSortModal() {
            hideModal('sort-modal');
        }

        // åº”ç”¨æ’åº
        function applySort(sortValue) {
            // æ·»åŠ æ—¶é—´æˆ³ï¼ˆå¦‚æœç¼ºå¤±åˆ™ä½¿ç”¨å½“å‰æ—¶é—´ï¼‰
            state.filteredBookmarks.forEach(b => {
                if (!b.added) b.added = Date.now();
            });

            if (sortValue === 'added-desc') {
                state.filteredBookmarks.sort((a, b) => (b.added || 0) - (a.added || 0));
            } else if (sortValue === 'added-asc') {
                state.filteredBookmarks.sort((a, b) => (a.added || 0) - (b.added || 0));
            } else if (sortValue === 'title-asc') {
                state.filteredBookmarks.sort((a, b) => a.name.localeCompare(b.name));
            } else if (sortValue === 'title-desc') {
                state.filteredBookmarks.sort((a, b) => b.name.localeCompare(a.name));
            }

            // æ›´æ–°å…¨å±€ä¹¦ç­¾é¡ºåº
            const newBookmarks = [];
            const filteredSet = new Set(state.filteredBookmarks);
            state.bookmarks.forEach(b => {
                if (!filteredSet.has(b)) newBookmarks.push(b);
            });
            state.filteredBookmarks.forEach(b => newBookmarks.push(b));
            state.bookmarks = newBookmarks;

            saveBookmarks();
            renderBookmarks();
            hideSortModal();
        }

        window.onload = () => {
                const loadingIndicator = document.getElementById('loading-indicator');
                if (loadingIndicator) loadingIndicator.style.display = 'block';

                try {
                        requestAnimationFrame(() => {
                                loadBookmarks();
                                if (state.isFirstRun) {
                                        localStorage.setItem('hasRunBefore', 'true');
                                        state.isFirstRun = false;
                                        showWelcomeModal();
                                }
                                const messageInput = document.getElementById('message-input');
                                if (messageInput) messageInput.value = state.message;

                                document.getElementById('add-form')?.addEventListener('keypress', (e) => {
                                        if (e.key === 'Enter' && !e.shiftKey) {
                                                e.preventDefault();
                                                saveBookmark();
                                        }
                                });

                                document.addEventListener('keydown', (e) => {
                                        if (e.ctrlKey && e.key === 's') {
                                                e.preventDefault();
                                                toggleAddForm(true);
                                        } else if (e.key === 'Escape') {
                                                hideAllModals();
                                                if (state.isEditMode) toggleEditMode();
                                        }
                                });
                        });
                } finally {
                        if (loadingIndicator) loadingIndicator.style.display = 'none';
                }
        };
    </script>
</body>
</html>