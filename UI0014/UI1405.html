<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>书签管理器</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- 添加默认favicon，避免浏览器自动请求不存在的favicon.ico -->
    <link rel="icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0iIzAwN2JmZiIgZmlsbC1vcGFjaXR5PSIwLjgiPjxwYXRoIGQ9Ik0xMiAzQTYgNiAwIDAgMSAxOCA5IDYgNiAwIDAgMSAxMiAxNUE2IDYgMCAwIDEgNiA5IDYgNiAwIDAgMSAxMiAzWiIvPjwvc3ZnPg==" type="image/svg+xml">
    <style>
        :root {
            --primary-color: #007bff;
            --secondary-color: #6c757d;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --background-color: #f4f6f8;
            --card-background: #ffffff;
            --text-color: #333;
            --border-radius: 10px;
            --box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            --transition: all 0.3s ease;
            --button-height: 28px;
            --card-height: 160px;
            --card-width: 230px;
            --card-padding: 10px;
            --title-font-size: 16px;
            --url-font-size: 12px;
            --desc-font-size: 14px;
            --content-spacing: 6px;
            --sidebar-width-narrow: 60px;
            --sidebar-width-wide: 150px;
            --toolbar-height: 60px;
            --category-drag-bg: rgba(100, 149, 237, 0.2);
            --category-drag-border: #6495ED;
            --category-drag-opacity: 0.6;
        }
        
        /* 弹窗默认样式 - 初始隐藏，通过JS控制显示 */
        #help-modal, #message-form, #export-modal, #add-form, #sort-modal {
            display: none;
        }
        /* 统一的滚动条样式 - 细灰色滚动条 */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        
        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #ccc;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #999;
        }

        /* 为所有弹窗内容区域添加统一的滚动条样式 */
        [id$="-modal-content"] {
            scrollbar-width: thin;
            scrollbar-color: #ccc transparent;
        }

        body {
            font-family: 'Roboto', sans-serif;
            margin: 0;
            padding: 0;
            background: var(--background-color);
            color: var(--text-color);
            line-height: 1.5;
            letter-spacing: 0.5px;
            box-sizing: border-box;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        #toolbar {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background: #fff;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            padding: 10px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 15px;
            z-index: 1000;
            box-sizing: border-box;
            height: var(--toolbar-height);
        }

        #title {
            font-size: 18px;
            font-weight: 700;
            color: #333;
            margin: 0;
            flex-shrink: 0;
        }

        #toggle-sidebar-btn {
            margin-left: 10px;
            padding: 5px;
            width: 30px;
            height: var(--button-height);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.3s ease;
        }

        #controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
            flex-grow: 1;
            justify-content: flex-end;
        }

        button {
            padding: 5px 10px;
            border: 1px solid var(--primary-color);
            border-radius: var(--border-radius);
            background: #fff;
            color: var(--primary-color);
            font-size: 12px;
            cursor: pointer;
            transition: var(--transition);
            height: var(--button-height);
            display: flex;
            align-items: center;
            gap: 5px;
            box-sizing: border-box;
        }

        /* 折叠式菜单样式 */
        .dropdown {
            position: relative;
            display: inline-block;
            margin-right: 10px;
        }

        .dropdown-content {
            position: absolute;
            left: 50%;
            top: 100%;
            background-color: #fff;
            min-width: 130px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
            border-radius: var(--border-radius);
            z-index: 1001;
            padding: 5px 0;
            margin-top: 2px;
            opacity: 0;
            visibility: hidden;
            transform: translateX(-50%) translateY(-5px);
            transition: opacity 0.2s ease, transform 0.2s ease;
        }

        .dropdown-content button {
            width: 100%;
            padding: 10px 16px;
            text-align: left;
            border: none;
            background: none;
            color: var(--text-color);
            border-radius: 0;
            height: auto;
            font-size: 13px;
            white-space: nowrap;
        }

        .dropdown-content button:hover {
            background-color: var(--background-color);
            color: var(--primary-color);
        }

        .dropbtn {
            font-size: 13px;
            font-weight: 500;
            padding: 5px 10px;
            border-radius: var(--border-radius);
            height: var(--button-height);
            min-width: 80px;
        }

        /* 使用JavaScript控制菜单显示/隐藏，避免CSS hover的局限性 */
        .dropdown.open .dropdown-content {
            opacity: 1;
            visibility: visible;
            transform: translateX(-50%) translateY(0);
        }

        .dropdown.open .dropbtn {
            background: var(--primary-color);
            color: white;
        }

        button:hover {
            background: var(--primary-color);
            color: white;
        }

        button:active {
            transform: scale(0.98);
        }

        .delete-btn {
            border-color: var(--danger-color);
            color: var(--danger-color);
        }

        .delete-btn:hover {
            background: var(--danger-color);
            color: white;
        }

        .batch-delete-btn {
            border-color: var(--danger-color);
            color: var(--danger-color);
        }

        .batch-delete-btn:hover {
            background: var(--danger-color);
            color: white;
        }

        #undo-btn {
            border-color: var(--success-color);
            color: var(--success-color);
        }

        #undo-btn:hover {
            background: var(--success-color);
            color: white;
        }

        #search {
            width: 150px;
            padding: 8px;
            border: 1px solid #ced4da;
            border-radius: var(--border-radius);
            font-size: 12px;
            transition: var(--transition);
            box-sizing: border-box;
        }

        #search:focus {
            border-color: var(--primary-color);
            outline: none;
        }

        #content-wrapper {
            display: flex;
            margin-top: var(--toolbar-height);
            height: calc(100vh - var(--toolbar-height));
        }

        #sidebar {
            width: 0;
            background: var(--card-background);
            padding: 20px 0;
            box-shadow: none;
            overflow-y: auto;
            font-size: 14px;
            flex-shrink: 0;
            border-right: none;
            transition: width 0.3s ease, padding 0.3s ease, box-shadow 0.3s ease, border-right 0.3s ease;
            scrollbar-width: thin;
            scrollbar-color: #b0b0b0 #d3d3d3;
        }

        #sidebar.wide {
            width: var(--sidebar-width-wide);
            padding: 20px;
            box-shadow: var(--box-shadow);
            border-right: 1px solid #d1d5db;
        }

        #sidebar::-webkit-scrollbar {
            width: 8px;
        }

        #sidebar::-webkit-scrollbar-thumb {
            background: #b0b0b0;
            border-radius: 4px;
            border: 2px solid #e9ecef;
        }

        #sidebar::-webkit-scrollbar-track {
            background: #d3d3d3;
            border-radius: 4px;
        }

        #sidebar h2 {
            margin: 0 0 15px;
            font-size: 16px;
            color: var(--text-color);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .category-item {
            padding: 8px 12px;
            margin: 5px 0;
            background: #ffffff;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
            text-align: left;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .category-item:hover {
            background: #d1d5db;
        }

        .category-item.active {
            background: var(--primary-color);
            color: white;
        }
        
        .category-item.dragging {
            opacity: var(--category-drag-opacity);
            background-color: var(--category-drag-bg);
            border: 1px dashed var(--category-drag-border);
        }
        
        .category-item.drop-target {
            background-color: var(--category-drag-bg);
            border: 1px solid var(--category-drag-border);
        }

        #main-content {
            flex-grow: 1;
            padding: 20px;
            box-sizing: border-box;
            overflow-y: auto;
            height: calc(100vh - var(--toolbar-height));
        }

        #main-content::-webkit-scrollbar {
            width: 4px;
        }

        #main-content::-webkit-scrollbar-thumb {
            background: #ccc;
            border-radius: 4px;
        }

        #tips {
            display: none;
            max-width: 1100px;
            margin: 0 auto 20px;
            padding: 15px 10px;
            border-left: 4px solid #ffca28;
            background: #fff8e1;
            border-radius: var(--border-radius);
            font-size: 14px;
            color: #856404;
            line-height: 1.6;
            position: relative;
            z-index: 1;
        }

        #container {
            max-width: 1100px;
            margin: 0 auto;
            box-sizing: border-box;
        }

        #bookmarks.bookmark-grid {
                display: grid;
                gap: 16px;
                justify-content: center;
                width: 100%;
                box-sizing: border-box;
                grid-template-columns: repeat(auto-fill, minmax(var(--card-width), 1fr));
                /* 移除 min-height，让高度动态适应实际书签数量 */
        }

        #stats {
                max-width: 1100px;
                margin: 20px auto;
                padding: 15px;
                background: #fff;
                border-radius: var(--border-radius);
                box-shadow: var(--box-shadow);
                font-size: 14px;
                color: var(--text-color);
                text-align: center;
                display: none; /* 默认隐藏，条件满足时显示 */
        }

        /* 欢迎弹窗样式 - 完全仿照留言板弹窗样式 */


        /* 帮助弹窗样式 */
        #help-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--card-background);
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 1000;
            width: 600px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            box-sizing: border-box;
        }
        
        #help-modal * {
            border: none;
            outline: none;
        }

        /* 排序弹窗样式 */
        #sort-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--card-background);
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 1000;
            width: 300px;
            max-height: 70vh;
            display: flex;
            flex-direction: column;
            box-sizing: border-box;
        }

        /* 书签详情弹窗样式 */
        #view-bookmark-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--card-background);
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 1000;
            width: 400px;
            max-height: 70vh;
            display: flex;
            flex-direction: column;
            box-sizing: border-box;
        }


            display: flex;
            flex-direction: column;
            box-sizing: border-box;
        }

        /* 搜索弹窗样式已移至下方，这里只保留兼容性定义 */

        #search-modal-header {
            position: sticky;
            top: 0;
            background-color: var(--card-background);
            padding: 0 0 10px 0;
            z-index: 10;
        }

        #search-modal-content {
            flex: 1;
            overflow-y: auto; /* 只允许内容区域滚动 */
            max-height: 65vh;
        }



        

        

        #sort-modal-header {
            position: sticky;
            top: 0;
            background-color: var(--card-background);
            padding: 0 0 10px 0;
            z-index: 10;
        }

        #sort-modal-content {
            flex: 1;
            overflow-y: auto;
            max-height: 55vh;
        }

        #help-modal-header {
            position: sticky;
            top: 0;
            background-color: white;
            padding: 10px 30px 10px 30px;
            z-index: 10;
            box-shadow: none;
        }

        #help-modal-content {
            flex: 1;
            overflow-y: auto;
            padding: 10px 30px 20px 30px;
            background: white;
            max-height: 65vh;
        }

        #help-content {
            font-size: 14px;
            color: var(--text-color);
            line-height: 1.6;
        }

        #help-content p {
            margin: 10px 0;
            word-wrap: break-word;
        }

        #help-content ul, #help-content ol {
            margin: 10px 0 10px 20px;
            padding: 0;
        }

        #help-content li {
            margin: 5px 0;
            word-wrap: break-word;
        }

        /* 导出弹窗样式 */
        #export-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--card-background);
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 1000;
            width: 400px;
            max-height: 70vh;
            flex-direction: column;
            box-sizing: border-box;
        }

        #export-modal-header {
            position: sticky;
            top: 0;
            background-color: var(--card-background);
            padding: 0 0 10px 0;
            z-index: 10;
        }

        #export-modal-content {
            flex: 1;
            overflow-y: auto;
            max-height: 55vh;
        }

        #export-modal-content::-webkit-scrollbar {
            width: 6px;
        }

        #export-modal-content::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }

        #export-modal-content::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 3px;
        }

        #export-modal-content::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* 留言板样式 */
        #message-form {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--card-background);
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 1000;
            width: 400px;
            max-height: 70vh;
            display: flex;
            flex-direction: column;
            box-sizing: border-box;
        }

        #message-form-header {
            position: sticky;
            top: 0;
            background-color: var(--card-background);
            padding: 0 0 10px 0;
            z-index: 10;
        }

        #message-form-content {
            flex: 1;
            overflow-y: auto;
            max-height: 55vh;
        }

        /* 添加书签表单样式 - 参考副本优化 */
        #add-form {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white !important;
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 1000;
            width: 700px; /* 增加宽度以适应两栏布局 */
            max-height: 80vh; /* 限制最大高度为视口的80% */
            overflow-y: auto; /* 恢复垂直滚动功能 */
            box-sizing: border-box;
        }
        
        /* 表单内容两栏布局 */
        .form-content {
            display: flex;
            gap: 20px;
            margin-bottom: 16px;
        }
        
        /* 左侧表单区域 */
        .form-left {
            flex: 1;
        }

        /* 右侧分类选择区域 */
        .form-right {
            flex: 1;
            position: relative;
            display: flex;
            flex-direction: column;
        }

        /* 分类选择区域样式 */
        .category-section {
            position: relative;
            margin-top: 10px;
        }

        .category-section h4 {
            margin: 0 0 10px 0;
            font-size: 14px;
            color: var(--text-color);
            font-weight: 600;
        }

        /* 常用分类标签样式 */
        .recent-categories {
            margin-top: 5px;
            margin-bottom: 0;
            /* 与其他输入框一致的边框样式 */
            border: 1px solid #ced4da;
            border-radius: 8px;
            padding: 10px;
            min-height: 180px;
            height: 200px; /* 固定高度 */
            display: flex;
            flex-direction: column;
            background: white;
        }

        .recent-categories p {
            margin: 0 0 8px 0;
            font-size: 12px;
            color: #6c757d;
        }

        .category-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            flex-grow: 1;
            overflow-y: auto; /* 添加滚动条 */
            padding-right: 5px;
            justify-content: flex-start;
        }

        /* 无分类时的提示文字样式 */
        .no-categories-message {
            display: block;
            text-align: center;
            color: #6c757d;
            font-size: 14px;
            width: 100%;
            padding: 40px 0;
        }

        /* 有分类时隐藏提示文字 */
        .category-tags:not(:empty) .no-categories-message {
            display: none;
        }

        .category-tag {
            background-color: white;
            border: 1px solid #ced4da;
            padding: 6px 10px; /* 增加内边距以增大行距 */
            margin-bottom: 4px; /* 增加底部外边距以增大行距 */
            border-radius: 15px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center; /* 文字水平居中显示 */
            display: flex; /* 确保文字完全居中 */
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            max-width: 100px;
            min-height: 24px; /* 确保有足够高度实现垂直居中 */
        }

        /* 悬停时显示完整分组名称的小框 */
        .category-tag:hover::after {
            content: attr(title);
            position: absolute;
            top: -30px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #333;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            white-space: nowrap;
            z-index: 1001;
            opacity: 1;
            pointer-events: none;
        }

        .category-tag::after {
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .category-tag:hover {
            background-color: var(--primary-color);
            color: black; /* 悬停时文字颜色改为黑色 */
            border-color: var(--primary-color);
        }

        /* 添加书签表单标题样式 */
        #add-form h3 {
            margin-top: 0;
            margin-bottom: 20px;
            color: var(--text-color);
            font-size: 18px;
            font-weight: 600;
        }

        /* 分类选择输入框优化 */
        #category {
            position: relative;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="%23999" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6,9 12,15 18,9"></polyline></svg>');
            background-repeat: no-repeat;
            background-position: right 10px center;
            padding-right: 30px;
            cursor: pointer;
        }
        
        /* 自定义分类下拉列表已移除，所有分类显示在常用分组中 */
        
        /* 表单按钮样式 */
        .form-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .form-buttons button {
            padding: 10px 20px;
            border: 1px solid #0056b3 !important; /* 调细边框 */
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            background-color: white !important;
            color: #0056b3 !important;
            position: relative;
            z-index: 1;
        }
        
        .form-buttons button:last-child {
            border-color: #6c757d !important;
            color: #6c757d !important;
        }
        
        .form-buttons button:hover {
            background-color: #0056b3 !important; /* 深蓝色背景 */
            color: white !important;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 86, 179, 0.4);
        }
        
        .form-buttons button:last-child:hover {
            background-color: #6c757d !important;
            color: white !important;
        }

        #view-bookmark-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--card-background);
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 1001; /* 比search-modal的z-index高，确保详情页弹窗显示在搜索弹窗前面 */
            width: 400px;
            max-height: 70vh;
            display: flex;
            flex-direction: column;
            box-sizing: border-box;
        }

        /* 统一模态框基础样式 */
        .common-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--card-background);
            padding: 25px;
            border-radius: var(--border-radius);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 1000;
            width: 600px;
            box-sizing: border-box;
        }

        /* 备份状态样式 */
        .backup-status {
            background-color: rgba(0,0,0,0.05);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 25px;
            text-align: center;
            border-left: 4px solid transparent;
            transition: all 0.3s ease;
        }
        
        .backup-status.enabled {
            background-color: rgba(76, 175, 80, 0.1);
            border-left-color: #4CAF50;
        }
        
        .backup-status.disabled {
            background-color: rgba(158, 158, 158, 0.1);
            border-left-color: #9E9E9E;
        }
        
        .backup-status small {
            display: block;
            margin-top: 4px;
            color: var(--text-color-secondary);
            font-size: 13px;
        }
        
        /* 表单组样式 - 恢复原始样式 */
        .form-group {
            margin-bottom: 20px;
            padding: 0;
            background-color: transparent;
            border: none;
            border-radius: 0;
            box-shadow: none;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-color);
            font-size: 14px;
        }
        
        .form-group select {
            width: 100%;
            padding: 12px 15px;
            background-color: var(--input-background);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 14px;
            color: var(--text-color);
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }
        
        .form-group select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(63, 81, 181, 0.1);
        }
        
.backup-item {
            padding: 12px 15px;
            margin: 0 0 5px 0;
            border: 1px solid #e3f2fd;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            transition: all 0.3s ease;
            background: linear-gradient(135deg, rgba(245,255,250,0.8), rgba(240,255,255,0.8));
        }
        
        /* 为不同的备份项添加随机浅渐变色背景 */
        .backup-item:nth-child(4n+1) {
            background: linear-gradient(135deg, rgba(245,255,250,0.8), rgba(240,255,255,0.8));
        }
        
        .backup-item:nth-child(4n+2) {
            background: linear-gradient(135deg, rgba(240,255,255,0.8), rgba(240,248,255,0.8));
        }
        
        .backup-item:nth-child(4n+3) {
            background: linear-gradient(135deg, rgba(240,248,255,0.8), rgba(248,248,255,0.8));
        }
        
        .backup-item:nth-child(4n+4) {
            background: linear-gradient(135deg, rgba(248,248,255,0.8), rgba(245,255,250,0.8));
        }
        
        .backup-item.latest {
            border-left: 4px solid #4CAF50;
            border-color: #4CAF50;
            background: linear-gradient(135deg, rgba(240,255,240,0.8), rgba(245,255,250,0.9));
        }
        
        .backup-item:hover {
            transform: translateX(2px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        
        /* 日期和信息在同一行显示 */
        .backup-date {
            font-weight: 600;
            color: var(--text-color);
            font-size: 14px;
            margin-right: 15px;
        }
        
        .backup-info {
            font-size: 12px;
            color: var(--text-color-secondary);
            flex: 1;
        }
        
        /* 确保操作按钮始终显示在右侧 */
        .backup-actions {
            white-space: nowrap;
        }
            margin-left: auto;
            white-space: nowrap;
        }
        

            padding: 20px;
            margin: 0;
        }
        
        .error {
            text-align: center;
            color: #f44336;
            padding: 20px;
            margin: 0;
        }
        
        /* 按钮组样式 */
        .form-buttons {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
        }
        

        }
        
        /* 下载提示样式 */
        .download-tip {
            margin-top: 15px;
            padding: 12px;
            background-color: rgba(33, 150, 243, 0.1);
            border-radius: 6px;
            border-left: 4px solid #2196F3;
            font-size: 13px;
            color: var(--text-color-secondary);
        }
        
        /* 动画效果 */
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translate(-50%, -45%);
            }
            to {
                opacity: 1;
                transform: translate(-50%, -50%);
            }
        }

        /* 搜索模态框样式 */
        #search-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #fff;
            padding: 25px;
            border-radius: var(--border-radius);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 1000;
            width: 500px; /* 调整弹窗宽度为500px */
            height: 450px; /* 调整弹窗高度为450px，避免遮挡菜单栏 */
            box-sizing: border-box;
            overflow: hidden !important; /* 强制隐藏所有方向的滚动条 */
        }

        #search-results {
            height: calc(100% - 100px); /* 动态计算高度，确保不会超出父容器 */
            overflow-y: auto;
            margin-top: 15px;
            border: none;
            padding: 0;
            position: relative;
        }

        /* 实现默认隐藏、滚动时显示滚动条的样式 */
        
        /* 搜索结果区域滚动条 - 全面调细滚动条样式（兼容所有主要浏览器） */
        
        /* Chrome, Safari, Edge */
        #search-modal #search-results::-webkit-scrollbar {
            width: 2px !important;
            height: 2px !important;
        }

        #search-modal #search-results::-webkit-scrollbar-thumb {
            background: #888 !important;
            border-radius: 3px !important;
        }

        #search-modal #search-results::-webkit-scrollbar-thumb:hover {
            background: #555 !important;
        }

        #search-modal #search-results::-webkit-scrollbar-track {
            background: #f1f1f1 !important;
            border-radius: 3px !important;
        }
        
        /* Firefox */
        #search-modal #search-results {
            scrollbar-width: thin !important;
            scrollbar-color: #888 #f1f1f1 !important;
        }
        
        /* IE and Edge Legacy */
        #search-modal #search-results {
            -ms-overflow-style: thin !important;
        }


        
        /* 添加书签弹窗滚动条 */
        #add-form::-webkit-scrollbar {
            width: 6px;
        }
        
        #add-form::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }
        
        #add-form::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 3px;
        }
        
        #add-form::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        
        /* 留言板弹窗滚动条 */
        #message-form::-webkit-scrollbar {
            width: 6px;
        }
        
        #message-form::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }
        
        #message-form::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 3px;
        }
        
        #message-form::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        .step {
            margin: 10px 0;
        }

        .step strong {
            color: var(--primary-color);
        }

        #message-form {
            width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            padding: 25px;
            background: linear-gradient(135deg, #ffffff, #f9f9f9);
        }

        #message-form h3 {
            margin: 0;
            font-size: 20px;
            color: var(--primary-color);
            text-align: center;
            font-weight: 500;
        }

        #message-form .form-group {
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        #message-form label {
            font-weight: 500;
            color: var(--text-color);
            font-size: 16px;
        }

        #message-form textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            min-height: 150px;
            background: #ffffff;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
            transition: border-color 0.3s ease, background 0.3s ease;
        }

        #message-form textarea[readonly] {
            cursor: pointer;
        }

        #message-form textarea:not([readonly]) {
            border-color: var(--primary-color);
        }

        #message-form textarea:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 5px rgba(0,123,255,0.3);
            outline: none;
        }

        #message-form .form-buttons {
            display: flex;
            justify-content: space-between;
            gap: 15px;
        }

        #message-form button {
            flex: 1;
            padding: 10px;
            font-size: 14px;
            border-radius: 8px;
            height: 40px;
            transition: background-color 0.3s ease, transform 0.2s ease;
        }

        #message-form button:hover {
            transform: translateY(-2px);
        }

        /* 搜索模态框样式 - 此样式已被上方样式覆盖，保留仅作参考 */
        /* #search-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--card-background);
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 1000;
            width: 400px;
            max-height: 80vh;
            overflow-y: auto;
            box-sizing: border-box;
        } */

        #search-modal h3 {
            margin: 0 0 15px;
            font-size: 18px;
            color: var(--primary-color);
            text-align: center;
        }

        #search-modal .search-input-container {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        #search-modal-input {
            flex: 1;
            padding: 8px;
            border: 1px solid #ced4da;
            border-radius: var(--border-radius);
            font-size: 12px;
            box-sizing: border-box;
        }

        #search-modal-input:focus {
            border-color: var(--primary-color);
            outline: none;
        }

        #search-modal-submit {
            padding: 5px 15px;
            border: 1px solid var(--primary-color);
            border-radius: var(--border-radius);
            background: var(--primary-color);
            color: white;
            font-size: 12px;
            cursor: pointer;
            transition: var(--transition);
            height: var(--button-height);
        }

        #search-modal-submit:hover {
            background: #0056b3;
        }

        #search-modal-close {
            padding: 5px 15px;
            border: 1px solid var(--secondary-color);
            border-radius: var(--border-radius);
            background: #fff;
            color: var(--secondary-color);
            font-size: 12px;
            cursor: pointer;
            transition: var(--transition);
            height: var(--button-height);
        }

        #search-modal-close:hover {
            background: var(--secondary-color);
            color: white;
        }

        /* 搜索结果列表样式 */
        #search-results {
            max-height: 400px; /* 设置合适的结果区域最大高度 */
            overflow-y: auto;
            margin-top: 15px;
            border: none;
            padding: 0;
        }

        .search-result-item {
            padding: 12px 10px; /* 增加内边距确保内容有足够空间 */
            margin-bottom: 8px;
            border: 1px solid #e0e0e0;
            border-radius: var(--border-radius);
            background: white;
            cursor: pointer;
            transition: var(--transition);
            box-sizing: border-box;
        }

        .search-result-item:hover {
            background: #f8f9fa;
            border-color: var(--primary-color);
        }

        .search-result-name {
            font-weight: 500;
            color: var(--text-color);
            margin-bottom: 8px; /* 增加名称与链接之间的间距 */
            display: block;
            font-size: 15px; /* 调整字体大小 */
            line-height: 1.6; /* 增大行间距，使两行文本更加清晰 */
            max-height: 4em; /* 增加高度确保两行文本完全显示 */
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            cursor: pointer; /* 添加鼠标指针样式 */
        }

        .search-result-name:hover {
            color: var(--primary-color); /* 鼠标悬停时变为蓝色 */
            text-decoration: underline; /* 鼠标悬停时显示下划线 */
        }

        .search-result-url {
            font-size: 15px; /* 调大URL字体大小，增强可读性 */
            color: var(--primary-color);
            text-decoration: none;
            display: block;
            word-break: break-all;
            margin-top: 5px;
        }

        .search-result-url:hover {
            text-decoration: underline;
        }

        #no-search-results {
            text-align: center;
            color: var(--secondary-color);
            padding: 20px;
            display: none;
        }

        #message-form #save-message-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            display: none;
        }

        #message-form #save-message-btn:hover {
            background: #0056b3;
        }

        #message-form #cancel-message-btn {
            background: #fff;
            color: var(--danger-color);
            border: 1px solid var(--danger-color);
            display: none;
        }

        #message-form #cancel-message-btn:hover {
            background: var(--danger-color);
            color: white;
        }

        #message-form #close-message-btn {
            background: #fff;
            color: var(--secondary-color);
            border: 1px solid var(--secondary-color);
        }

        #message-form #close-message-btn:hover {
            background: var(--secondary-color);
            color: white;
        }

        /* 帮助模态框样式 - 完全参考欢迎弹窗优化 */
        #help-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #fff;
            border-radius: var(--border-radius);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 1000;
            width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-sizing: border-box;
            border: none;
            outline: none;
        }

        #help-modal * {
            border: none;
            outline: none;
            box-sizing: border-box;
        }

        #help-modal-header {
            position: sticky;
            top: 0;
            background-color: white;
            padding: 10px 30px 10px 30px;
            z-index: 10;
            box-shadow: none;
        }

        #help-modal-content {
            overflow-y: auto;
            padding: 10px 30px 20px 30px;
            background: white;
            max-height: 60vh;
        }

        #help-modal-footer {
            padding: 5px 0 15px 0;
            border-top: 1px solid #eee;
            display: flex;
            justify-content: center;
            background: white;
        }

        #help-modal::-webkit-scrollbar {
            width: 6px;
        }

        #help-modal::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }

        #help-modal::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 3px;
        }

        #help-modal::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        #help-modal h3 {
            margin: 4px 0 16px 0;
            font-size: 22px;
            color: var(--primary-color);
            text-align: center;
            font-weight: 600;
            letter-spacing: 0.5px;
        }
        #help-modal h4 {
            margin: 24px 0 12px;
            font-size: 17px;
            color: var(--text-color);
            border-bottom: 2px solid var(--primary-color-light);
            padding-bottom: 6px;
            font-weight: 600;
        }

        #help-modal hr {
            border: none;
            border-top: 1px solid #e9ecef;
            margin: 20px 0;
        }

        #help-modal p {
            margin: 12px 0;
            font-size: 15px;
            color: var(--text-color);
            line-height: 1.7;
            word-wrap: break-word;
            text-align: justify;
        }

        #help-modal ul, #help-modal ol {
            margin: 12px 0 12px 25px;
            padding: 0;
        }

        #help-modal li {
            margin: 8px 0;
            font-size: 15px;
            color: var(--text-color);
            line-height: 1.6;
            word-wrap: break-word;
        }

        #help-modal .important-tip {
            background-color: rgba(255, 193, 7, 0.15);
            border-left: 4px solid #ffc107;
            padding: 15px 20px;
            margin: 18px 0;
            border-radius: 6px;
            font-weight: 500;
            color: #856404;
            box-shadow: 0 3px 6px rgba(0,0,0,0.08);
            word-wrap: break-word;
            font-size: 15px;
            line-height: 1.6;
        }

        #help-modal .important-tip::before {
            content: "⚠️ ";
            margin-right: 5px;
        }

        #view-bookmark-modal #bookmark-details {
            flex: 1;
            overflow-y: auto;
            max-height: calc(70vh - 120px);
        }

        #view-bookmark-modal #bookmark-details::-webkit-scrollbar {
            width: 0;
            transition: width 0.3s ease;
        }

        #view-bookmark-modal #bookmark-details:hover::-webkit-scrollbar {
            width: 6px;
        }

        #view-bookmark-modal #bookmark-details::-webkit-scrollbar-thumb {
            background: #ccc;
            border-radius: 3px;
            transition: background 0.3s ease;
        }

        #view-bookmark-modal #bookmark-details::-webkit-scrollbar-thumb:hover {
            background: #999;
        }

        #view-bookmark-modal #bookmark-details::-webkit-scrollbar-track {
            background: #f5f5f5;
        }

        .form-group {
            margin-bottom: 15px;
            display: flex;
            flex-wrap: wrap;
            align-items: baseline;
            gap: 5px;
        }

        .form-group label {
            font-weight: 500;
            color: var(--text-color);
            margin-right: 5px;
            min-width: 50px;
        }

        .form-group p {
            margin: 0;
            flex: 1;
            word-break: break-word;
        }

        input, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: var(--border-radius);
            font-size: 14px;
            box-sizing: border-box;
            transition: var(--transition);
            line-height: 1.5; /* 增加行间距 */
        }

        input:focus, textarea:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 2px rgba(92, 184, 92, 0.25);
        }

        /* 为select选项单独添加边框 */
        select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: var(--border-radius);
            font-size: 14px;
            box-sizing: border-box;
            transition: var(--transition);
            background: white;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            cursor: pointer;
        }

        select:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 2px rgba(92, 184, 92, 0.25);
        }

        textarea {
            resize: vertical;
            min-height: 80px;
        }

        /* 简介输入框特定样式 */
        #desc {
            min-height: 132px;
            font-size: 13px;
            line-height: 1.6;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }

        /* 留言输入框特定样式 */
        #message-input {
            font-size: 13px;
            line-height: 1.6;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }

        .form-buttons {
            display: flex;
            gap: 10px;
            margin-top: 12px;
            justify-content: center;
            width: 100%;
        }

        .bookmark-grid {
            display: grid;
            gap: 16px;
            justify-content: center;
            width: 100%;
            box-sizing: border-box;
            grid-template-columns: repeat(auto-fill, minmax(var(--card-width), 1fr));
        }

        .bookmark-card {
            position: relative;
            height: var(--card-height);
            width: var(--card-width);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            cursor: default;
            overflow: hidden;
            padding: var(--card-padding);
            user-select: none;
            perspective: 1000px;
        }

        .bookmark-card.placeholder {
            visibility: hidden;
        }

        .bookmark-card.edit-mode {
            cursor: default;
        }

        .bookmark-card.dragging {
            opacity: 0.6;
            cursor: grabbing;
            border: 2px dashed #87CEFA;
            transition: transform 1s ease-out, opacity 1s ease, scale 1s ease;
        }

        .bookmark-card.drop-target {
            border: 1.5px dashed #2196f3;
            box-shadow: 0 0 8px 1px #2196f3;
            opacity: 1;
            z-index: 20;
            animation: drop-glow 0.2s linear;
            transition: border 0.1s, box-shadow 0.1s, transform 0.2s cubic-bezier(.4,2,.6,1), opacity 0.1s;
                @keyframes drop-glow {
                        0% { box-shadow: 0 0 0 0 #2196f3; }
                        100% { box-shadow: 0 0 8px 1px #2196f3; }
                }


        }

        .bookmark-card.swapping {
            position: absolute;
            transition: transform 1s ease-out, opacity 1s ease, scale 1s ease;
            z-index: 10;
        }

        .main-card-container {
            position: relative;
            width: 100%;
            height: 100%;
            perspective: 1000px;
        }

        .main-card {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
            transform-style: preserve-3d;
            transition: transform 0.6s ease;
        }

        .main-card.flipped {
            transform: rotateY(180deg);
        }

        .main-card-front, .main-card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            background: #fff;
            border: 1px solid #e5e7eb;
            border-radius: var(--border-radius);
            padding: var(--card-padding);
            box-sizing: border-box;
            backface-visibility: hidden;
            display: flex;
            flex-direction: column;
        }

        .main-card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            background: #fff;
            border: 1px solid #e5e7eb;
            border-radius: var(--border-radius);
            padding: var(--card-padding);
            box-sizing: border-box;
            backface-visibility: hidden;
            transform: rotateY(180deg);
            z-index: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .main-card-back .desc {
            font-size: 13px;
            color: #444;
            line-height: 1.5;
            margin: 0;
            white-space: pre-wrap;
            word-break: break-word;
            overflow-y: auto;
            flex-grow: 1;
            min-height: 0;
            scrollbar-width: thin;
            scrollbar-color: #ccc #f5f5f5;
        }

        .main-card-back .desc::-webkit-scrollbar {
            width: 6px;
        }

        .main-card-back .desc::-webkit-scrollbar-thumb {
            background: #ccc;
            border-radius: 3px;
        }

        .main-card-back .desc::-webkit-scrollbar-track {
            background: #f5f5f5;
        }

        .main-card-back .desc-title {
            color: #1e90ff;
            font-weight: bold;
            font-size: 14px;
            margin-bottom: 5px;
        }

        .main-card-back .desc {
            font-size: 13px;
            color: #444;
            line-height: 1.5;
            margin: 0;
            white-space: pre-wrap;
            word-break: break-word;
        }

        .main-card-back .no-desc {
            color: #1e90ff;
            font-size: 14px;
        }

        .bookmark-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            gap: 8px;
        }

        .main-card-front h3 {
            margin: 0;
            font-size: var(--title-font-size);
            font-weight: 600;
            line-height: 1.2;
            flex-shrink: 0;
            cursor: default;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .main-card-front h3 .favicon-container {
                display: inline-flex;
                align-items: center;
                margin-right: 5px;
        }

        .main-card-front h3 .favicon {
                width: var(--title-font-size);
                height: var(--title-font-size);
                vertical-align: middle;
                display: none; /* 默认隐藏，直到加载成功 */
        }

        .main-card-front h3 .title-text {
            transition: color 0.2s ease;
            flex-grow: 1;
        }

        .main-card-front:not(.edit-mode) h3 .title-text:hover {
            color: var(--primary-color);
            cursor: pointer;
            text-decoration: underline;
        }

        .main-card-front p.url {
            margin: 0 0 4px 0;
            font-size: 15px;
            color: #5a6470;
            line-height: 1.2;
            flex-shrink: 0;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
        }

        .main-card-front .desc-container {
            margin: 0;
            flex-grow: 1;
            overflow: hidden;
        }

        .main-card-front .desc {
            font-size: var(--desc-font-size);
            color: #666;
            line-height: 1.3;
            margin: 0;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
        }

        .main-card-front .desc:empty::before {
            content: "暂无简介";
            color: #b0b0b0;
        }

        .main-card-front a {
            color: var(--primary-color);
            text-decoration: none;
            pointer-events: none;
        }

        .main-card-front:hover a {
            pointer-events: auto;
        }

        .main-card-front a:hover {
            text-decoration: underline;
        }

        .main-card-front .action-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: var(--button-height);
            margin-top: auto;
        }

        .category-tag {
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 11px;
            color: #666;
            background-color: var(--secondary-color);
            max-width: 80px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            font-weight: 500;
        }

        .bookmark-checkbox {
            width: 14px;
            height: 14px;
            position: absolute;
            top: 6px;
            right: 6px;
            display: none;
            z-index: 10;
        }

        .bookmark-checkbox.visible {
            display: block;
        }

        .action-bar {
            position: relative;
            z-index: 50;
            pointer-events: auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .action-buttons {
            display: flex;
            gap: 6px;
            align-items: center;
            position: relative;
            z-index: 51;
            pointer-events: auto;
        }

        .action-buttons button {
            padding: 3px 6px;
            font-size: 10px;
            min-width: 40px;
            border-radius: 5px;
            background: #fff;
            border: 1px solid var(--primary-color);
            color: var(--primary-color);
            cursor: pointer;
            pointer-events: auto;
            position: relative;
            z-index: 52;
            transition: background 0.3s ease, color 0.3s ease;
        }

        .edit-mode .hover-area {
            pointer-events: none;
        }

        .main-card {
            position: relative;
            z-index: 10;
            pointer-events: auto;
        }

        .main-card-front {
            pointer-events: auto;
            z-index: 2;
        }

        .action-buttons button:hover {
            background: var(--primary-color);
            color: white;
        }

        .action-buttons .delete-btn {
            border-color: var(--danger-color);
            color: var(--danger-color);
        }
        
        /* 分类项样式 */
        .category-item {
            padding: 8px 12px;
            margin: 1px 0;
            border-radius: 6px;
            cursor: default;
            transition: all 0.2s ease;
            user-select: none;
            position: relative;
            z-index: 1;
        }
        
        .category-item:hover {
            background-color: rgba(0, 123, 255, 0.1);
            cursor: grab;
        }
        
        .category-item.active {
            background-color: var(--primary-color);
            color: white;
            font-weight: 500;
        }
        
        .category-item.dragging {
            opacity: 0.6;
            cursor: grabbing;
        }
        
        /* 分类项交换动画 */
        .category-item {
            transition: all 0.2s cubic-bezier(0.25, 0.8, 0.25, 1)
        }
        
        /* 分类交换动画类 - 超明显版 */
        .category-item.swap-animation {
            animation: swapMove 0.8s cubic-bezier(0.25, 0.8, 0.25, 1)
            position: relative;
            z-index: 10;
            background-color: rgba(0, 123, 255, 0.3) !important;
        }
        
        @keyframes swapMove {
            0% {
                transform: translateY(0) scale(1);
                opacity: 1;
            }
            30% {
                transform: translateY(-15px) scale(1.1);
                opacity: 0.8;
                box-shadow: 0 10px 20px rgba(0, 123, 255, 0.3);
            }
            70% {
                transform: translateY(5px) scale(1.05);
                opacity: 0.9;
            }
            100% {
                transform: translateY(0) scale(1);
                opacity: 1;
                box-shadow: none;
            }
        }
        
        /* 拖拽目标高亮样式 */
        .category-item.drop-target {
            background-color: rgba(0, 123, 255, 0.2);
            border: 1px dashed var(--primary-color);
            padding: 6px 10px;
        }
        
        .category-item.drop-target-before::before {
            content: '';
            position: absolute;
            top: -2px;
            left: 0;
            right: 0;
            height: 2px;
            background-color: var(--primary-color);
            z-index: 2;
        }
        
        .category-item.drop-target-after::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 2px;
            background-color: var(--primary-color);
            z-index: 2;
        }
        }

        .action-buttons .delete-btn:hover {
            background: var(--danger-color);
            color: white;
        }

        #view-bookmark-modal button, #export-modal button, #help-modal button, #message-form button, #add-form button {
            margin: 5px 0;
            padding: 8px 12px;
            font-size: 12px;
            border-radius: var(--border-radius);
            background: #fff;
            color: var(--primary-color);
            border: 1px solid var(--primary-color);
        }

        #view-bookmark-modal button:hover, #export-modal button:hover, #help-modal button:hover {
            background: var(--primary-color);
            color: white;
        }

        #overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.15);
            z-index: 999;
        }

        #pagination {
                max-width: 1100px;
                margin: 20px auto 0;
                display: flex;
                justify-content: center;
                gap: 10px;
                padding: 10px;
                display: none; /* 默认隐藏，条件满足时显示 */
        }

        #pagination button {
            padding: 5px 12px;
            min-width: 30px;
            text-align: center;
        }

        #pagination button.active {
            background: var(--primary-color);
            color: white;
            border: 1px solid var(--primary-color);
        }

        #pagination button:disabled {
            border-color: #ced4da;
            color: #ced4da;
            cursor: not-allowed;
        }

        #pagination button:disabled:hover {
            background: #fff;
            color: #ced4da;
        }

        #sort-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--card-background);
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 1000;
            width: 300px;
            box-sizing: border-box;
        }

        #sort-modal h3 {
            margin: 0 0 15px;
            font-size: 18px;
            color: var(--primary-color);
            text-align: center;
        }

        #sort-modal button {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            margin: 10px 0;
            padding: 8px 12px;
            font-size: 12px;
            border-radius: var(--border-radius);
            background: #fff;
            color: #000;
            border: 1px solid var(--primary-color);
            transition: var(--transition);
            text-align: center;
        }

        #sort-modal button:hover {
            background: var(--primary-color);
            color: white;
        }

        .message-instructions, .export-tips {
            font-size: 12px;
            color: var(--secondary-color);
            margin-bottom: 15px;
            padding: 10px;
            background-color: #e9ecef;
            border-radius: var(--border-radius);
        }

        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: calc(100vh - var(--toolbar-height));
            text-align: center;
            color: var(--secondary-color);
            padding: 20px;
            position: relative;
            overflow: hidden;
        }

        .empty-state .cartoon-book {
            width: 150px;
            height: 150px;
            position: relative;
            margin-bottom: 30px;
        }

        .empty-state .cartoon-book .book-cover {
            position: absolute;
            width: 100px;
            height: 130px;
            background: #4dabf7;
            border-radius: 5px 15px 15px 5px;
            top: 10px;
            left: 25px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 2;
        }

        .empty-state .cartoon-book .book-spine {
            position: absolute;
            width: 15px;
            height: 130px;
            background: #339af0;
            top: 10px;
            left: 15px;
            z-index: 1;
        }

        .empty-state .cartoon-book .book-page {
            position: absolute;
            width: 90px;
            height: 120px;
            background: #fff;
            border-radius: 5px 10px 10px 5px;
            top: 15px;
            left: 30px;
            z-index: 3;
            animation: flip-page 2.5s infinite ease-in-out;
        }

        .empty-state .cartoon-book .bookmark {
            position: absolute;
            width: 15px;
            height: 40px;
            background: #f783ac;
            top: -5px;
            left: 60px;
            border-radius: 0 0 5px 5px;
            z-index: 4;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .empty-state .ribbons {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
        }

        .empty-state .ribbon {
            position: absolute;
            width: 20px;
            height: 100px;
            background: rgba(247, 131, 172, 0.7);
            border-radius: 5px;
            animation: float 6s infinite ease-in-out;
            transform-origin: center;
        }

        .empty-state .ribbon:nth-child(1) {
            left: 20%;
            top: 10%;
            animation-delay: 0s;
        }

        .empty-state .ribbon:nth-child(2) {
            left: 40%;
            top: 30%;
            animation-delay: 2s;
            background: rgba(77, 171, 247, 0.7);
        }

        .empty-state .ribbon:nth-child(3) {
            left: 60%;
            top: 20%;
            animation-delay: 4s;
            background: rgba(40, 167, 69, 0.7);
        }

        @keyframes flip-page {
            0%, 100% { transform: rotateY(0deg); }
            50% { transform: rotateY(-15deg); }
        }

        @keyframes float {
            0%, 100% {
                transform: translateY(0) rotate(5deg);
                opacity: 0.7;
            }
            50% {
                transform: translateY(-20px) rotate(-5deg);
                opacity: 1;
            }
        }

        .empty-state h2 {
            font-size: 24px;
            margin: 0 0 10px;
            color: var(--text-color);
            z-index: 1;
        }

        .empty-state p {
            font-size: 16px;
            margin: 0 0 20px;
            max-width: 500px;
            line-height: 1.6;
            z-index: 1;
        }

        .empty-state .button-group {
            display: flex;
            gap: 15px;
            z-index: 1;
        }

        .empty-state .action-btn {
            padding: 10px 20px;
            font-size: 14px;
            border-radius: var(--border-radius);
            background: var(--primary-color);
            color: white;
            border: none;
            cursor: pointer;
            transition: var(--transition);
        }

        .empty-state .action-btn:hover {
            background: #0056b3;
            transform: scale(1.05);
        }

        .empty-state .secondary-btn {
            background: #fff;
            color: var(--primary-color);
            border: 1px solid var(--primary-color);
        }

        .empty-state .secondary-btn:hover {
            background: var(--primary-color);
            color: white;
        }

        .hover-area {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 33%;
            z-index: 10;
            pointer-events: auto;
        }
        
        /* 统一主菜单按钮间距 */
        .dropdown {
            margin-right: 15px;
        }
        
        /* 搜索按钮与其他主菜单按钮间距统一 */
        #search-btn {
            margin-right: 15px;
        }
        
        /* 修正子菜单位置，确保在主菜单正下方 */
        .dropdown-content {
            left: 50%;
            transform: translateX(-50%) translateY(-5px);
            width: 130px;
            top: 100%;
            margin-top: 2px;
        }
    

        /* 确保保存/取消按钮默认隐藏 */
        #save-message-btn, #cancel-message-btn {
            display: none !important;
        }
        /* 仅在特定模态框内显示 */
        #message-form:has(style*="display: block") #save-message-btn,
        #message-form:has(style*="display: block") #cancel-message-btn {
            display: inline-block !important;
        }
        
        
        #view-bookmark-modal-header h3 {
            margin: 0;
            color: var(--text-color);
            font-size: 18px;
        }
        
        
        #view-bookmark-close-btn {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: var(--text-color);
            padding: 5px 10px;
            border-radius: var(--border-radius);
            transition: background-color 0.2s;
        }
        
        #view-bookmark-close-btn:hover {
            background-color: rgba(0,0,0,0.1);
        }

        /* 统一的书签详情弹窗底部样式 */
        #view-bookmark-modal-footer {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #eee;
            display: flex;
            justify-content: center;
        }

        /* 统一的书签详情弹窗内容样式 */
        #view-bookmark-modal-content {
            flex: 1;
            overflow-y: auto;
            padding-bottom: 10px;
        }

        /* 统一的书签详情弹窗头部样式 */
        #view-bookmark-modal-header {
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
            position: relative;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
</style>
</head>
<body>
    <div id="toolbar">
        <div id="title">书签管理器</div>
        <button id="toggle-sidebar-btn" onclick="toggleSidebar()">➤</button>
        <div id="controls" style="margin-left: 10px;">
            <!-- 撤销按钮和完成按钮移到主工具栏 -->
            <button id="undo-btn" onclick="undoDelete()" style="display: none; margin: 0 8px;">↩️ 撤销</button>
            <button id="done-btn" onclick="toggleEditMode()" style="display: none; margin: 0 8px;">✅ 完成</button>
            <button id="batch-delete-btn" class="batch-delete-btn" onclick="batchDeleteBookmarks()" style="display: none; margin: 0 8px;">🗑️ 批量删除</button>
            
            <!-- 搜索按钮作为主菜单 -->
            <button id="search-btn" onclick="showSearchModal()" class="dropbtn">🔍 搜索</button>
            
            <!-- 操作主菜单 -->
            <div class="dropdown">
                <button class="dropbtn">📋 操作 ▾</button>
                <div class="dropdown-content">
                    <button onclick="toggleAddForm(true)">➕ 添加书签</button>
                    <button onclick="showExportModal()">📤 导出书签</button>
                    <button onclick="document.getElementById('import-file').click()">📥 导入书签</button>
                    <input type="file" id="import-file" style="display: none;" accept=".json,.txt,.html" onchange="importBookmarks(event)">
                </div>

            </div>
            
            <!-- 数据主菜单 -->
            <div class="dropdown">
                <button class="dropbtn">📊 数据 ▾</button>
                <div class="dropdown-content">
                    <button id="edit-mode-btn" onclick="toggleEditMode()">✏️ 编辑书签</button>
                    <button id="delete-page-btn" class="delete-btn" onclick="deletePageBookmarks()">🗑️ 删除本页书签</button>
                    <button id="delete-all-btn" class="delete-btn" onclick="deleteAllBookmarks()">🗑️ 删除全部书签</button>
                </div>
            </div>
            
            <!-- 工具菜单 -->
            <div class="dropdown">
                <button class="dropbtn">🛠️ 工具 ▾</button>
                <div class="dropdown-content">
                    <button id="sort-btn" onclick="showSortModal()">📏 书签排序</button>
                    <button onclick="showHelpModal()">📚 使用帮助</button>
                    <button onclick="toggleMessageForm()">📝 留言板</button>
                </div>
            </div>
        </div>
        </div>
        </div>
        </div>
    </div>
    </div>
    <div id="loading-indicator" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(255, 255, 255, 0.9); padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); z-index: 2000;">
        <p>正在加载书签，请稍候...</p>
    </div>
    <div id="content-wrapper">
                <div id="sidebar">
                        <h2>分类</h2>
                        <div id="categories"></div>
                </div>
                <div id="main-content">
        <!-- 测试按钮已移除，防止自动触发多个弹窗 -->
                        <div id="tips">您可以添加、编辑、删除和拖动排序书签。使用“导出书签”保存数据到 bookmarks.json、txt 或 html 文件，html 文件可直接导入浏览器。文件将保存到您的下载目录，请手动移动到程序所在文件夹与他人分享。导入时将文件放入同一目录并点击“导入书签”加载。</div>
                        <div id="container">
                                <div id="bookmarks" class="bookmark-grid"></div>
                                <div id="stats"></div>
                                <div id="pagination"></div>
                        </div>
                </div>
        </div>

    <div id="overlay" onclick="hideAllModals()"></div>
    
    <!-- 排序弹窗 -->
    <div id="sort-modal">
        <h3>书签排序</h3>
        <button onclick="applySort('added-desc')">按添加日期（新到旧）</button>
        <button onclick="applySort('added-asc')">按添加日期（旧到新）</button>
        <button onclick="applySort('title-asc')">按标题（A-Z）</button>
        <button onclick="applySort('title-desc')">按标题（Z-A）</button>
        <button onclick="hideSortModal()">❌ 关闭</button>
    </div>
    
    <!-- 添加/编辑书签弹窗 -->
    <div id="add-form">
        <h3>添加/编辑书签</h3>
        <div class="form-content">
            <!-- 左侧表单区域 -->
            <div class="form-left">
                <div class="form-group">
                    <label>名称:</label>
                    <input type="text" id="name" placeholder="请输入书签名称">
                </div>
                <div class="form-group">
                    <label>链接:</label>
                    <input type="text" id="url" placeholder="请输入链接 (可选，如 https://example.com)">
                </div>
                <div class="form-group">
                    <label>简介:</label>
                    <textarea id="desc" placeholder="请输入简介（可选）"></textarea>
                </div>
            </div>
            
            <!-- 右侧分类选择区域 -->
            <div class="form-right">
                <div class="form-group">
                    <label>分类:</label>
                    <input type="text" id="category" list="category-list" placeholder="输入或选择分类">
                    <datalist id="category-list"></datalist>
                </div>
                
                <!-- 现有分组蓝色虚线框 -->
                <div class="category-section">
                    <h4>现有分组</h4>
                    <div class="recent-categories">
                        <div id="category-tags" class="category-tags"></div>
                        <div id="no-categories-message" class="no-categories-message" style="display: none;">
                            暂无分组，请手动输入
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="form-buttons">
            <button onclick="saveBookmark()">💾 保存</button>
            <button onclick="toggleAddForm(false)">❌ 取消</button>
        </div>
    </div>
    
    <!-- 留言板弹窗已移除重复定义，保留在页面底部带有display: none样式的版本 -->
    

    
    <!-- 书签详情弹窗 -->
    <div id="view-bookmark-modal" style="display: none;">
                <div id="view-bookmark-modal-header">
            <h3>书签详情</h3>
            <button id="view-bookmark-close-btn" onclick="hideBookmarkModal()">×</button>
        </div>
        <div id="view-bookmark-modal-content">
            <div id="bookmark-details"></div>
        </div>
                <div id="view-bookmark-modal-footer">
            <!-- 关闭按钮已移至弹窗顶部 -->
        </div>
    </div>
    

            </div>
        </div>
    </div>
    <!-- 导出书签弹窗 -->
    <div id="export-modal">
        <h3>导出书签和留言</h3>
        <div class="form-group">
            <label>文件名:</label>
            <input type="text" id="export-filename" placeholder="bookmarks_YYYY.MM.DD">
        </div>
        <button onclick="exportBookmarks('json')">导出为 JSON (推荐，完整备份含书签和留言)</button>
        <button onclick="exportBookmarks('txt')">导出为 TXT (仅书签和留言，适合阅读)</button>
        <button onclick="exportBookmarks('html')">导出为 HTML (仅书签，可导入浏览器)</button>
        <p class="export-tips">提示：文件将保存到您的下载目录。建议使用 JSON 格式进行完整备份。</p>
    </div>

    <!-- 搜索模态框 -->
    <div id="search-modal" style="display: none;">
        <div id="search-modal-header">
            <h3>搜索书签</h3>
        </div>
        <div id="search-modal-content">
            <div class="search-input-container">
                <input type="text" id="search-modal-input" placeholder="请输入书签名称" autofocus>
                <button id="search-modal-submit" onclick="performModalSearch()">搜索</button>
                <button id="search-modal-close" onclick="hideSearchModal()">关闭</button>
            </div>
            <div id="search-results"></div>
            <div id="no-search-results">未找到匹配的书签</div>
        </div>
    </div>
    <!-- 使用帮助弹窗 -->
<div id="help-modal" style="display: none;">
    <div id="help-modal-header">
        <h3>使用帮助</h3>
    </div>
    <div id="help-modal-content">
        <div id="help-content">
        <h4>什么是书签管理器？</h4>
        <p>这是一个强大的离线书签管理工具，帮助您在本地整理书签和留言，无需联网即可使用。支持分类管理、搜索等多种功能，适合个人使用或团队共享。</p>
        
        <hr>

        <h4>主要功能</h4>
        <ul>
            <li><strong>添加书签</strong>：点击“添加书签”，填写名称、链接（可选）、简介和分类，按回车键或点击“保存”快速添加。</li>
            <li><strong>编辑与删除</strong>：进入“编辑书签”模式，可修改或删除书签，支持批量删除本页或选中书签，并可撤销操作。删除后侧边栏分组自动更新。</li>
            <li><strong>分类管理</strong>：左侧分类栏显示所有分组，鼠标悬浮显示完整名称，点击切换显示内容。</li>
            <li><strong>拖拽排序</strong>：支持书签卡片和分类的拖拽交换位置。拖动书签卡片时，当鼠标靠近目标卡片（上下左右20px范围内），目标卡片会显示蓝色虚线提示框，松开鼠标即可完成位置交换。拖拽操作具有动画效果，提升操作体验。</li>
            <li><strong>搜索功能</strong>：在搜索框输入书签名称，实时筛选匹配结果。</li>
            <li><strong>留言板</strong>：双击留言区域编辑内容，可用于记录笔记、待办事项或团队消息，导入时追加新内容，重复跳过。</li>
            <li><strong>导出与导入</strong>：
                <ul>
                    <li><strong>JSON</strong>：完整备份书签和留言，推荐用于数据迁移。</li>
                    <li><strong>TXT</strong>：格式为“名称|URL|简介|分组”，每行一条，支持导入和查看，重复书签（URL 相同）跳过。</li>
                    <li><strong>HTML</strong>：浏览器兼容格式，可直接导入Chrome、Edge等浏览器，仅含书签。</li>
                </ul>
            </li>
        </ul>
        
        <hr>

        <h4>操作提示</h4>
        <p>所有数据存储在本地浏览器中（localStorage），容量有限（约4MB）。建议定期导出备份，避免因清空缓存或浏览器限制导致数据丢失。</p>
        
        <p>快捷键支持：
            <ul>
                <li><strong>Ctrl + S</strong>：打开添加书签窗口。</li>
                <li><strong>Enter</strong>：在添加/编辑书签窗口中快速保存。</li>
                <li><strong>Esc</strong>：关闭所有弹窗并退出编辑模式。</li>
            </ul>
        </p>
        
        <p><strong>拖拽提示</strong>：拖拽书签卡片时，请将鼠标移动到卡片上方并按住左键，当靠近目标卡片时，目标卡片会显示蓝色虚线提示框，此时松开鼠标即可完成位置交换。优化后的拖拽检测范围扩大至上下左右各20px，使操作更加灵敏。</p>
        
        <hr>

        <h4>使用示例</h4>
        <p><strong>场景1：个人收藏</strong><br>将常用网站（如“GitHub”）添加书签，分类为“开发工具”，添加简介“代码托管平台”。通过搜索“Git”快速找到。</p>
        <p><strong>场景2：团队共享</strong><br>导出书签为JSON或TXT文件，放入共享文件夹，团队成员导入后即可使用相同书签集。留言板可记录更新日志。</p>
        
        <hr>

        <h4>常见问题</h4>
        <ul>
            <li><strong>如何分享书签？</strong> 导出后将文件手动移动到程序文件夹或云盘，与他人共享。</li>
            <li><strong>导入失败怎么办？</strong> 检查文件格式（仅支持 .json、.txt、.html）是否正确，确保文件未损坏。</li>
            <li><strong>数据丢失怎么办？</strong> 检查是否清空了浏览器缓存，建议恢复前导出的备份文件。</li>
            <li><strong>拖拽不灵敏怎么办？</strong> 确保鼠标指针在书签卡片上按住左键，缓慢移动到目标位置附近（20px范围内），蓝色虚线提示框会更灵敏地显示。</li>
            <li><strong>如何删除空分类？</strong> 删除分类下的所有书签后，空分类会自动从侧边栏移除。</li>
        </ul>
        
        <hr>

        <h4>高级技巧</h4>
        <ul>
            <li><strong>批量整理</strong>：进入编辑模式，勾选多张卡片后批量删除，节省时间。</li>
            <li><strong>自定义分类</strong>：添加书签时输入新分类名，自动创建新分组。</li>
            <li><strong>快速浏览</strong>：鼠标悬停卡片底部三分之一区域，翻转查看完整简介。</li>
            <li><strong>标签页预览</strong>：点击书签卡片可在新标签页中打开链接，无需离开书签管理器页面。</li>
            <li><strong>数据安全</strong>：定期导出为JSON格式并保存到多个位置，确保数据安全。建议每月至少备份一次。</li>
            <li><strong>优化性能</strong>：当书签数量过多时，使用分类功能将书签分散到不同分组，可提高加载和搜索速度。</li>
        </ul>
        
        <hr>

        <h4>数据存储说明</h4>
        <p>本工具使用浏览器的localStorage进行数据存储，具有以下特点：</p>
        <ul>
            <li>数据仅存储在本地，不会上传到任何服务器，保障隐私安全。</li>
            <li>不同浏览器之间数据不共享，更换浏览器需要重新导入书签。</li>
            <li>清除浏览器缓存或隐私数据可能导致存储的数据丢失。</li>
            <li>存储空间有限，建议书签数量不超过1000条，以免影响性能。</li>
        </ul>
        
        <p><strong>localStorage存储方式的主要缺点：</strong></p>
        <ul>
            <li><strong>存储容量有限</strong>：通常每个域名下只有约5-10MB的存储空间，对于大量书签数据可能不足。</li>
            <li><strong>数据易丢失</strong>：清除浏览器缓存、卸载浏览器、使用隐私模式或浏览器重置都可能导致数据丢失。</li>
            <li><strong>跨浏览器不兼容</strong>：数据仅保存在当前使用的浏览器中，更换浏览器或设备需要重新导入数据。</li>
            <li><strong>仅支持字符串格式</strong>：所有数据必须序列化为字符串存储，复杂数据结构需要额外处理。</li>
            <li><strong>安全性问题</strong>：存储在客户端的明文数据可能被恶意脚本访问（存在XSS风险）。</li>
            <li><strong>同步操作阻塞</strong>：读写操作是同步的，大量数据操作可能阻塞浏览器主线程，影响用户体验。</li>
            <li><strong>无自动备份机制</strong>：数据不会自动备份，需要用户手动导出保存。</li>
            <li><strong>无过期机制</strong>：存储的数据不会自动过期，需要手动管理数据生命周期。</li>
        </ul>
        
        <p class="important-tip">提示：为避免数据丢失，建议您定期导出书签数据并保存到多个安全位置。建议每月至少备份一次，特别是在进行浏览器升级或更换设备前。</p>
    <div class="form-buttons" style="margin-top: 10px;">
            <button onclick="hideHelpModal()" style="margin: 4px 0; padding: 6px 12px; font-size: 12px; border-radius: var(--border-radius); background: #fff; color: var(--primary-color); border: 1px solid #91d5ff;">关闭</button>
        </div>
    </div>
    </div>
</div>
                </div>
            </div>
        </div>
        <div class="form-buttons" style="display: none;">
            <button onclick="saveBookmark()">💾 保存</button>
            <button onclick="toggleAddForm(false)">❌ 取消</button>
        </div>
    </div>
    <!-- 留言板弹窗已禁用 -->
    <div id="message-form" style="display: none;">
        <div id="message-form-header">
            <h3>留言板</h3>
        </div>
        <div id="message-form-content">
            <p class="message-instructions">提示：双击下方文本区域即可编辑留言，保存后可在下次打开时查看。所有留言存储在本地，定期导出备份以防丢失。</p>
        <div class="form-group">
            <label>留言内容</label>
            <textarea id="message-input" placeholder="双击此处编辑留言..." readonly></textarea>
        </div>
        <div class="form-buttons">
            <button id="save-message-btn" style="display: none;" onclick="saveMessage()">保存</button>
            <button id="cancel-message-btn" style="display: none;" onclick="cancelMessageEdit()">取消</button>
            <button id="close-message-btn" onclick="hideAllModals()">❌ 关闭</button>
        </div>
        </div>
    </div>


    <script>
        // 用于调试的日志函数
        function debugLog(message) {
            console.log(message);
            // 发送日志到服务器，以便在终端中查看
            const xhr = new XMLHttpRequest();
            xhr.open('GET', `/debug?message=${encodeURIComponent(message)}`, true);
            xhr.send();
        }
        const state = {
                bookmarks: [],
                message: '',
                lastDeletedBookmark: null,
                lastDeletedIndex: null,
                filteredBookmarks: [],
                selectedCategory: '全部书签',
                editingIndex: null,
                isEditMode: false,
                selectedBookmarks: [],
                currentPage: 1,
                categories: new Set(['全部书签']),
                isRendering: false,
                isImporting: false
        };

        const MAX_BOOKMARKS = 1000;
        const MAX_STORAGE_SIZE = 4 * 1024 * 1024;

        function initializeBookmarkBackgrounds() {
                let updated = false;
                state.bookmarks.forEach(bookmark => {
                        if (!bookmark.background) {
                                bookmark.background = getRandomGradient();
                                updated = true;
                        }
                });
                if (updated) {
                        saveToLocalStorageImmediately();
                }
        }

        // 防抖处理的本地存储保存函数
        let saveTimeout;
        let pendingSaveData = null;
        
        // 原始保存函数，实际执行localStorage写入
        function _saveToLocalStorageInternal() {
                try {
                        // 使用pendingSaveData（如果存在），否则使用当前state
                        const data = pendingSaveData || {
                                bookmarks: state.bookmarks,
                                message: state.message
                        };
                        
                        // 重置待保存数据
                        pendingSaveData = null;
                        
                        const serializedData = JSON.stringify(data);
                        if (serializedData.length > MAX_STORAGE_SIZE) {
                                alert('数据量过大，无法保存。请删除部分书签或留言后再试。');
                                return false;
                        }
                        
                        localStorage.setItem('bookmarkData', serializedData);
                        return true;
                } catch (e) {
                        console.error('保存数据失败：', e);
                        alert('保存数据失败，请检查浏览器存储空间或权限。');
                        return false;
                }
        }
        
        // 公共API函数，带防抖处理
        function saveToLocalStorage() {
                // 清除之前的定时器
                if (saveTimeout) {
                        clearTimeout(saveTimeout);
                }
                
                // 设置新的定时器，延迟执行保存操作
                // 注意：这个函数的返回值现在只表示保存操作已被调度，而不是实际保存成功
                // 实际保存结果需要在回调中处理，但为了兼容现有代码，我们暂时返回true
                saveTimeout = setTimeout(() => {
                        _saveToLocalStorageInternal();
                }, 20); // 200毫秒防抖延迟
                
                return true;
        }
        
        // 立即保存函数（用于需要立即持久化的操作）
        function saveToLocalStorageImmediately() {
                if (saveTimeout) {
                        clearTimeout(saveTimeout);
                }
                return _saveToLocalStorageInternal();
        }

        function loadBookmarks() {
                // 将loadingIndicator声明在函数顶部，确保在finally块中可访问
                let loadingIndicator = document.getElementById('loading-indicator');
                if (loadingIndicator) loadingIndicator.style.display = 'block';

                try {
                        // 检查localStorage是否可用
                        if (typeof localStorage === 'undefined') {
                                throw new Error('浏览器不支持本地存储');
                        }
                        
                        // 检查localStorage是否被禁用
                        try {
                                localStorage.setItem('test_storage', 'test');
                                localStorage.removeItem('test_storage');
                        } catch (storageError) {
                                throw new Error('本地存储功能被禁用，请检查浏览器设置');
                        }
                        
                        const storedData = localStorage.getItem('bookmarkData');
                        if (!storedData) {
                                console.log('没有找到存储的书签数据，初始化空书签列表');
                                state.bookmarks = [];
                                state.message = '';
                        } else {
                                try {
                                        const data = JSON.parse(storedData);
                                        if (!data || typeof data !== 'object') {
                                                throw new Error('存储数据格式不正确');
                                        }
                                        state.bookmarks = Array.isArray(data.bookmarks) ? data.bookmarks.map(b => ({
                                                name: b.name || '未命名',
                                                url: b.url || '',
                                                desc: b.desc || '',
                                                category: b.category || '默认分组',
                                                background: b.background || getRandomGradient(),
                                                added: b.added || Date.now()
                                        })) : [];
                                        state.message = typeof data.message === 'string' ? data.message : '';
                                } catch (parseError) {
                                        console.warn('解析存储数据时出错，尝试修复...', parseError);
                                        // 尝试从损坏的JSON中恢复部分数据
                                        try {
                                                // 更宽松的解析策略 - 尝试提取有效的bookmarks数组
                                                const partialMatch = storedData.match(/"bookmarks"\s*:\s*\[([\s\S]*?)\]/);
                                                if (partialMatch && partialMatch[1]) {
                                                        try {
                                                                // 尝试解析bookmarks数组部分
                                                                const partialBookmarks = JSON.parse(`[${partialMatch[1]}]`);
                                                                if (Array.isArray(partialBookmarks)) {
                                                                        state.bookmarks = partialBookmarks.map(b => ({
                                                                                name: b.name || '未命名',
                                                                                url: b.url || '',
                                                                                desc: b.desc || '',
                                                                                category: b.category || '默认分组',
                                                                                background: b.background || getRandomGradient(),
                                                                                added: b.added || Date.now()
                                                                        }));
                                                                        console.info('已成功恢复部分书签数据');
                                                                }
                                                        } catch (partialError) {
                                                                console.error('无法恢复部分数据:', partialError);
                                                                state.bookmarks = [];
                                                                state.message = '';
                                                        }
                                                } else {
                                                        throw new Error('无法提取有效数据');
                                                }
                                        } catch (recoveryError) {
                                                console.error('数据恢复失败:', recoveryError);
                                                state.bookmarks = [];
                                                state.message = '';
                                        }
                                }
                        }
                        
                        // 确保数据完整性
                        if (!Array.isArray(state.bookmarks)) {
                                console.warn('书签数据格式异常，重置为空数组');
                                state.bookmarks = [];
                        }
                        
                        initializeBookmarkBackgrounds();
                        updateCategoryFilter();
                        filterBookmarks();
                        renderCategories();
                        renderBookmarks();
                } catch (e) {
                        console.error('加载数据失败：', e);
                        state.bookmarks = [];
                        state.message = '';
                        alert('加载书签失败，已重置为空。请检查存储数据或导入备份。');
                } finally {
                        if (loadingIndicator) loadingIndicator.style.display = 'none';
                }
        }

        // 优化的防抖函数实现，确保正确清理定时器并避免闭包陷阱
        // 防抖函数 - 限制函数在短时间内的重复执行，避免性能浪费
        // func: 要执行的函数
        // wait: 等待时间(毫秒)
        function debounce(func, wait) {
                let timeout; // 用于存储定时器ID
                return function executedFunction(...args) {
                        // 延迟执行的函数
                        const later = () => {
                                clearTimeout(timeout); // 清除定时器
                                func.apply(this, args); // 执行原函数，保留this上下文和参数
                        };
                        clearTimeout(timeout); // 每次调用先清除之前的定时器
                        timeout = setTimeout(later, wait); // 设置新的定时器
                };
        }

        function getRandomGradient() {
                const colors = [
                        '#FFD1DC', '#B9E4C9', '#C9E4FF', '#FFF3B0', '#E6D7FF'
                ];
                const angle = Math.floor(Math.random() * 360);
                const color1 = colors[Math.floor(Math.random() * colors.length)];
                let color2 = colors[Math.floor(Math.random() * colors.length)];
                while (color2 === color1) {
                        color2 = colors[Math.floor(Math.random() * colors.length)];
                }
                return `linear-gradient(${angle}deg, ${color1}, ${color2})`;
        }

        function getCategoryColor(category) {
                const colors = [
                        '#FFE4E6', '#DCEBFF', '#E0FFD9', '#FFF2DF', '#F2EFFF', // 浅色调整
                        '#FDF6C8', '#F4E3FF', '#E3F5F8', '#FFDDDD', '#E8E8E8'
                ];
                const index = category.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0) % colors.length;
                return colors[index];
        }

        function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
        }

        
        // 弹窗基础函数
        function showModal(modalId) {
                const modal = document.getElementById(modalId);
                if (modal) {
                        // 在打开新弹窗前，关闭其他弹窗
                        // 但要保留search-modal和view-bookmark-modal的共存功能
                        const searchModal = document.getElementById('search-modal');
                        const viewBookmarkModal = document.getElementById('view-bookmark-modal');
                        
                        // 检查当前是否有弹窗打开
                        const isSearchModalOpen = searchModal && searchModal.style.display !== 'none';
                        const isViewBookmarkModalOpen = viewBookmarkModal && viewBookmarkModal.style.display !== 'none';
                        
                        // 决定要关闭哪些弹窗
                        if (modalId === 'view-bookmark-modal') {
                                // 如果要打开详情页弹窗，并且搜索弹窗已打开，则只关闭除了搜索弹窗以外的弹窗
                                if (isSearchModalOpen) {
                                        const modalsToClose = [
                                                'add-form', 'help-modal', 'export-modal',
                                                'sort-modal', 'message-form'
                                        ];
                                        modalsToClose.forEach(id => {
                                                const m = document.getElementById(id);
                                                if (m) m.style.display = 'none';
                                        });
                                } else {
                                        // 如果搜索弹窗没打开，则关闭所有其他弹窗
                                        hideAllModalsExcept(['view-bookmark-modal']);
                                }
                        } else if (modalId === 'search-modal') {
                                // 如果要打开搜索弹窗，则关闭除了详情页弹窗以外的弹窗
                                hideAllModalsExcept(['search-modal']);
                        } else {
                                // 对于其他弹窗，关闭所有弹窗，但检查是否有搜索弹窗和详情页弹窗同时打开
                                if (isSearchModalOpen && isViewBookmarkModalOpen) {
                                        // 如果搜索弹窗和详情页弹窗同时打开，则保留它们
                                        hideAllModalsExcept(['search-modal', 'view-bookmark-modal']);
                                } else {
                                        // 否则关闭所有弹窗
                                        hideAllModals();
                                }
                        }
                        
                        // 显示当前弹窗
                        // 对于view-bookmark-modal使用flex布局
                        if (modalId === 'view-bookmark-modal') {
                                modal.style.display = 'flex';
                        } else {
                                modal.style.display = 'block';
                        }
                        document.getElementById('overlay').style.display = 'block';
                }
        }
        
        // 关闭所有弹窗，但保留指定的弹窗
        function hideAllModalsExcept(exceptModalIds) {
                const allModals = [
                        'add-form', 'view-bookmark-modal', 'help-modal', 'export-modal',
                        'sort-modal', 'message-form', 'search-modal'
                ];
                
                allModals.forEach(modalId => {
                        // 只关闭不在exceptModalIds列表中的弹窗
                        if (!exceptModalIds.includes(modalId)) {
                                const modal = document.getElementById(modalId);
                                if (modal) {
                                        modal.style.display = 'none';
                                }
                        }
                });
        }

        function hideModal(modalId) {
                const modal = document.getElementById(modalId);
                if (modal) {
                        modal.style.display = 'none';
                        document.getElementById('overlay').style.display = 'none';
                }
        }

        function hideAllModals() {
                const modals = [
                        'add-form', 'view-bookmark-modal', 'help-modal', 'export-modal',
                        'sort-modal', 'message-form', 'search-modal'
                ];
                modals.forEach(modalId => hideModal(modalId));
                if (typeof toggleEditMode === 'function') {
                        toggleEditMode(false);
                }
        }
        
        // 测试函数已移除，防止自动触发多个弹窗

        // 书签表单相关函数
        function toggleAddForm(show) {
                const form = document.getElementById('add-form');
                const nameInput = document.getElementById('name');
                const urlInput = document.getElementById('url');
                const descInput = document.getElementById('desc');
                const categoryInput = document.getElementById('category');
                
                if (show) {
                        // 先准备表单数据
                        if (state.editingIndex === null) {
                                nameInput.value = '';
                                urlInput.value = '';
                                descInput.value = '';
                                categoryInput.value = '';
                        }
                        updateCategoryDatalist();
                        
                        // 使用showModal函数显示表单，确保先隐藏其他弹窗
                        showModal('add-form');
                        
                        // 聚焦输入框
                        setTimeout(() => {
                                if (nameInput) {
                                        nameInput.focus();
                                }
                        }, 100); // 延迟100毫秒聚焦，确保弹窗已显示
                } else {
                        // 隐藏表单
                        hideModal('add-form');
                        state.editingIndex = null;
                }
        }

        // 更新分类相关功能（仅保留分类标签更新）
        function updateCategoryDatalist() {
                // 检查datalist元素是否存在，如果存在则清空内容
                const datalist = document.getElementById('category-list');
                if (datalist) {
                        datalist.innerHTML = '';
                }
                
                // 同时更新分类标签（显示所有分类）
                updateCategoryTags();
        }
        
        // 确保在DOM加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
                // 书签卡片编辑按钮的统一事件处理
                document.addEventListener('click', function(e) {
                    // 检查是否点击了书签卡片上的编辑按钮
                    const editBtn = e.target.closest('.bookmark-card .edit-btn');
                    if (editBtn) {
                        // 阻止事件冒泡，避免触发其他可能的冲突
                        e.stopPropagation();
                        
                        // 获取对应的书签卡片
                        const bookmarkCard = editBtn.closest('.bookmark-card');
                        if (bookmarkCard) {
                            // 获取书签的全局索引（如果没有data-index属性，使用id）
                            const globalIndex = bookmarkCard.dataset.index ? parseInt(bookmarkCard.dataset.index) : null;
                            
                            if (globalIndex !== null && typeof editBookmark === 'function') {
                                // 调用编辑函数
                                editBookmark(globalIndex);
                            }
                        }
                    }
                });
                updateCategoryDatalist();
        });

        // 更新分类标签显示（显示所有分类，按书签数量排序）
        function updateCategoryTags() {
                const tagsContainer = document.getElementById('category-tags');
                if (!tagsContainer) return;
                
                tagsContainer.innerHTML = '';
                
                // 直接从bookmarks中计算实际存在的分类（不依赖state.categories）
                const categoryMap = new Map();
                
                state.bookmarks.forEach(bookmark => {
                        if (bookmark.category && bookmark.category !== '默认分组') {
                                const count = categoryMap.get(bookmark.category) || 0;
                                categoryMap.set(bookmark.category, count + 1);
                        }
                });
                
                // 创建排序数组
                const categoryCounts = Array.from(categoryMap.entries()).map(([category, count]) => ({
                        category,
                        count
                }));
                
                // 按书签数量降序排序，数量相同则按首字母升序排序
                categoryCounts.sort((a, b) => {
                        if (a.count !== b.count) {
                                return b.count - a.count; // 数量降序
                        }
                        return a.category.localeCompare(b.category); // 首字母升序
                });
                
                // 显示所有分类
                if (categoryCounts.length > 0) {
                        categoryCounts.forEach(({ category }) => {
                                const tag = document.createElement('span');
                                tag.className = 'category-tag';
                                tag.textContent = category;
                                tag.title = category; // 添加title属性用于悬停显示完整名称
                                tag.style.backgroundColor = getCategoryColor(category);
                                tag.addEventListener('click', () => {
                                        document.getElementById('category').value = category;
                                });
                                tagsContainer.appendChild(tag);
                        });
                } else {
                        // 如果没有分类，显示提示文字
                        // 移除可能导致隐藏提示文字的CSS规则的影响
                        const noCategoriesMessage = document.createElement('div');
                        noCategoriesMessage.id = 'no-categories-message';
                        noCategoriesMessage.className = 'no-categories-message';
                        noCategoriesMessage.textContent = '此时没有任何分组';
                        // 确保提示文字始终可见
                        noCategoriesMessage.style.display = 'block';
                        tagsContainer.appendChild(noCategoriesMessage);
                }
        }

        function saveBookmark() {
                const nameInput = document.getElementById('name');
                const urlInput = document.getElementById('url');
                const descInput = document.getElementById('desc');
                const categoryInput = document.getElementById('category');
                if (!nameInput || !urlInput) return;

                const name = nameInput.value.trim();
                const url = urlInput.value.trim();
                const desc = descInput.value.trim();
                const category = categoryInput.value.trim();

                if (!name) {
                        alert('请填写书签名称');
                        return;
                }
                
                // 基本URL验证
                if (url && !url.match(/^https?:\/\//) && !url.match(/^about:/) && !url.match(/^chrome:/)) {
                        // 如果URL不以http/https开头，添加http://
                        alert('请填写有效的URL，建议以http://或https://开头');
                        return;
                }

                const bookmark = {
                        name,
                        url,
                        desc,
                        category: category || '默认分组',
                        background: getRandomGradient(),
                        added: Date.now()
                };

                if (state.editingIndex !== null && state.editingIndex < state.filteredBookmarks.length) {
                        const globalIndex = state.bookmarks.indexOf(state.filteredBookmarks[state.editingIndex]);
                        if (globalIndex !== -1) {
                                bookmark.background = state.bookmarks[globalIndex].background;
                                bookmark.added = state.bookmarks[globalIndex].added;
                                state.bookmarks[globalIndex] = bookmark;
                        }
                } else {
                        state.bookmarks.push(bookmark);
                }

                if (saveToLocalStorageImmediately()) {
                        filterBookmarks();
                        renderBookmarks();
                        renderCategories(); // 添加此行，确保侧边栏更新
                        toggleAddForm(false);
                        nameInput.value = '';
                        urlInput.value = '';
                        descInput.value = '';
                        categoryInput.value = '';
                        state.editingIndex = null;
                }
        }

                
        // 完整的编辑书签函数定义
        function editBookmark(index) {
                // 检查参数是否有效
                if (index === undefined || index === null || index < 0 || index >= state.filteredBookmarks.length) {
                        console.error('无效的书签索引:', index);
                        return;
                }
                
                // 检查是否有其他编辑表单正在显示，如果有则先隐藏
                if (state.editingIndex !== null && state.editingIndex !== index) {
                        console.log('用户正在编辑其他书签，切换到新的编辑项');
                }
                
                // 正常处理编辑操作
                state.editingIndex = index;
                const bookmark = state.filteredBookmarks[index];
                document.getElementById('name').value = bookmark.name;
                document.getElementById('url').value = bookmark.url;
                document.getElementById('desc').value = bookmark.desc;
                document.getElementById('category').value = bookmark.category;
                toggleAddForm(true);
        }

        function deleteBookmark(index) {
                if (index < 0 || index >= state.filteredBookmarks.length) return;
                state.lastDeletedBookmark = { ...state.filteredBookmarks[index] };
                state.lastDeletedIndex = state.bookmarks.indexOf(state.filteredBookmarks[index]);
                state.bookmarks.splice(state.lastDeletedIndex, 1);
                
                if (saveToLocalStorageImmediately()) {
                        filterBookmarks();
                        renderBookmarks();
                        renderCategories();
                        toggleEditMode(true); // 添加此行，保持编辑模式按钮状态
                        document.getElementById('undo-btn').style.display = 'inline-flex';
                        
                        // 5秒后自动隐藏撤销按钮
                        setTimeout(() => {
                                if (document.getElementById('undo-btn').style.display !== 'none') {
                                        document.getElementById('undo-btn').style.display = 'none';
                                        state.lastDeletedBookmark = null;
                                        state.lastDeletedIndex = null;
                                }
                        }, 5000);
                }
        }

        function deletePageBookmarks() {
                if (!confirm('确定要删除本页所有书签吗？此操作不可撤销！')) return;
                const itemsPerPage = getItemsPerPage();
                const startIndex = (state.currentPage - 1) * itemsPerPage;
                const endIndex = Math.min(startIndex + itemsPerPage, state.filteredBookmarks.length);
                const bookmarksToDelete = state.filteredBookmarks.slice(startIndex, endIndex);
                bookmarksToDelete.forEach(bookmark => {
                        const globalIndex = state.bookmarks.indexOf(bookmark);
                        if (globalIndex !== -1) {
                                state.bookmarks.splice(globalIndex, 1);
                        }
                });
                if (saveToLocalStorageImmediately()) {
                        state.currentPage = 1;
                        filterBookmarks();
                        renderBookmarks();
                        renderCategories(); // 添加此行，确保侧边栏更新
                }
        }
        
        // 删除全部书签功能
        function deleteAllBookmarks() {
                // 双重确认，防止误操作
                if (!confirm('警告：您确定要删除所有书签吗？\n此操作将删除所有已保存的书签，且无法恢复！\n请再次确认您的操作。')) {
                        return;
                }
                
                // 清空书签数组
                state.bookmarks = [];
                
                // 保存到本地存储
                if (saveToLocalStorageImmediately()) {
                        // 重置当前页码
                        state.currentPage = 1;
                        // 重新过滤和渲染书签
                        filterBookmarks();
                        renderBookmarks();
                        // 更新侧边栏分类
                        renderCategories();
                        // 关闭编辑模式
                        toggleEditMode(false);
                }
        }

        function batchDeleteBookmarks() {
                if (state.selectedBookmarks.length === 0) {
                        alert('请先选择要删除的书签！');
                        return;
                }
                if (!confirm(`确定要删除 ${state.selectedBookmarks.length} 个选中的书签吗？此操作不可撤销！`)) return;
                state.selectedBookmarks.sort((a, b) => b - a).forEach(index => {
                        state.bookmarks.splice(index, 1);
                });
                state.selectedBookmarks = [];
                if (saveToLocalStorageImmediately()) {
                        filterBookmarks();
                        renderBookmarks();
                        renderCategories(); // 添加此行，确保侧边栏更新
                        toggleEditMode(false);
                }
        }

        function undoDelete() {
                if (state.lastDeletedBookmark && state.lastDeletedIndex !== null) {
                        state.bookmarks.splice(state.lastDeletedIndex, 0, state.lastDeletedBookmark);
                        if (saveToLocalStorageImmediately()) {
                                filterBookmarks();
                                renderBookmarks();
                                state.lastDeletedBookmark = null;
                                state.lastDeletedIndex = null;
                                document.getElementById('undo-btn').style.display = 'none';
                        }
                }
        }

        // 初始化下拉菜单功能
        document.addEventListener('DOMContentLoaded', function() {
                // 获取所有下拉菜单按钮
                const dropdownBtns = document.querySelectorAll('.dropdown .dropbtn');
                
                // 为每个按钮添加点击事件
                dropdownBtns.forEach(btn => {
                        btn.addEventListener('click', function(e) {
                                e.stopPropagation(); // 阻止事件冒泡
                                const dropdown = this.closest('.dropdown');
                                const isOpen = dropdown.classList.contains('open');
                                 
                                // 关闭所有其他打开的菜单
                                document.querySelectorAll('.dropdown.open').forEach(el => {
                                        el.classList.remove('open');
                                });
                                 
                                // 如果当前菜单没打开，则打开它
                                if (!isOpen) {
                                        dropdown.classList.add('open');
                                }
                        });
                });
                
                // 点击页面其他地方关闭所有菜单
                document.addEventListener('click', function() {
                        document.querySelectorAll('.dropdown.open').forEach(dropdown => {
                                dropdown.classList.remove('open');
                        });
                });
                
                // 移除下拉菜单内容区域的自动关闭行为，让功能操作完成后再关闭
                // (各功能按钮会在执行完操作后自行处理菜单状态)
        });
        
        function toggleEditMode(forceState = null) {
                const isEditMode = forceState !== null ? forceState : !state.isEditMode;
                state.isEditMode = isEditMode;
                state.selectedBookmarks = [];
                document.getElementById('edit-mode-btn').style.display = isEditMode ? 'none' : 'block';
                document.getElementById('done-btn').style.display = isEditMode ? 'block' : 'none';
                document.getElementById('batch-delete-btn').style.display = 'none';
                // 确保删除本页书签按钮始终可见
                document.getElementById('delete-page-btn').style.display = 'block';
                const cards = document.querySelectorAll('.bookmark-card');
                cards.forEach(card => {
                        card.classList.toggle('edit-mode', isEditMode);
                        card.draggable = !isEditMode;
                        const mainCard = card.querySelector('.main-card');
                        if (mainCard) {
                                mainCard.classList.remove('flipped');
                        }
                });
                const actionBars = document.querySelectorAll('.action-bar .action-buttons');
                actionBars.forEach(bar => {
                        bar.style.display = isEditMode ? 'flex' : 'none';
                });
                const checkboxes = document.querySelectorAll('.bookmark-checkbox');
                checkboxes.forEach(checkbox => {
                        checkbox.checked = false;
                        checkbox.classList.toggle('visible', isEditMode);
                });
                
                // 关闭所有下拉菜单
                document.querySelectorAll('.dropdown.open').forEach(dropdown => {
                        dropdown.classList.remove('open');
                });
        }

        function toggleBookmarkSelection(globalIndex, isSelected) {
                if (isSelected) {
                        if (!state.selectedBookmarks.includes(globalIndex)) {
                                state.selectedBookmarks.push(globalIndex);
                        }
                } else {
                        state.selectedBookmarks = state.selectedBookmarks.filter(index => index !== globalIndex);
                }
                
                // 根据选中书签的数量切换完成按钮和批量删除按钮
                if (state.isEditMode) {
                    if (state.selectedBookmarks.length > 0) {
                        document.getElementById('done-btn').style.display = 'none';
                        document.getElementById('batch-delete-btn').style.display = 'block';
                    } else {
                        document.getElementById('done-btn').style.display = 'block';
                        document.getElementById('batch-delete-btn').style.display = 'none';
                    }
                }
        }

        function showBookmarkDetails(index) {
                if (index < 0 || index >= state.filteredBookmarks.length) return;
                const bookmark = state.filteredBookmarks[index];
                const details = document.getElementById('bookmark-details');
                const descText = bookmark.desc && bookmark.desc.trim() ? escapeHtml(bookmark.desc) : '暂无简介';
                details.innerHTML = `
                        <div class="form-group"><label>名称:</label><p>${escapeHtml(bookmark.name)}</p></div>
                        <div class="form-group"><label>链接:</label><p><a href="${escapeHtml(bookmark.url)}" target="_blank">${escapeHtml(bookmark.url)}</a></p></div>
                        <div class="form-group"><label>简介:</label><p>${descText}</p></div>
                        <div class="form-group"><label>分类:</label><p>${escapeHtml(bookmark.category)}</p></div>
                        <div class="form-group"><label>添加时间:</label><p>${new Date(bookmark.added).toLocaleString()}</p></div>
                `;
                showModal('view-bookmark-modal');
        }

        function hideBookmarkModal() {
                hideModal('view-bookmark-modal');
        }

        function showExportModal() {
                debugLog(`showExportModal被调用 - 调用栈: ${new Error().stack}`);
                // 设置默认文件名
                const today = new Date();
                const defaultFilename = `bookmarks_${today.getFullYear()}.${String(today.getMonth() + 1).padStart(2, '0')}.${String(today.getDate()).padStart(2, '0')}`;
                document.getElementById('export-filename').value = defaultFilename;
                
                showModal('export-modal');
        }

        function exportBookmarks(format) {
                let filename = document.getElementById('export-filename').value.trim();
                if (!filename) {
                        const now = new Date();
                        const dateStr = `${now.getFullYear()}.${String(now.getMonth() + 1).padStart(2, '0')}.${String(now.getDate()).padStart(2, '0')}`;
                        filename = `bookmarks_${dateStr}`;
                }
                filename = filename.replace(/[^a-zA-Z0-9._-]/g, '_');

                let content, mimeType, extension;
                if (format === 'json') {
                        const data = { bookmarks: state.bookmarks, message: state.message };
                        content = JSON.stringify(data, null, 2);
                        mimeType = 'application/json';
                        extension = 'json';
                } else if (format === 'txt') {
                        content = `书签管理器导出文件 (${new Date().toLocaleString()})\n\n`;
                        content += `=== 留言 ===\n${state.message || '无留言'}\n\n`;
                        content += `=== 书签 ===\n`;
                        state.bookmarks.forEach((bookmark, index) => {
                                content += `\n书签 ${index + 1}:\n`;
                                content += `名称: ${bookmark.name}\n`;
                                content += `链接: ${bookmark.url}\n`;
                                content += `简介: ${bookmark.desc || '无'}\n`;
                                content += `分类: ${bookmark.category}\n`;
                                content += `添加时间: ${new Date(bookmark.added).toLocaleString()}\n`;
                        });
                        mimeType = 'text/plain';
                        extension = 'txt';
                } else if (format === 'html') {
                        content = `<!DOCTYPE NETSCAPE-Bookmark-file-1>
<!-- This is an automatically generated bookmark file -->
<HTML>
<HEAD>
<META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=UTF-8">
<TITLE>Bookmarks</TITLE>
</HEAD>
<BODY>
<H1>Bookmarks</H1>
<DL><p>`;
                        const categories = [...new Set(state.bookmarks.map(b => b.category))];
                        categories.forEach(category => {
                                content += `
        <DT><H3>${escapeHtml(category)}</H3>
        <DL><p>`;
                                state.bookmarks.filter(b => b.category === category).forEach(bookmark => {
                                        content += `
                <DT><A HREF="${escapeHtml(bookmark.url)}">${escapeHtml(bookmark.name)}</A>
                <DD>${escapeHtml(bookmark.desc || '')}`;
                                });
                                content += `
        </DL><p>`;
                        });
                        content += `
</DL><p>
</body>
</HTML>`;
                        mimeType = 'text/html';
                        extension = 'html';
                } else {
                        alert('不支持的导出格式');
                        return;
                }

                // 添加导出确认提示
                if (!confirm(`确定要导出书签为 ${filename}.${extension} 吗？文件将保存到您的默认下载目录。`)) {
                        return; // 用户取消导出
                }

                const blob = new Blob([content], { type: mimeType });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${filename}.${extension}`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                hideModal('export-modal');
        }

        function importBookmarks(event) {
                // 添加event对象存在性检查
                if (!event || !event.target) {
                        alert('导入失败：无法获取文件输入信息');
                        return;
                }
                
                if (state.isImporting) return;
                state.isImporting = true;

                const file = event.target.files[0];
                if (!file) {
                        state.isImporting = false;
                        return;
                }

                const reader = new FileReader();
                reader.onload = function(e) {
                        try {
                                const content = e.target.result;
                                let importedData = { bookmarks: [], message: '' };

                                if (file.name.endsWith('.json')) {
                                        importedData = JSON.parse(content);
                                        if (!importedData || !Array.isArray(importedData.bookmarks)) {
                                                throw new Error('无效的 JSON 文件格式');
                                        }
                                } else if (file.name.endsWith('.txt')) {
                                        const lines = content.split('\n').map(line => line.trim());
                                        let currentBookmark = null;
                                        let messageSection = false;

                                        for (const line of lines) {
                                                if (!line) continue; // 跳过空行
                                                if (line.startsWith('=== 留言 ===')) {
                                                        messageSection = true;
                                                        importedData.message = '';
                                                        continue;
                                                }
                                                if (line.startsWith('=== 书签 ===')) {
                                                        messageSection = false;
                                                        continue;
                                                }
                                                if (messageSection) {
                                                        importedData.message += (importedData.message ? '\n' : '') + line;
                                                        continue;
                                                }

                                                if (line.match(/^书签 \d+:$/)) {
                                                        if (currentBookmark) {
                                                                // 验证并保存上一条书签
                                                                if (currentBookmark.name && currentBookmark.url) {
                                                                        importedData.bookmarks.push(currentBookmark);
                                                                }
                                                        }
                                                        currentBookmark = {};
                                                        continue;
                                                }
                                                if (currentBookmark) {
                                                        if (line.startsWith('名称:')) {
                                                                currentBookmark.name = line.replace('名称:', '').trim() || '未命名';
                                                        } else if (line.startsWith('链接:')) {
                                                                currentBookmark.url = line.replace('链接:', '').trim() || '';
                                                        } else if (line.startsWith('简介:')) {
                                                                currentBookmark.desc = line.replace('简介:', '').trim() === '无' ? '' : line.replace('简介:', '').trim();
                                                        } else if (line.startsWith('分类:')) {
                                                                currentBookmark.category = line.replace('分类:', '').trim() || '默认分组';
                                                        } else if (line.startsWith('添加时间:')) {
                                                                currentBookmark.added = new Date(line.replace('添加时间:', '').trim()).getTime() || Date.now();
                                                        }
                                                }
                                        }
                                        // 处理最后一条书签
                                        if (currentBookmark && currentBookmark.name && currentBookmark.url) {
                                                importedData.bookmarks.push(currentBookmark);
                                        }
                                } else if (file.name.endsWith('.html')) {
                                        try {
                                                const parser = new DOMParser();
                                                const doc = parser.parseFromString(content, 'text/html');
                                                let currentCategory = '默认分组';
                                                
                                                // 先尝试使用标准书签格式解析（NETSCAPE-Bookmark-file-1）
                                                const h3Elements = doc.querySelectorAll('h3');
                                                let foundBookmarks = false;
                                                
                                                if (h3Elements.length > 0) {
                                                        // 按分类分组解析
                                                        h3Elements.forEach(h3 => {
                                                                currentCategory = h3.textContent.trim() || '默认分组';
                                                                const dl = h3.closest('dl');
                                                                if (dl) {
                                                                        const aElements = dl.querySelectorAll('dt > a');
                                                                        aElements.forEach(a => {
                                                                                if (a.closest('h3') !== h3 && a.closest('dl') === dl) {
                                                                                        const name = a.textContent.trim() || '未命名';
                                                                                        const url = a.getAttribute('href') || '';
                                                                                        const title = a.getAttribute('title') || '';
                                                                                        const dd = a.closest('dt').nextElementSibling && a.closest('dt').nextElementSibling.tagName === 'DD'
                                                                                                ? a.closest('dt').nextElementSibling.textContent.trim()
                                                                                                : '';
                                                                                        
                                                                                        importedData.bookmarks.push({
                                                                                                name,
                                                                                                url,
                                                                                                desc: title || dd,
                                                                                                category: currentCategory,
                                                                                                background: getRandomGradient(),
                                                                                                added: Date.now()
                                                                                        });
                                                                                        foundBookmarks = true;
                                                                                }
                                                                        });
                                                                }
                                                        });
                                                }
                                                
                                                // 如果没有找到标准格式的书签，尝试解析普通HTML中的所有链接
                                                if (!foundBookmarks) {
                                                        const aElements = doc.querySelectorAll('a:not([href="#"]):not([href="javascript:void(0)"])');
                                                        aElements.forEach(a => {
                                                                const name = a.textContent.trim() || '未命名';
                                                                const url = a.getAttribute('href') || '';
                                                                if (url && url.length > 1) {
                                                                        importedData.bookmarks.push({
                                                                                name,
                                                                                url,
                                                                                desc: a.getAttribute('title') || '',
                                                                                category: '默认分组',
                                                                                background: getRandomGradient(),
                                                                                added: Date.now()
                                                                        });
                                                                        foundBookmarks = true;
                                                                }
                                                        });
                                                }
                                                
                                                if (!foundBookmarks) {
                                                        throw new Error('无效的 HTML 文件格式，未找到书签数据');
                                                }
                                        } catch (htmlParseError) {
                                                console.error('HTML解析错误:', htmlParseError);
                                                throw new Error('解析HTML书签文件失败: ' + htmlParseError.message);
                                        }
                                        if (importedData.bookmarks.length === 0) {
                                                throw new Error('无效的 HTML 文件格式，未找到书签数据');
                                        }
                                } else {
                                        throw new Error('不支持的文件格式，仅支持 .json、.txt 和 .html');
                                }

                                let newBookmarks = 0, duplicateBookmarks = 0;
                                const existingUrls = new Set(state.bookmarks.map(b => b.url));
                                importedData.bookmarks.forEach(b => {
                                        if (!existingUrls.has(b.url)) {
                                                state.bookmarks.push({
                                                        name: b.name,
                                                        url: b.url,
                                                        desc: b.desc || '',
                                                        category: b.category || '默认分组',
                                                        background: b.background || getRandomGradient(),
                                                        added: b.added || Date.now()
                                                });
                                                existingUrls.add(b.url);
                                                newBookmarks++;
                                        } else {
                                                duplicateBookmarks++;
                                        }
                                });

                                let newMessage = '', duplicateMessage = '';
                                if (importedData.message) {
                                        const existingMessage = state.message || '';
                                        if (existingMessage.includes(importedData.message)) {
                                                duplicateMessage = '留言板内容重复，未追加';
                                        } else {
                                                state.message = existingMessage ? `${existingMessage}\n${importedData.message}` : importedData.message;
                                                newMessage = '留言板内容已追加';
                                        }
                                }

                                if (state.bookmarks.length > MAX_BOOKMARKS) {
                                        alert(`书签数量超过上限 (${MAX_BOOKMARKS})，请减少后重试。`);
                                } else if (saveToLocalStorageImmediately()) {
                                        state.currentPage = 1;
                                        filterBookmarks();
                                        renderBookmarks();
                                        renderCategories();
                                        alert(`导入完成！\n书签：新增 ${newBookmarks} 条，重复 ${duplicateBookmarks} 条跳过\n${newMessage || duplicateMessage || '无留言板内容'}`);
                                        if (navigator.onLine) {
                                                setTimeout(() => renderBookmarks(), 0);
                                        }
                                }
                        } catch (err) {
                                console.error('导入失败：', err);
                                alert('导入失败：' + err.message);
                        } finally {
                                state.isImporting = false;
                                // 确保event和event.target不为null
                                if (event && event.target) {
                                        event.target.value = '';
                                }
                        }
                };
                reader.onerror = function() {
                        alert('读取文件失败，请检查文件是否损坏。');
                        state.isImporting = false;
                        // 确保event和event.target不为null
                        if (event && event.target) {
                                event.target.value = '';
                        }
                };
                reader.readAsText(file);
        }

        function showSortModal() {
                showModal('sort-modal');
        }

        function hideSortModal() {
                hideModal('sort-modal');
        }

        function applySort(criteria) {
                if (criteria === 'added-desc') {
                        state.bookmarks.sort((a, b) => b.added - a.added);
                } else if (criteria === 'added-asc') {
                        state.bookmarks.sort((a, b) => a.added - b.added);
                } else if (criteria === 'title-asc') {
                        state.bookmarks.sort((a, b) => a.name.localeCompare(b.name));
                } else if (criteria === 'title-desc') {
                        state.bookmarks.sort((a, b) => b.name.localeCompare(a.name));
                }
                saveToLocalStorageImmediately();
                filterBookmarks();
                renderBookmarks();
                hideSortModal();
        }

        // 显示使用帮助弹窗
        function showHelpModal() {
                debugLog(`showHelpModal被调用 - 调用栈: ${new Error().stack}`);
                showModal('help-modal');
        }

        function hideHelpModal() {
                hideModal('help-modal');
        }

        // 显示留言板弹窗
        function toggleMessageForm() {
                debugLog(`toggleMessageForm被调用 - 调用栈: ${new Error().stack}`);
                const messageInput = document.getElementById('message-input');
                messageInput.value = state.message || '';
                messageInput.setAttribute('readonly', 'readonly');
                document.getElementById('save-message-btn').style.display = 'none';
                document.getElementById('cancel-message-btn').style.display = 'none';
                document.getElementById('close-message-btn').style.display = 'block';
                showModal('message-form');
        }

        function saveMessage() {
                const messageInput = document.getElementById('message-input');
                state.message = messageInput.value.trim();
                if (saveToLocalStorageImmediately()) {
                        messageInput.setAttribute('readonly', 'readonly');
                        document.getElementById('save-message-btn').style.display = 'none';
                        document.getElementById('cancel-message-btn').style.display = 'none';
                        document.getElementById('close-message-btn').style.display = 'block';
                }
        }

        function cancelMessageEdit() {
                const messageInput = document.getElementById('message-input');
                messageInput.value = state.message || '';
                messageInput.setAttribute('readonly', 'readonly');
                document.getElementById('save-message-btn').style.display = 'none';
                document.getElementById('cancel-message-btn').style.display = 'none';
                document.getElementById('close-message-btn').style.display = 'block';
        }

        // 自动保存计时器
        let autoSaveTimer = null;
        
        // 创建保存成功提示元素
        function createSaveNotification() {
                let notification = document.getElementById('save-notification');
                if (!notification) {
                        notification = document.createElement('div');
                        notification.id = 'save-notification';
                        notification.style.position = 'fixed';
                        notification.style.bottom = '20px';
                        notification.style.right = '20px';
                        notification.style.background = 'rgba(40, 167, 69, 0.9)';
                        notification.style.color = 'white';
                        notification.style.padding = '10px 20px';
                        notification.style.borderRadius = '5px';
                        notification.style.boxShadow = '0 4px 12px rgba(0,0,0,0.15)';
                        notification.style.zIndex = '2000';
                        notification.style.fontSize = '14px';
                        notification.style.opacity = '0';
                        notification.style.transition = 'opacity 0.3s ease';
                        document.body.appendChild(notification);
                }
                return notification;
        }
        
        // 显示保存成功提示
        function showSaveNotification() {
                const notification = createSaveNotification();
                notification.textContent = '已自动保存';
                notification.style.opacity = '1';
                
                setTimeout(() => {
                        notification.style.opacity = '0';
                }, 2000);
        }
        
        // 重置自动保存计时器
        function resetAutoSaveTimer() {
                if (autoSaveTimer) {
                        clearTimeout(autoSaveTimer);
                }
                
                autoSaveTimer = setTimeout(() => {
                        const messageInput = document.getElementById('message-input');
                        // 只有在编辑模式下且内容有变化才自动保存
                        if (!messageInput.hasAttribute('readonly')) {
                                saveMessage();
                                showSaveNotification();
                        }
                }, 3000); // 3秒后自动保存
        }
        
        document.getElementById('message-input').addEventListener('dblclick', () => {
                const messageInput = document.getElementById('message-input');
                messageInput.removeAttribute('readonly');
                messageInput.focus();
                document.getElementById('save-message-btn').style.display = 'block';
                document.getElementById('cancel-message-btn').style.display = 'block';
                document.getElementById('close-message-btn').style.display = 'none';
        });
        
        // 添加内容变化事件监听，触发自动保存
        document.getElementById('message-input').addEventListener('input', function() {
                // 只在编辑模式下触发自动保存
                const messageInput = document.getElementById('message-input');
                if (!messageInput.hasAttribute('readonly')) {
                        resetAutoSaveTimer();
                }
        });



        function toggleSidebar() {
                const sidebar = document.getElementById('sidebar');
                const toggleBtn = document.getElementById('toggle-sidebar-btn');
                sidebar.classList.toggle('wide');
                
                if (sidebar.classList.contains('wide')) {
                        // 侧边栏展开状态
                        toggleBtn.textContent = '➤';
                        toggleBtn.style.transform = 'rotate(180deg)';
                } else {
                        // 侧边栏折叠状态（完全隐藏）
                        toggleBtn.textContent = '◄';
                        toggleBtn.style.transform = 'rotate(0deg)';
                }
        }

        function renderCategories() {
                const categoriesContainer = document.getElementById('categories');
                const allCategories = new Set(state.bookmarks.map(bookmark => bookmark.category));
                
                // 默认排序
                const sortedCategories = ['全部书签', ...Array.from(allCategories).sort()];
                
                state.categories = new Set(sortedCategories);

                // 获取现有分类项
                const existingItems = new Map();
                categoriesContainer.querySelectorAll('.category-item').forEach(item => {
                        const category = item.textContent;
                        existingItems.set(category, item);
                });

                // 更新或创建分类项
                sortedCategories.forEach(category => {
                        let item = existingItems.get(category);
                        const isNew = !item;

                        if (!item) {
                                item = document.createElement('div');
                                item.className = 'category-item';
                                categoriesContainer.appendChild(item);
                        }

                        item.className = `category-item ${state.selectedCategory === category ? 'active' : ''}`;
                        item.textContent = category;
                        item.title = category;
                        
                        // 移除旧的事件监听器（防止重复绑定）
                        const newItem = isNew ? item : item.cloneNode(true);
                        
                        if (!isNew) {
                            categoriesContainer.replaceChild(newItem, item);
                            item = newItem;
                        }
                        
                        // 重新绑定点击事件
                        item.onclick = () => {
                            state.selectedCategory = category;
                            state.currentPage = 1;
                            filterBookmarks();
                            renderBookmarks();
                            renderCategories();
                        };
                          
                        // 添加分类拖拽功能
                        item.draggable = true;
                        item.dataset.category = category;

                        existingItems.delete(category); // 已处理，移除标记
                });

                // 移除多余的分类项
                existingItems.forEach(item => item.remove());
        }

        function updateCategoryFilter() {
                const allCategories = new Set(state.bookmarks.map(bookmark => bookmark.category));
                allCategories.add('全部书签');
                state.categories = allCategories;
                renderCategories();
        }

        function filterBookmarks() {
                if (!Array.isArray(state.bookmarks)) {
                        state.bookmarks = [];
                }
                state.filteredBookmarks = state.bookmarks.filter(bookmark => {
                        const matchesCategory = state.selectedCategory === '全部书签' || bookmark.category === state.selectedCategory;
                        // 添加search元素存在性检查
                        const searchElement = document.getElementById('search');
                        const searchTerm = searchElement ? searchElement.value.toLowerCase() : '';
                        const matchesSearch = !searchTerm || bookmark.name.toLowerCase().includes(searchTerm);
                        return matchesCategory && matchesSearch;
                });
                state.currentPage = Math.min(state.currentPage, Math.max(1, Math.ceil(state.filteredBookmarks.length / getItemsPerPage())));
        }

        // 显示搜索模态框
        function showSearchModal() {
                const searchModal = document.getElementById('search-modal');
                if (!searchModal) return;
                
                showModal('search-modal');
                
                // 添加点击外部关闭功能
                const handleOverlayClick = function(e) {
                        // 确保点击的是遮罩层而不是弹窗内容
                        if (e.target.id === 'overlay' || e.target.id === 'search-modal-close') {
                                hideSearchModal();
                                document.removeEventListener('click', handleOverlayClick);
                        }
                };
                
                // 延迟添加事件监听以避免触发关闭
                setTimeout(() => {
        }, 0);
                        document.addEventListener('click', handleOverlayClick);
                
                
                // 获取焦点到搜索框
                setTimeout(() => {
        }, 0);
                        const searchInput = document.getElementById('search-modal-input');
                        if (searchInput) {
                                searchInput.focus();
                                // 清空输入框
                                searchInput.value = '';
                                // 清空搜索结果
                                clearSearchResults();
                        }
                
        }

        // 隐藏搜索模态框
        function hideSearchModal() {
                // 调用通用的隐藏模态框函数，传入搜索模态框ID
                hideModal('search-modal');
                
                // 重置覆盖层的点击事件为隐藏所有模态框
                const overlay = document.getElementById('overlay');
                if (overlay) {
                        overlay.onclick = hideAllModals;
                }
        }

        // 清空搜索结果
        function clearSearchResults() {
                // 获取搜索结果容器和无结果提示元素
                const searchResults = document.getElementById('search-results');
                const noResults = document.getElementById('no-search-results');
                
                // 清空搜索结果容器内容
                if (searchResults) {
                        searchResults.innerHTML = '';
                }
                
                // 隐藏无结果提示
                if (noResults) {
                        noResults.style.display = 'none';
                }
        }

        // 在模态框中执行搜索
        // 生成随机浅色渐变背景的函数
        function generateRandomGradient() {
                // 基于网站主题色的浅色变体
                const colors = [
                        'rgba(0, 123, 255, 0.05), rgba(0, 123, 255, 0.1)', // 蓝色渐变
                        'rgba(40, 167, 69, 0.05), rgba(40, 167, 69, 0.1)',  // 绿色渐变
                        'rgba(108, 117, 125, 0.05), rgba(108, 117, 125, 0.1)', // 灰色渐变
                        'rgba(220, 53, 69, 0.05), rgba(220, 53, 69, 0.1)',  // 红色渐变
                        'rgba(255, 193, 7, 0.05), rgba(255, 193, 7, 0.1)',  // 黄色渐变
                        'rgba(138, 43, 226, 0.05), rgba(138, 43, 226, 0.1)',  // 紫色渐变
                        'rgba(255, 99, 71, 0.05), rgba(255, 99, 71, 0.1)',  // 橙色渐变
                        'rgba(0, 128, 128, 0.05), rgba(0, 128, 128, 0.1)'   // 青色渐变
                ];
                
                // 随机选择一种渐变颜色
                const randomColor = colors[Math.floor(Math.random() * colors.length)];
                
                // 随机决定渐变方向
                const directions = ['to right', 'to left', 'to bottom', 'to top', 'to bottom right', 'to bottom left', 'to top right', 'to top left'];
                const randomDirection = directions[Math.floor(Math.random() * directions.length)];
                
                // 返回完整的渐变背景样式
                return `linear-gradient(${randomDirection}, ${randomColor})`;
        }
        
        // 执行模态框搜索功能
        // 此函数负责处理模态框中的搜索请求，过滤书签并显示搜索结果
        function performModalSearch() {
                // 优化：使用缓存的DOM元素引用，减少重复的DOM查询操作
                if (!searchModalInput) {
                        searchModalInput = document.getElementById('search-modal-input');
                        if (!searchModalInput) return; // 如果搜索框不存在，直接返回
                }
                
                // 获取搜索结果容器、无结果提示和加载指示器元素
                const searchResults = document.getElementById('search-results');
                const noResults = document.getElementById('no-search-results');
                const loadingIndicator = document.getElementById('loading-indicator');
                
                // 检查必要的DOM元素是否存在
                if (!searchResults || !noResults) {
                        return; // 如果关键元素不存在，直接返回
                }
                
                // 显示加载指示器，提升用户体验
                if (loadingIndicator) loadingIndicator.style.display = 'block';
                
                // 获取并处理搜索关键词（去除首尾空格并转为小写）
                const searchTerm = searchModalInput.value.trim().toLowerCase();
                
                // 清空之前的搜索结果
                searchResults.innerHTML = '';
                
                // 如果搜索词为空，隐藏无结果提示并返回
                if (!searchTerm) {
                        noResults.style.display = 'none';
                        return;
                }
                
                // 根据搜索词过滤匹配的书签（只匹配书签名称）
                const matchedBookmarks = state.bookmarks.filter(bookmark => 
                        bookmark.name.toLowerCase().includes(searchTerm)
                );
                
                // 处理搜索结果
                if (matchedBookmarks.length === 0) {
                        // 没有找到匹配结果，显示无结果提示
                        noResults.style.display = 'block';
                } else {
                        // 找到了匹配结果，隐藏无结果提示
                        noResults.style.display = 'none';
                        
                        // 遍历所有匹配的书签，为每个书签创建搜索结果项
                        matchedBookmarks.forEach(bookmark => {
                                // 创建结果项容器
                                const resultItem = document.createElement('div');
                                resultItem.className = 'search-result-item'; // 设置样式类
                                // 应用随机浅色渐变背景
                                resultItem.style.background = generateRandomGradient();
                                
                                // 点击名称查看详情
                                const nameElement = document.createElement('span');
                                nameElement.className = 'search-result-name';
                                nameElement.textContent = bookmark.name;
                                nameElement.onclick = (e) => {
                                        e.stopPropagation(); // 阻止事件冒泡
                                        
                                        // 直接显示书签详情，不修改全局filteredBookmarks
                                        const tempBookmarkIndex = state.bookmarks.findIndex(b => b.url === bookmark.url && b.name === bookmark.name);
                                        if (tempBookmarkIndex !== -1) {
                                                // 临时保存当前过滤器和分类状态
                                                const tempFilter = state.searchFilter;
                                                const tempCategory = state.selectedCategory;
                                                 
                                                // 过滤出当前书签
                                                state.filteredBookmarks = [state.bookmarks[tempBookmarkIndex]];
                                                state.searchFilter = '';
                                                state.selectedCategory = bookmark.category;
                                                 
                                                // 显示详情
                                                showBookmarkDetails(0);
                                                 
                                                // 使用setTimeout在下一个事件循环中恢复原始状态
                                                setTimeout(() => {
                                                        state.searchFilter = tempFilter;
                                                        state.selectedCategory = tempCategory;
                                                        filterBookmarks(); // 重新过滤书签
                                                        renderBookmarks(); // 重新渲染书签列表
                                                }, 0);
                                                
                                        }
                                };
                                
                                // 创建URL链接元素
                                const urlElement = document.createElement('a');
                                urlElement.className = 'search-result-url';
                                urlElement.textContent = bookmark.url || '无链接'; // 显示URL或默认文本
                                urlElement.href = bookmark.url || 'javascript:void(0)'; // 设置链接地址
                                urlElement.target = '_blank'; // 在新标签页中打开链接
                                urlElement.onclick = (e) => {
                                        e.stopPropagation(); // 阻止事件冒泡
                                        if (!bookmark.url) {
                                                e.preventDefault(); // 如果没有URL，则阻止默认行为
                                        }
                                };
                                
                                // 组装搜索结果项
                                resultItem.appendChild(nameElement);
                                resultItem.appendChild(urlElement);
                                searchResults.appendChild(resultItem);
                        });
                }
                
                // 隐藏加载指示器
                if (loadingIndicator) loadingIndicator.style.display = 'none';
        }

        // 优化：全局变量用于缓存常用DOM元素引用
        let searchModalInput = null; // 搜索框元素缓存
        let debouncedSearch = null;  // 防抖处理的搜索函数缓存

        // 页面加载完成后初始化搜索功能
        document.addEventListener('DOMContentLoaded', function() {
                // 获取搜索框元素
                searchModalInput = document.getElementById('search-modal-input');
                if (searchModalInput) {
                        // 创建一个防抖版本的搜索函数（延迟300毫秒执行）
                        // 防抖可以避免用户频繁输入时重复执行搜索，提高性能
                        debouncedSearch = debounce(performModalSearch, 300);
                        
                        // 为搜索框添加输入事件监听，实现实时搜索功能
                        searchModalInput.addEventListener('input', debouncedSearch);
                        
                        // 添加回车键搜索功能（兼容用户的使用习惯）
                        searchModalInput.addEventListener('keypress', function(e) {
                                if (e.key === 'Enter') {
                                        performModalSearch(); // 直接执行搜索，不使用防抖
                                }
                        });
                }
        });

        // 保留原来的搜索功能，但不再在主界面显示搜索框
        function searchBookmarks() {
                state.currentPage = 1;
                filterBookmarks();
                renderBookmarks();
        }

        function getItemsPerPage() {
                return 24;
        }

        function renderPagination() {
                const pagination = document.getElementById('pagination');
                const itemsPerPage = getItemsPerPage();
                const totalPages = Math.ceil(state.filteredBookmarks.length / itemsPerPage);
                const total = state.bookmarks.length;
                const displayed = Math.min(state.filteredBookmarks.length - (state.currentPage - 1) * itemsPerPage);
                pagination.innerHTML = '';

                if (total <= 12 && displayed <= 12) {
                        pagination.style.display = 'none';
                        return;
                }

                pagination.style.display = 'flex';

                const prevBtn = document.createElement('button');
                prevBtn.textContent = '上一页';
                prevBtn.disabled = state.currentPage === 1;
                prevBtn.onclick = () => {
                        if (state.currentPage > 1) {
                                state.currentPage--;
                                renderBookmarks();
                        }
                };
                pagination.appendChild(prevBtn);

                const maxVisiblePages = 5;
                let startPage = Math.max(1, state.currentPage - Math.floor(maxVisiblePages / 2));
                let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
                startPage = Math.max(1, endPage - maxVisiblePages + 1);

                for (let i = startPage; i <= endPage; i++) {
                        const btn = document.createElement('button');
                        btn.textContent = i;
                        btn.className = state.currentPage === i ? 'active' : '';
                        btn.onclick = () => {
                                state.currentPage = i;
                                renderBookmarks();
                        };
                        pagination.appendChild(btn);
                }

                const nextBtn = document.createElement('button');
                nextBtn.textContent = '下一页';
                nextBtn.disabled = state.currentPage === totalPages;
                nextBtn.onclick = () => {
                        if (state.currentPage < totalPages) {
                                state.currentPage++;
                                renderBookmarks();
                        }
                };
                pagination.appendChild(nextBtn);
        }

        function updateStats() {
                const stats = document.getElementById('stats');
                const total = state.bookmarks.length;
                const categoriesCount = state.categories.size - 1;
                const displayed = Math.min(state.filteredBookmarks.length - (state.currentPage - 1) * getItemsPerPage(), state.filteredBookmarks.length);
                const currentCategoryCount = state.selectedCategory === '全部书签' 
                        ? total 
                        : state.bookmarks.filter(b => b.category === state.selectedCategory).length;

                if (total > 12 || displayed > 12) {
                        stats.style.display = 'block';
                        stats.textContent = `总书签数：${total} | 总分组数：${categoriesCount} | 当前页显示书签卡片数：${displayed} | 当前分组书签数：${currentCategoryCount} | `;
                } else {
                        stats.style.display = 'none';
                }
        }

        function addBookmark(name, url, category, desc) {
                const newBookmark = {
                        name: name.trim(),
                        url: url.trim(),
                        category: category.trim() || '默认分组',
                        desc: desc.trim(),
                        background: getRandomGradient(),
                        added: Date.now()
                };
                state.bookmarks.push(newBookmark);
                state.categories.add(newBookmark.category);
                state.categories.add('全部书签');
                saveToLocalStorageImmediately();
                filterBookmarks();
                renderBookmarks();
                updateCategoryFilter();
        }

        function renderBookmarks() {
                if (state.isRendering || state.isImporting) return;
                state.isRendering = true;

                const loadingIndicator = document.getElementById('loading-indicator');
                if (loadingIndicator) loadingIndicator.style.display = 'block';

                try {
                        const container = document.getElementById('bookmarks');
                        const tips = document.getElementById('tips');
                        if (!container || !tips) {
                                console.error('Container or tips element not found');
                                state.isRendering = false;
                                if (loadingIndicator) loadingIndicator.style.display = 'none';
                                return;
                        }

                        const itemsPerPage = getItemsPerPage();
                        const startIndex = (state.currentPage - 1) * itemsPerPage;
                        const endIndex = Math.min(startIndex + itemsPerPage, state.filteredBookmarks.length);
                        const visibleBookmarks = state.filteredBookmarks.slice(startIndex, endIndex);
                        const isOnline = navigator.onLine;

                        // 检查当前是否显示空状态
                        const isEmptyState = container.classList.contains('empty-state');

                        if (state.filteredBookmarks.length === 0) {
                                container.className = 'empty-state';
                                container.innerHTML = `
                                        <div class="ribbons">
                                                <div class="ribbon"></div>
                                                <div class="ribbon"></div>
                                                <div class="ribbon"></div>
                                        </div>
                                        <div class="cartoon-book">
                                                <div class="book-spine"></div>
                                                <div class="book-cover"></div>
                                                <div class="book-page"></div>
                                                <div class="bookmark"></div>
                                        </div>
                                        <h2>欢迎使用书签管理器</h2>
                                        <p>目前还没有书签，快来添加你的第一个书签吧！或者导入已有书签，快速开始管理。</p>
                                        <div class="button-group">
                                                <button class="action-btn" onclick="toggleAddForm(true)">➕ 添加书签</button>
                                                <button class="action-btn secondary-btn" onclick="document.getElementById('import-file').click()">📥 导入书签</button>
                                        </div>
                                `;
                                tips.style.display = 'none';
                                document.getElementById('pagination').style.display = 'none';
                                document.getElementById('stats').style.display = 'none';
                        } else {
                                // 如果之前是空状态，清除内容并切换到书签卡片模式
                                if (isEmptyState) {
                                        container.innerHTML = ''; // 清除空状态内容
                                }
                                container.className = 'bookmark-grid';
                                tips.style.display = 'block';

                                // 获取现有卡片
                                const existingCards = new Map();
                                container.querySelectorAll('.bookmark-card').forEach(card => {
                                        const index = parseInt(card.dataset.index);
                                        if (!isNaN(index)) existingCards.set(index, card);
                                });

                                // 更新或创建卡片
                                visibleBookmarks.forEach((bookmark, index) => {
                                        // 用当前页索引作为data-index，保证拖拽和DOM顺序一致
                                        let card = existingCards.get(index);
                                        const isNew = !card;

                                        if (!card) {
                                                card = document.createElement('div');
                                                card.className = `bookmark-card${state.isEditMode ? ' edit-mode' : ''}`;
                                                card.draggable = !state.isEditMode;
                                                container.appendChild(card);
                                        } else {
                                                card.className = `bookmark-card${state.isEditMode ? ' edit-mode' : ''}`;
                                                card.draggable = !state.isEditMode;
                                                existingCards.delete(index);
                                        }

                                        card.dataset.index = index;
                                        card.style.background = bookmark.background || getRandomGradient();

                                        const displayName = bookmark.name.length > 10 ? bookmark.name.substring(0, 10) + '...' : bookmark.name;
                                        const displayCategory = bookmark.category.length > 10 ? bookmark.category.substring(0, 10) + '...' : bookmark.category;
                                        const bookmarkGlobalIndex = state.bookmarks.indexOf(bookmark);

                                        // 进一步优化的 favicon 加载逻辑，减少控制台错误
                                        let faviconHtml = '';
                                        if (isOnline && bookmark.url) {
                                                try {
                                                        const urlObj = new URL(bookmark.url);
                                                        const faviconUrl = `${urlObj.origin}/favicon.ico`;
                                                        // 使用简单的占位符，避免直接创建可能失败的img元素
                                                        // 仅在实际需要显示时通过JS加载，减少不必要的网络请求
                                                        faviconHtml = `<span class="favicon-placeholder" data-favicon-url="${faviconUrl}"></span>`;
                                                } catch (e) {
                                                        // 捕获URL解析错误，避免控制台报错
                                                        faviconHtml = '';
                                                }
                                        }

                                        const backContent = bookmark.desc
                                                ? `<span class="desc-title">书签简介</span><p class="desc">${escapeHtml(bookmark.desc)}</p>`
                                                : `<span class="no-desc">此书签暂无简介</span>`;

                                        // 检查内容是否需要更新
                                        const newInnerHTML = `
                                                <div class="main-card-container">
                                                        <div class="main-card">
                                                                <div class="main-card-front">
                                                                        <div class="bookmark-content">
                                                                                <h3>
                                                                                        <span class="favicon-container">${faviconHtml}</span>
                                                                                        <span class="title-text" data-index="${index}">${escapeHtml(displayName)}</span>
                                                                                        <input type="checkbox" class="bookmark-checkbox${state.isEditMode ? ' visible' : ''}" data-global-index="${bookmarkGlobalIndex}">
                                                                                </h3>
                                                                                <p class="url"><a href="${escapeHtml(bookmark.url)}" target="_blank">${escapeHtml(bookmark.url)}</a></p>
                                                                                <div class="desc-container">
                                                                                        <p class="desc">${escapeHtml(bookmark.desc)}</p>
                                                                                </div>
                                                                        </div>
                                                                        <div class="action-bar">
                                                                                <span class="category-tag">${escapeHtml(displayCategory)}</span>
                                                                                <div class="action-buttons" style="${state.isEditMode ? 'display: flex;' : 'display: none;'}">
                                                                                        <button class="edit-btn" data-index="${index}">✏️ 编辑</button>
                                                                                        <button class="delete-btn" data-index="${index}">🗑️ 删除</button>
                                                                                </div>
                                                                        </div>
                                                                </div>
                                                                <div class="main-card-back">
                                                                        ${backContent}
                                                                </div>
                                                        </div>
                                                        <div class="hover-area"></div>
                                                </div>
                                        `;

                                        if (card.innerHTML !== newInnerHTML) {
                                                card.innerHTML = newInnerHTML;
                                        }

                                        // 更新分类标签颜色
                                        const categoryTag = card.querySelector('.category-tag');
                                        if (categoryTag) {
                                                categoryTag.style.backgroundColor = getCategoryColor(bookmark.category);
                                        }
                                });

                                // 移除多余的卡片
                                existingCards.forEach(card => card.remove());

                                // 事件委托（仅绑定一次）
                                if (!container.clickHandler) {
                                        container.clickHandler = (e) => {
                                                const target = e.target;
                                                if (target.classList.contains('title-text')) {
                                                        showBookmarkDetails(parseInt(target.dataset.index));
                                                } else if (target.classList.contains('edit-btn')) {
                                                        editBookmark(parseInt(target.dataset.index));
                                                } else if (target.classList.contains('delete-btn')) {
                                                        deleteBookmark(parseInt(target.dataset.index));
                                                } else if (state.isEditMode && target.closest('.bookmark-card')) {
                                                        const checkbox = target.closest('.bookmark-card').querySelector('.bookmark-checkbox');
                                                        if (checkbox && !target.closest('.action-buttons') && !target.classList.contains('bookmark-checkbox')) {
                                                                checkbox.checked = !checkbox.checked;
                                                                toggleBookmarkSelection(parseInt(checkbox.dataset.globalIndex), checkbox.checked);
                                                        }
                                                }
                                        };
                                        container.mouseEnterHandler = (e) => {
                                                if (!state.isEditMode && e.target.classList.contains('hover-area')) {
                                                        const mainCard = e.target.previousElementSibling;
                                                        if (mainCard) mainCard.classList.add('flipped');
                                                }
                                        };
                                        container.mouseLeaveHandler = (e) => {
                                                if (!state.isEditMode && e.target.closest('.bookmark-card')) {
                                                        const card = e.target.closest('.bookmark-card');
                                                        const mainCard = card.querySelector('.main-card');
                                                        if (mainCard && !card.contains(e.relatedTarget)) {
                                                                mainCard.classList.remove('flipped');
                                                        }
                                                }
                                        };
                                        container.addEventListener('click', container.clickHandler);
                                        container.addEventListener('mouseenter', container.mouseEnterHandler, true);
                                        container.addEventListener('mouseleave', container.mouseLeaveHandler, true);
                                }

                                renderPagination();
                                updateStats();
                        }
                } catch (e) {
                        console.error('渲染书签失败：', e);
                } finally {
                        state.isRendering = false;
                        if (loadingIndicator) loadingIndicator.style.display = 'none';
                }
        }

        // 移除日志功能，优化性能
        
        // 侧边栏分类拖拽排序功能
        function setupCategoryDragAndDrop() {
                let draggedCategory = null;
                
                
                
                // 为分类项添加拖拽相关事件
                function addDragEventsToCategoryItems() {
                        const categoryItems = document.querySelectorAll('.category-item');
                        
                        categoryItems.forEach(item => {
                                const categoryName = item.dataset.category || item.textContent;
                                
                                // 不允许拖拽"全部书签"分类
                                const isAllBookmarks = categoryName === '全部书签';
                                if (isAllBookmarks) {
                                        item.draggable = false;
                                        item.style.cursor = 'default';
                                } else {
                                        // 确保其他分类项始终可拖拽
                                        item.draggable = true;
                                        item.style.cursor = 'grab'; // 使用拖拽光标
                                }
                                
                                // 确保有data-category属性
                                if (!item.dataset.category) {
                                        item.dataset.category = categoryName;
                                }

                                // 保留原来的点击事件处理函数引用
                                const originalClickHandler = item.onclick;

                                // 防止重复添加事件监听器，先移除所有已存在的拖拽事件
                                const newItem = item.cloneNode(true);
                                item.parentNode.replaceChild(newItem, item);

                                // 增强的点击事件处理
                                newItem.onclick = function(e) {
                                    // 执行原始点击逻辑
                                    if (originalClickHandler && typeof originalClickHandler === 'function') {
                                        originalClickHandler.apply(this, arguments);
                                    }
                                    
                                    // 确保即使点击了"全部书签"，其他分类项的拖拽功能仍然可用
                                    // 延迟重新绑定拖拽事件，确保DOM更新完成
                                    setTimeout(() => {
                                        addDragEventsToCategoryItems();
                                    }, 0);
                                    
                                };
                                
                                // 添加拖拽开始事件
                                newItem.addEventListener('dragstart', function(e) {
                                        draggedCategory = this;
                                        
                                        // 设置拖拽数据
                                        e.dataTransfer.effectAllowed = 'move';
                                        
                                        // 添加拖拽样式
                                        setTimeout(() => {
                                                this.classList.add('dragging');
                                                this.style.opacity = '0.6';
                                        }, 0);
                                        
                                    })
                                
                                // 添加拖拽结束事件
                                newItem.addEventListener('dragend', function() {
                                        // 清理拖拽状态
                                        this.classList.remove('dragging');
                                        this.style.opacity = '1';
                                        
                                        // 清理所有放置目标样式
                                        document.querySelectorAll('.category-item.drop-target').forEach(el => {
                                                el.classList.remove('drop-target');
                                        });
                                        
                                        draggedCategory = null;
                                        

                                });
                                
                                // 添加拖拽经过事件 - 优化版本
                                newItem.addEventListener('dragover', function(e) {
                                        e.preventDefault();
                                        e.dataTransfer.dropEffect = 'move';
                                        
                                        // 不允许拖拽到自身
                                        if (this === draggedCategory) {
                                                this.classList.remove('drop-target', 'drop-target-before', 'drop-target-after');
                                                return;
                                        }
                                        
                                        // 获取鼠标在元素中的位置，决定是上边框还是下边框高亮
                                        const rect = this.getBoundingClientRect();
                                        const mouseY = e.clientY - rect.top;
                                        const elementHeight = rect.height;
                                        
                                        // 移除所有放置目标样式
                                        document.querySelectorAll('.category-item.drop-target, .category-item.drop-target-before, .category-item.drop-target-after').forEach(el => {
                                                if (el !== this && el !== draggedCategory) {
                                                        el.classList.remove('drop-target', 'drop-target-before', 'drop-target-after');
                                                }
                                        });
                                        
                                        // 极致简化判定条件，只要鼠标进入就显示边框
                                        this.classList.remove('drop-target', 'drop-target-before', 'drop-target-after');
                                        
                                        // 无条件显示所有提示样式，确保边框总是可见
                                        this.classList.add('drop-target', 'drop-target-before', 'drop-target-after');
                                        
                                        // 保存当前鼠标位置信息，用于放置时的位置判断
                                        this.dataset.mouseY = mouseY;
                                        this.dataset.elementHeight = elementHeight;
                                        
                                        // 确保样式立即生效
                                        this.style.transition = 'none';
                                        this.offsetHeight; // 强制重绘
                                        setTimeout(() => {
                                            this.style.transition = '';
                                        }, 0);
                                    });
                                
                                // 添加拖拽离开事件 - 优化版本
                                newItem.addEventListener('dragleave', function() {
                                        // 快速移除高亮，不再延迟
                                        this.classList.remove('drop-target', 'drop-target-before', 'drop-target-after');
                                });
                                
                                // 添加放置事件 - 优化版本
                                newItem.addEventListener('drop', function(e) {
                                        e.preventDefault();
                                        
                                        // 确保有拖拽元素且不是拖拽到自身
                                        if (!draggedCategory || draggedCategory === this) {
                                                this.classList.remove('drop-target', 'drop-target-before', 'drop-target-after');
                                                return;
                                        }
                                        
                                        const fromCategory = draggedCategory.dataset.category;
                                        const toCategory = this.dataset.category;
                                        
                                        // 移除所有放置目标样式
                                        document.querySelectorAll('.category-item.drop-target, .category-item.drop-target-before, .category-item.drop-target-after').forEach(el => {
                                                el.classList.remove('drop-target', 'drop-target-before', 'drop-target-after');
                                        });
                                        
                                        try {
                                                // 获取所有用户自定义分类
                                                const userCategories = Array.from(state.categories).filter(cat => cat !== '全部书签');
                                                
                                                // 找到要移动的索引
                                                const fromIndex = userCategories.indexOf(fromCategory);
                                                const toIndex = userCategories.indexOf(toCategory);
                                                
                                                if (fromIndex !== -1 && toIndex !== -1 && fromIndex !== toIndex) {
                                                        // 最简化的位置判断逻辑，确保只要显示边框就能交换
                                                        let insertPosition = toIndex;
                                                          
                                                        // 默认放在目标分类的后面，简化逻辑
                                                        insertPosition = toIndex + 1;
                                                          
                                                        // 边界检查，确保索引有效
                                                        if (insertPosition > userCategories.length) {
                                                                insertPosition = userCategories.length;
                                                        }
                                                        if (insertPosition < 0) {
                                                                insertPosition = 0;
                                                        }
                                                        

                                                        
                                                        // 移除原位置的分类
                                                        const movedCategory = userCategories.splice(fromIndex, 1)[0];
                                                        
                                                        // 计算新位置 (如果插入位置在原索引之后，需要减1，因为我们已经移除了一个元素)
                                                        const newIndex = insertPosition > fromIndex ? insertPosition - 1 : insertPosition;
                                                        
                                                        // 在新位置插入分类
                                                        userCategories.splice(newIndex, 0, movedCategory);
                                                        
                                                        // 更新状态
                                                        state.categories = new Set(['全部书签', ...userCategories]);
                                                        
                                                        // 参考书签卡片交换方式，使用占位符保持其他分类项位置不变
                                                        const fromElement = document.querySelector(`.category-item[data-category="${fromCategory}"]`);
                                                        const toElement = this;
                                                        
                                                        if (fromElement && toElement) {
                                                            // 获取容器
                                                            const container = toElement.parentElement;
                                                             
                                                            // 使用通用的DOM节点交换函数
                                                            swapDOMNodes(container, fromElement, toElement);
                                                                 
                                                            // 添加简单的动画效果
                                                            function animateElements() {
                                                                // 保存原始背景色
                                                                const originalFromBg = fromElement.style.backgroundColor || '';
                                                                const originalToBg = toElement.style.backgroundColor || '';
                                                                 
                                                                // 确保过渡效果平滑
                                                                fromElement.style.transition = 'background-color 0.4s cubic-bezier(0.25, 0.1, 0.25, 1)';
                                                                toElement.style.transition = 'background-color 0.4s cubic-bezier(0.25, 0.1, 0.25, 1)';
                                                                 
                                                                // 生成随机浅色作为高亮色
                                                                const randomColor = getRandomLightColor();
                                                                 
                                                                // 设置随机浅色背景高亮
                                                                fromElement.style.backgroundColor = randomColor;
                                                                toElement.style.backgroundColor = randomColor;
                                                                 
                                                                // 动画完成后恢复原来的背景色
                                                                setTimeout(() => {
                                                                    fromElement.style.backgroundColor = originalFromBg;
                                                                    toElement.style.backgroundColor = originalToBg;
                                                                     
                                                                    // 延迟移除过渡效果以确保动画完全完成
                                                                    setTimeout(() => {
                                                                        fromElement.style.transition = '';
                                                                        toElement.style.transition = '';
                                                                    }, 0);
                                                                }, 300);
                                                            }
                                                             
                                                            // 执行动画
                                                            animateElements();
                                                        }
                                                          

                                                         
                                                        // 保存更改
                                                        saveToLocalStorageImmediately();
                                                         
                                                        // 不需要重新渲染分类，因为我们已经通过DOM操作更新了位置
                                                        // renderCategoriesDirect();
                                                } else {
                                                        // 索引无效，静默处理
                                                }
                                        } catch (error) {
                                                console.error('分类拖拽移动失败: ' + error.message);
                                        }
                                });
                        });
                }
                
                // 初始调用一次
                addDragEventsToCategoryItems();
        }
                
        // 直接渲染分类的函数，优化版本 - 只更新内容不重建DOM
        function renderCategoriesDirect() {
                        const categoriesContainer = document.getElementById('categories');
                        const allCategories = Array.from(state.categories);
                         
                        // 不直接清空容器，而是更新现有元素内容和顺序
                        const existingItems = Array.from(categoriesContainer.querySelectorAll('.category-item'));
                         
                        if (existingItems.length === allCategories.length) {
                            // 如果数量相同，只需更新内容和顺序
                            allCategories.forEach((category, index) => {
                                // 找到对应的数据项
                                const item = existingItems.find(el => el.dataset.category === category) || existingItems[index];
                                
                                // 更新内容和状态
                                item.textContent = category;
                                item.title = category;
                                item.dataset.category = category;
                                
                                // 更新激活状态
                                if (state.selectedCategory === category) {
                                    item.classList.add('active');
                                } else {
                                    item.classList.remove('active');
                                }
                                 
                                // 确保正确的顺序
                                if (index < categoriesContainer.children.length - 1) {
                                    categoriesContainer.insertBefore(item, categoriesContainer.children[index + 1]);
                                }
                            });
                        } else {
                            // 如果数量不同，才清空并重建（这种情况应该很少发生）
                            categoriesContainer.innerHTML = '';
                             
                            // 重新创建所有分类项
                            allCategories.forEach(category => {
                                const item = document.createElement('div');
                                item.className = `category-item ${state.selectedCategory === category ? 'active' : ''}`;
                                item.textContent = category;
                                item.title = category;
                                item.dataset.category = category;
                                 
                                // 添加点击事件
                                item.onclick = () => {
                                    state.selectedCategory = category;
                                    state.currentPage = 1;
                                    filterBookmarks();
                                    renderBookmarks();
                                    renderCategoriesDirect(); // 使用直接渲染函数，保持拖拽排序
                                };
                                 
                                categoriesContainer.appendChild(item);
                            });
                        }
                         
                        // 重新添加拖拽事件
                        setTimeout(addDragEventsToCategoryItems, 0);
                }
                
                // 初始调用一次
        // 使用setupCategoryDragAndDrop而不是直接调用addDragEventsToCategoryItems
        setupCategoryDragAndDrop();

// 书签卡片拖拽排序功能
function setupDragAndDrop() {
    let draggedCard = null;
    let draggedIndex = null;
    let lastDropTarget = null;
    let bookmarksContainer = null;

    // 初始化容器引用
    function getBookmarksContainer() {
        if (!bookmarksContainer) {
            bookmarksContainer = document.getElementById('bookmarks');
        }
        return bookmarksContainer;
    }

    // 防抖处理dragover事件
    let debounceTimer;
    function handleDragOver(e) {
        e.preventDefault();
        if (!draggedCard) return;

        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(function() {
            // 快速检测鼠标下的卡片，提高灵敏度
            let dropTarget = e.target.closest('.bookmark-card:not(.dragging)');
            
            // 增强拖拽灵敏度，扩大检测范围
            if (!dropTarget && e.clientY) {
                const cards = Array.from(getBookmarksContainer().querySelectorAll('.bookmark-card:not(.dragging)'));
                for (const card of cards) {
                    const rect = card.getBoundingClientRect();
                                    // 扩大垂直和水平检测范围，提高灵敏度
                                    if (e.clientY >= rect.top - 20 && e.clientY <= rect.bottom + 20 &&
                                        e.clientX >= rect.left - 10 && e.clientX <= rect.right + 10) {
                                        dropTarget = card;
                                        break;
                                    }
                }
            }
            
            // 移除上一个目标的高亮
            if (lastDropTarget && lastDropTarget !== dropTarget) {
                lastDropTarget.classList.remove('drop-target');
            }
            
            // 添加新目标的高亮
            if (dropTarget && dropTarget !== draggedCard) {
                dropTarget.classList.add('drop-target');
                lastDropTarget = dropTarget;
            }
        }, 0); // 更低的防抖延迟，大幅提高响应速度
    }

    document.addEventListener('dragstart', function(e) {
        // 只有在非编辑模式下才能拖拽，且确保目标是书签卡片
        if (state.isEditMode || !e.target.classList.contains('bookmark-card')) return;
        
        draggedCard = e.target;
        draggedIndex = parseInt(draggedCard.dataset.index);
        
        // 确保索引有效
        if (isNaN(draggedIndex) || draggedIndex < 0) {
            console.warn('无效的书签索引:', draggedIndex);
            return;
        }
        
        draggedCard.classList.add('dragging');
        // 使用setTimeout确保样式立即生效
        setTimeout(function() { draggedCard.style.opacity = '0.6'; }, 0);
    });

    document.addEventListener('dragend', function() {
        if (!draggedCard) return;
        
        // 清理拖拽状态
        draggedCard.classList.remove('dragging');
        draggedCard.style.opacity = '1';
        
        // 清理放置目标状态
        if (lastDropTarget) {
            lastDropTarget.classList.remove('drop-target');
            lastDropTarget = null;
        }
        
        // 重置状态
        draggedCard = null;
        draggedIndex = null;
        
        // 保存更改
        saveToLocalStorageImmediately();
    });

    document.addEventListener('dragover', handleDragOver);

    document.addEventListener('drop', function(e) {
        e.preventDefault();
        if (!draggedCard) return;
        
        // 清除防抖计时器
        clearTimeout(debounceTimer);
        
        // 获取放置目标
        const dropTarget = e.target.closest('.bookmark-card:not(.dragging)');
        
        // 清理放置目标高亮
        if (lastDropTarget) {
            lastDropTarget.classList.remove('drop-target');
            lastDropTarget = null;
        }
        
        // 如果有有效目标且不是拖拽源本身
        if (dropTarget && dropTarget !== draggedCard) {
            try {
                // 获取索引
                const fromIndex = parseInt(draggedCard.dataset.index);
                const toIndex = parseInt(dropTarget.dataset.index);
                
                // 验证索引有效性
                if (isNaN(fromIndex) || isNaN(toIndex) || fromIndex < 0 || toIndex < 0) {
                    console.warn('无效的索引值:', {fromIndex, toIndex});
                    return;
                }
                
                // 确保索引在范围内且不相同
                if (fromIndex !== toIndex && fromIndex < state.filteredBookmarks.length && toIndex < state.filteredBookmarks.length) {
                    // 获取卡片元素
                    const fromCard = draggedCard;
                    const toCard = dropTarget;
                    
                    // 获取卡片位置信息
                    const fromRect = fromCard.getBoundingClientRect();
                    const toRect = toCard.getBoundingClientRect();
                    
                    // 设置动画 - 只交换两个卡片的位置
                    fromCard.style.transition = 'transform 0.35s ease';
                    toCard.style.transition = 'transform 0.35s ease';
                    
                    // 计算位置偏移，使两个卡片交换位置
                    const dx = toRect.left - fromRect.left;
                    const dy = toRect.top - fromRect.top;
                    const dx2 = fromRect.left - toRect.left;
                    const dy2 = fromRect.top - toRect.top;
                    
                    fromCard.style.transform = 'translate(' + dx + 'px,' + dy + 'px)';
                    toCard.style.transform = 'translate(' + dx2 + 'px,' + dy2 + 'px)';
                    
                    // 动画完成后处理数据和DOM
                    setTimeout(function() {
                        // 重置样式
                        fromCard.style.transition = '';
                        toCard.style.transition = '';
                        fromCard.style.transform = '';
                        toCard.style.transform = '';
                        
                        // 交换过滤后的数据
                        const temp = state.filteredBookmarks[fromIndex];
                        state.filteredBookmarks[fromIndex] = state.filteredBookmarks[toIndex];
                        state.filteredBookmarks[toIndex] = temp;
                        
                        // 同步全局bookmarks顺序 - 使用更可靠的匹配方式
                        try {
                            // 创建一个更可靠的书签匹配函数，使用所有属性进行比较
                            const findGlobalIndex = function(bookmarkToFind) {
                                // 先尝试使用引用相等查找
                                const directIndex = state.bookmarks.indexOf(bookmarkToFind);
                                if (directIndex !== -1) return directIndex;
                                  
                                // 如果引用查找失败，使用属性匹配查找（作为备用方案）
                                return state.bookmarks.findIndex(function(b) {
                                    return b.name === bookmarkToFind.name &&
                                           b.url === bookmarkToFind.url &&
                                           b.desc === bookmarkToFind.desc &&
                                           b.category === bookmarkToFind.category &&
                                           b.added === bookmarkToFind.added;
                                });
                            };
                            
                            // 查找全局索引
                            const globalFrom = findGlobalIndex(temp);
                            const globalTo = findGlobalIndex(state.filteredBookmarks[fromIndex]);
                            
                            // 确保找到有效的全局索引
                            if (globalFrom !== -1 && globalTo !== -1 && globalFrom !== globalTo) {
                                const temp2 = state.bookmarks[globalFrom];
                                state.bookmarks[globalFrom] = state.bookmarks[globalTo];
                                state.bookmarks[globalTo] = temp2;
                            } else {
                                console.warn('未能同步全局书签顺序', {globalFrom, globalTo});
                            }
                        } catch (syncError) {
                            console.error('同步全局书签顺序时出错:', syncError);
                        }
                        
                        // 保存到本地存储
                        saveToLocalStorageImmediately();
                        
                        // 交换DOM节点 - 只交换两个卡片位置，其他卡片位置不变
                        const container = getBookmarksContainer();
                        if (container && fromCard !== toCard) {
                            // 使用通用的DOM节点交换函数
                            if (swapDOMNodes(container, fromCard, toCard)) {
                                // 更新卡片的索引数据属性
                                fromCard.dataset.index = toIndex;
                                toCard.dataset.index = fromIndex;
                            }
                        }
                    }, 350); // 与动画持续时间匹配
                }
                    // 拖放操作完成
                } catch (dropError) {
                    console.error('拖放操作时出错:', dropError);
                }
            }
        });
    
    // 闭合setupDragAndDrop函数
    return true;
}

        document.addEventListener('DOMContentLoaded', function() {
                // 搜索框功能已在上方统一实现
                // 主要初始化逻辑
                // 留言板弹窗在HTML中已设置display: none，默认隐藏
                setupDragAndDrop();
                loadBookmarks();
                
                // 等数据加载并渲染完成后，再设置分类拖拽功能
                // 使用setTimeout确保loadBookmarks内部的渲染完成
                setTimeout(() => {
                    setupCategoryDragAndDrop();
                }, 0);
                
                
                // 处理favicon占位符，实现延迟加载
                setupFaviconLazyLoading();
        });
        
// 延迟加载favicon，减少不必要的网络请求和控制台错误
        function setupFaviconLazyLoading() {
                // 创建IntersectionObserver实例
                const observer = new IntersectionObserver((entries) => {
                        entries.forEach(entry => {
                                if (entry.isIntersecting) {
                                        const placeholder = entry.target;
                                        const faviconUrl = placeholder.dataset.faviconUrl;
                                        
                                        // 只在元素可见时尝试加载favicon
                                        loadFaviconWithTimeout(faviconUrl, placeholder);
                                        
                                        // 停止观察该元素
                                        observer.unobserve(placeholder);
                                }
                        });
                }, {
                        rootMargin: '100px', // 提前100px触发加载
                        threshold: 0.1      // 当10%的元素可见时触发
                });
                
                // 观察所有favicon占位符
                document.querySelectorAll('.favicon-placeholder').forEach(placeholder => {
                        observer.observe(placeholder);
                });
        }
        
        // 生成随机浅色的函数 - 移到全局作用域，便于多处使用
        function getRandomLightColor() {
                // 生成随机色相 (0-360)
                const hue = Math.floor(Math.random() * 360);
                // 调整饱和度和亮度，使颜色稍深但不遮挡文字
                const saturation = Math.floor(Math.random() * 30) + 20; // 20-50%
                const lightness = Math.floor(Math.random() * 20) + 70; // 70-90%
                 
                return `hsl(${hue}, ${saturation}%, ${lightness}%)`;
        }
        
        // 带超时处理的favicon加载函数 - 优化版
        function loadFaviconWithTimeout(faviconUrl, placeholder) {
                // 创建新的img元素
                const img = new Image();
                img.className = 'favicon';
                img.style.display = 'none'; // 初始隐藏
                
                // 设置超时处理
                const timeoutId = setTimeout(() => {
                        // 超时后不再尝试加载
                        img.onerror = null;
                        img.onload = null;
                        placeholder.style.display = 'none'; // 隐藏占位符
                }, 2000); // 2秒超时
                
                 // 2秒超时
                img.onload = function() {
                        clearTimeout(timeoutId); // 清除超时
                        img.style.display = 'inline'; // 显示图片
                        placeholder.parentNode.replaceChild(img, placeholder); // 替换占位符
                };
                
                // 加载失败处理
                img.onerror = function() {
                        clearTimeout(timeoutId); // 清除超时
                        placeholder.style.display = 'none'; // 隐藏占位符
                };
                
                // 设置src开始加载
                img.src = faviconUrl;
        }
        
        // 通用的交换DOM节点函数
        function swapDOMNodes(container, fromNode, toNode) {
                if (!container || !fromNode || !toNode || fromNode === toNode) {
                        return false;
                }
                
                try {
                        // 为两个节点创建临时占位符
                        const fromPlaceholder = document.createElement('div');
                        fromPlaceholder.style.height = fromNode.offsetHeight + 'px';
                        
                        const toPlaceholder = document.createElement('div');
                        toPlaceholder.style.height = toNode.offsetHeight + 'px';
                        
                        // 插入占位符以保持其他节点位置不变
                        container.insertBefore(fromPlaceholder, fromNode);
                        container.insertBefore(toPlaceholder, toNode);
                        
                        // 移除原始节点
                        container.removeChild(fromNode);
                        container.removeChild(toNode);
                        
                        // 插入到对方位置
                        container.insertBefore(fromNode, toPlaceholder);
                        container.insertBefore(toNode, fromPlaceholder);
                        
                        // 移除占位符
                        container.removeChild(fromPlaceholder);
                        container.removeChild(toPlaceholder);
                        
                        return true;
                } catch (domError) {
                        console.error('交换DOM节点时出错:', domError);
                        return false;
                }
        }


        
        // 显示Toast提示
        function showToast(message) {
                // 检查是否已存在toast元素
                let toast = document.getElementById('toast-notification');
                
                // 如果不存在，创建toast元素
                if (!toast) {
                        toast = document.createElement('div');
                        toast.id = 'toast-notification';
                        toast.style.position = 'fixed';
                        toast.style.bottom = '20px';
                        toast.style.right = '20px';
                        toast.style.backgroundColor = 'rgba(0, 0, 0, 0.8)';
                        toast.style.color = 'white';
                        toast.style.padding = '10px 15px';
                        toast.style.borderRadius = '5px';
                        toast.style.zIndex = '9999';
                        toast.style.opacity = '0';
                        toast.style.transition = 'opacity 0.3s ease';
                        document.body.appendChild(toast);
                }
                
                // 设置消息并显示
                toast.textContent = message;
                toast.style.opacity = '1';
                
                // 3秒后隐藏
                setTimeout(() => {
                        toast.style.opacity = '0';
                }, 3000);
                
        }
        
        // 键盘事件处理
        document.addEventListener('keydown', (e) => {
                if (!e) return;
                
                if (e.key === 'Escape') {
                        hideAllModals();
                } else if (e.ctrlKey && e.key === 's') {
                        e.preventDefault();
                        toggleAddForm(true);
                } else if (e.key === 'Enter') {
                        const addForm = document.getElementById('add-form');
                        if (addForm && addForm.style.display === 'block') {
                                saveBookmark();
                        }
                }
        });

        window.addEventListener('resize', debounce(() => {
                renderBookmarks();
        }, 300));
</script>
<script src="test-welcome-modal-removal.js"></script>
</body>
</html>